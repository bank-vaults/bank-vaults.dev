<!doctype html><html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name="generator" content="Hugo 0.110.0">
<link rel="canonical" type="text/html" href="https://bank-vaults.dev/docs/">
<link rel="alternate" type="text/releases" href="https://bank-vaults.dev/docs/releases.releases">
<meta name="robots" content="noindex, nofollow">
<link rel="shortcut icon" href="/favicons/favicon.ico">
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">
<title>Documentation | Bank-Vaults</title><meta name="description" content="Documentation for the Bank-Vaults">
<meta property="og:title" content="Documentation">
<meta property="og:description" content="Documentation for the Bank-Vaults">
<meta property="og:type" content="website">
<meta property="og:url" content="https://bank-vaults.dev/docs/"><meta property="og:site_name" content="Bank-Vaults">
<meta itemprop="name" content="Documentation">
<meta itemprop="description" content="Documentation for the Bank-Vaults"><meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Documentation">
<meta name="twitter:description" content="Documentation for the Bank-Vaults">
<meta name="twitter:site" content="@calisti12">
<link rel="preload" href="/scss/main.min.676617caf057b12362ecf7673d65047c5fe898a6461e02d928249cbc94b1bdab.css" as="style">
<link href="/scss/main.min.676617caf057b12362ecf7673d65047c5fe898a6461e02d928249cbc94b1bdab.css" rel="stylesheet" integrity>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK" crossorigin="anonymous"></script>
<script defer src="https://unpkg.com/lunr@2.3.9/lunr.min.js" integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli" crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css">
<script src="/js/w3.js" type="application/x-javascript"></script>
</head><body class="td-section">
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg width="144.26347" height="144.26346" viewBox="0 0 144.26348 144.26346" id="svg70" sodipodi:docname="logo.svg" inkscape:version="1.2.1 (9c6d41e4, 2022-07-14)" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/"><sodipodi:namedview pagecolor="#ffffff" bordercolor="#666666" borderopacity="1" objecttolerance="10" gridtolerance="10" guidetolerance="10" inkscape:pageopacity="0" inkscape:pageshadow="2" inkscape:window-width="1309" inkscape:window-height="456" id="namedview72" showgrid="false" inkscape:zoom="1.4142136" inkscape:cx="252.79067" inkscape:cy="89.095452" inkscape:window-x="0" inkscape:window-y="25" inkscape:window-maximized="0" inkscape:current-layer="g89" showguides="true" inkscape:guide-bbox="true" fit-margin-top="0" fit-margin-left="0" fit-margin-right="0" fit-margin-bottom="0" inkscape:showpageshadow="0" inkscape:pagecheckerboard="1" inkscape:deskcolor="#d1d1d1"/><defs id="defs4"><style id="style2">.cls-1{fill:#36a8e1}</style><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="276.63062" x2="-493.32941" y1="231.5972" x1="-498.4776" gradientUnits="userSpaceOnUse" id="SVGID_1_"><stop id="stop1134" style="stop-color:#3C8ECD" offset=".4032"/><stop id="stop1136" style="stop-color:#82CEF2" offset=".9943"/></linearGradient><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="271.8768" x2="-515.39728" y1="233.5062" x1="-511.01059" gradientUnits="userSpaceOnUse" id="SVGID_2_"><stop id="stop1141" style="stop-color:#C18DBE" offset=".4032"/><stop id="stop1143" style="stop-color:#9DB4DD" offset="1"/></linearGradient><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="282.21011" x2="-499.84381" y1="229.3567" x1="-493.8013" gradientUnits="userSpaceOnUse" id="SVGID_3_"><stop id="stop1148" style="stop-color:#454494" offset=".4032"/><stop id="stop1150" style="stop-color:#76A1D6" offset="1"/></linearGradient><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="267.82639" x2="-470.24661" y1="235.1331" x1="-473.98431" gradientUnits="userSpaceOnUse" id="SVGID_4_"><stop id="stop1155" style="stop-color:#56BDC1" offset=".4032"/><stop id="stop1157" style="stop-color:#82CEF2" offset=".9943"/></linearGradient><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="260.12711" x2="-494.45529" y1="229.73219" x1="-492.93121" gradientUnits="userSpaceOnUse" id="SVGID_5_"><stop id="stop1162" style="stop-color:#13287A" offset=".0057"/><stop id="stop1164" style="stop-color:#1A3D8E" offset="1"/></linearGradient><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="235.2251" x2="-507.06671" y1="273.6745" x1="-512.83838" gradientUnits="userSpaceOnUse" id="SVGID_6_"><stop id="stop1169" style="stop-color:#466BB3" offset="0"/><stop id="stop1171" style="stop-color:#3C3079" offset=".7268"/></linearGradient><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="266.69089" x2="-476.4068" y1="238.7536" x1="-482.8345" gradientUnits="userSpaceOnUse" id="SVGID_7_"><stop id="stop1176" style="stop-color:#1972A0" offset=".1924"/><stop id="stop1178" style="stop-color:#3B9FD9" offset="1"/></linearGradient></defs><g id="g2191-6" transform="matrix(1.0391419,0,0,1.0391419,-785.98152,-409.33734)"/><g id="g378" transform="matrix(0.21956619,0,0,0.21956619,-62.665715,99.533341)"><g id="g89" transform="matrix(0.96603773,0,0,0.96603773,0,19.798907)"><rect transform="matrix(4.5544353,0,0,4.5544353,0,-623.95763)" inkscape:export-ydpi="83.459999" inkscape:export-xdpi="83.459999" y="0" x="0" height="265" width="279.07285" id="rect1490-6" style="opacity:1;vector-effect:none;fill:none;fill-opacity:1;stroke:none;stroke-width:.540616;stroke-linecap:butt;stroke-linejoin:bevel;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;paint-order:stroke fill markers"/><g transform="matrix(2.2671253,0,0,2.2671253,-1470.9633,-791.56917)" id="g465-0"><path inkscape:connector-curvature="0" id="path218-5-3" d="m1079.1383 283.12854a150 150 0 01-150.00003 150 150 150 0 01-150-150 150 150 0 01150-150 150 150 0 01150.00003 150z" style="opacity:1;vector-effect:none;fill:#36a8e1;fill-opacity:1;stroke:none;stroke-width:1.59412;stroke-linecap:butt;stroke-linejoin:bevel;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;paint-order:stroke fill markers"/><g transform="matrix(2.0690654,0,0,2.0690654,739.12048,-2709.7574)" id="g1372-0-6"><path id="Path_1631-8-3-1" d="m140.98383 1464.3453c-.23051-1e-4-.46029-.026-.68499-.077l-25.05227-5.7194.12354-.2651c1.52748-3.2666 2.35115-6.818 2.41755-10.4236l.006-.2901 25.014 5.7107c.79405.1802 1.48298.6706 1.91325 1.362.43597.6876.57876 1.5212.39658 2.3148l-1.14156 5.0004c-.18024.794-.67067 1.483-1.36196 1.9133-.48769.3088-1.05281.4733-1.63004.4745z" class="cls-1" data-name="Path 1631" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="ccccccccccccc"/><path id="Path_1632-4-6-0" d="m42.692762 1464.3453c-1.431928.0-2.67294-.9922-2.993412-2.3878l-1.141574-5.0004c-.182495-.7936-.03976-1.6272.396351-2.3149.43031-.6912 1.11923-1.1816 1.913251-1.3619l25.027696-5.7136.0056.2898c.06623 3.6055.889568 7.1567 2.416603 10.4235l.123771.265-25.064544 5.7224c-.224287.051-.453658.078-.683811.078z" class="cls-1" data-name="Path 1632" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="cccccccccccc"/><path id="Path_1633-8-1-6" d="m86.203652 1421.9854v-25.527c.0018-1.6952 1.375526-3.0689 3.070652-3.0707h5.128931c1.695126.0 3.068839 1.3755 3.070651 3.0707v25.5244l-.284625-.06c-3.528917-.734-7.171122-.734-10.700038.0z" class="cls-1" data-name="Path 1633" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="ccccccccc"/><path id="Path_1634-1-0-3" d="m68.4782 1436.0192-20.013323-15.9593c-.637548-.507-1.045807-1.2479-1.133778-2.0576-.09463-.8087.138439-1.6218.647198-2.2577l3.197729-4.0099c.506674-.6378 1.24758-1.0461 2.057336-1.1339.808868-.095 1.622095.138 2.257874.647l19.982853 15.9355-.222741.1854c-2.774754 2.3028-5.037618 5.1601-6.643471 8.3886z" class="cls-1" data-name="Path 1634" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="ccccccccccc"/><path id="Path_1635-0-6-20" d="m111.69006 1497.5553c-1.18101 8e-4-2.25818-.6747-2.77162-1.7383l-11.17906-23.2188.283444-.069c3.503736-.8523 6.788826-2.4326 9.641606-4.6381l.23078-.1776 11.1774 23.2146c.35415.7333.40034 1.5777.12826 2.3453-.26575.7699-.8286 1.4012-1.56296 1.7533l-4.6211 2.2253c-.41379.1996-.8673.3034-1.32675.3035z" class="cls-1" data-name="Path 1635" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="cccccccccccc"/><path id="Path_1636-3-3-61" d="m71.986066 1497.5553c-.459533.0-.913133-.1036-1.326994-.3035l-4.621331-2.2253c-.734212-.3523-1.297005-.9837-1.56296-1.7533-.272113-.7676-.225844-1.612.128494-2.3453l11.180949-23.2221.230772.1778c2.851924 2.2071 6.136543 3.7892 9.64019 4.6431l.283445.069-11.180476 23.2209c-.513556 1.0637-1.590928 1.7393-2.772089 1.7383z" class="cls-1" data-name="Path 1636" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="cccccccccccc"/><path id="Path_1637-0-2-5" d="m115.20736 1436.0117-.13061-.2615c-1.60686-3.2281-3.87061-6.0848-6.64607-8.3867l-.22298-.1853 19.97672-15.9299c1.32641-1.0555 3.25699-.8379 4.3152.4864l3.19773 4.0099c1.05536 1.3265.8379 3.2569-.48611 4.3153z" class="cls-1" data-name="Path 1637" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="ccccccccc"/></g><path sodipodi:nodetypes="ccccccccccccccccc" style="fill:#fff;stroke-width:.488708" inkscape:connector-curvature="0" data-name="Path 1611" class="cls-1" d="m953.64449 351.25645v0l-49.11506-.0269c-4.61319.0-8.97664-2.09451-11.8425-5.70793l-30.605-38.41323c-2.88324-3.59976-3.95895-8.32323-2.91945-12.81745l10.95094-47.87714c1.01715-4.50022 4.03882-8.28619 8.20095-10.27663l44.26-21.28965c4.15116-2.00969 8.99505-2.00969 13.14622.0l44.24138 21.33123c4.16027 1.9952 7.17883 5.77994 8.19205 10.28285l10.9077 47.88769c1.03498 4.49504-.0455 9.2183-2.93249 12.81517l-30.64182 38.38551c-2.8669 3.60969-7.22725 5.70937-11.83609 5.69717z" id="path1253-3-0-5"/><path sodipodi:nodetypes="ccccccccccccccccc" style="fill:#36a8e1;fill-opacity:1;stroke-width:.37402" inkscape:connector-curvature="0" data-name="Path 1611" class="cls-1" d="m947.8838 335.07491v0l-37.58892-.0228c-3.53065.0-6.86992-1.60353-9.06334-4.36945L877.8089 301.28397c-2.20666-2.75352-3.02994-6.36941-2.23439-9.80903l8.38096-36.64087c.77838-3.44417 3.09098-6.34189 6.27651-7.86493l33.8735-16.29513c3.17684-1.53773 6.88419-1.53773 10.06103.0l33.85902 16.32575c3.18408 1.52676 5.49399 4.42366 6.26968 7.86969l8.34785 36.64936c.79204 3.43961-.0331 7.0553-2.24431 9.80881l-23.451 29.37577c-2.19404 2.76323-5.53102 4.37048-9.05837 4.36117z" id="path1253-6-4"/><g transform="matrix(0.48872138,0,0,0.48872138,1906.5441,113.88789)" id="Group_365-8-1-7" data-name="Group 365" style="fill:#fff"><path sodipodi:nodetypes="cccccc" id="Path_1612-1-5-6" d="m-2036.06 314.053h-.06c-7.1763-.008-12.9917-5.82372-13-13-.018-7.19712 5.8029-13.04555 13-13.061 7.1967-.0177 13.0446 5.80326 13.06 13 .018 7.19712-5.8029 13.04555-13 13.061z" class="cls-1" data-name="Path 1612" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccccc" id="Path_1613-2-5-5" d="m-1963.88 314.053h-.06c-7.1763-.008-12.9917-5.82372-13-13-.018-7.19712 5.8029-13.04555 13-13.061 7.197-.0183 13.0451 5.80303 13.06 13 .018 7.19712-5.8029 13.04555-13 13.061zm0-24.061c-6.0926-.0188 6.0933.0138.0.0z" class="cls-1" data-name="Path 1613" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1614-9-4-69" d="m-2036.06 350.143h-.06c-7.1763-.008-12.9917-5.82372-13-13-.018-7.19696 5.803-13.04511 13-13.06 7.1967-.0177 13.0446 5.80326 13.06 13 .018 7.19673-5.8033 13.04455-13 13.06z" class="cls-1" data-name="Path 1614" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1615-3-7-3" d="m-1963.88 350.143h-.06c-7.1763-.008-12.9917-5.82372-13-13-.018-7.19673 5.8033-13.04455 13-13.06 7.197-.0183 13.0451 5.80303 13.06 13 .018 7.19696-5.803 13.04511-13 13.06z" class="cls-1" data-name="Path 1615" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1616-9-6-7" d="m-2036.06 386.233h-.06c-7.1763-.008-12.9917-5.82372-13-13-.018-7.19696 5.803-13.04511 13-13.06 7.1967-.0177 13.0446 5.80326 13.06 13 .018 7.19673-5.8033 13.04455-13 13.06z" class="cls-1" data-name="Path 1616" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1617-0-5-4" d="m-1999.97 314.053h-.06c-7.1765-.008-12.9923-5.8235-13-13-.018-7.19712 5.8029-13.04555 13-13.061 7.197-.0183 13.0451 5.80303 13.06 13 .018 7.19712-5.8029 13.04555-13 13.061z" class="cls-1" data-name="Path 1617" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1618-8-6-5" d="m-1999.97 350.143h-.06c-7.1765-.008-12.9923-5.8235-13-13-.018-7.19696 5.803-13.04511 13-13.06 7.197-.0183 13.0451 5.80303 13.06 13 .018 7.19696-5.803 13.04511-13 13.06z" class="cls-1" data-name="Path 1618" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1619-8-9-2" d="m-1999.97 386.233h-.06c-7.1765-.008-12.9923-5.8235-13-13-.018-7.19696 5.803-13.04511 13-13.06 7.197-.0183 13.0451 5.80303 13.06 13 .018 7.19696-5.803 13.04511-13 13.06z" class="cls-1" data-name="Path 1619" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1620-5-3-5" d="m-1999.97 422.323h-.06c-7.1765-.008-12.9923-5.8235-13-13-.018-7.19696 5.803-13.04511 13-13.06 7.197-.0182 13.0451 5.80303 13.06 13 .018 7.19696-5.803 13.04511-13 13.06z" class="cls-1" data-name="Path 1620" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1621-0-7-4" d="m-1963.88 386.233h-.06c-7.1763-.008-12.9917-5.82372-13-13-.018-7.19673 5.8033-13.04455 13-13.06 7.197-.0183 13.0451 5.80303 13.06 13 .018 7.19696-5.803 13.04511-13 13.06z" class="cls-1" data-name="Path 1621" inkscape:connector-curvature="0" style="fill:#fff"/></g></g></g></g></svg></span><span class="navbar-brand__name">Bank-Vaults</span>
<span class="font-weight-bold navbar-logo navbar-version">1.19.0</span></a>
<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link" href="https://github.com/banzaicloud/bank-vaults" target="_blank"><span>Project page</span></a>
</li><li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link" href="/docs/"><span>Documentation</span></a>
</li></ul></div><div class="navbar-nav d-none d-lg-block">
<div class="td-search td-search--offline">
<div class="td-search__icon"></div><input type="search" class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete="off" data-offline-search-index-json-src="/offline-search-index.afb65e5cd5dda894dfde686c0a3300e8.json" data-offline-search-base-href="/" data-offline-search-max-results="10">
</div></div></nav></header><div class="container-fluid td-outer">
<div class="td-main">
<div class="row flex-xl-nowrap">
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="return print(),!1">Click here to print</a>.
</p><p>
<a href="/docs/">Return to the regular view of this page</a>.
</p></div><h1 class="title">Documentation</h1><ul>
<li>1: <a href="#pg-1f85133d183862b1211294fc67f08802">Getting started</a></li><ul>
<li>1.1: <a href="#pg-fbb24e4e19a4e351b9ef1b63f7a64769">Deploy vault into a custom namespace</a></li></ul><li>2: <a href="#pg-56ce7d9aa7a769a51d7dc74449c33c58">External configuration for Vault</a></li><ul>
<li>2.1: <a href="#pg-fec16b127bdfe268f830ef92f17403f0">Fully or partially purging unmanaged configuration in Vault</a></li><li>2.2: <a href="#pg-7b0377a17f1d979bab6eaef8dfe186a0">Audit devices</a></li><li>2.3: <a href="#pg-d415ff483df105bc7d627aa67e57a694">Authentication</a></li><li>2.4: <a href="#pg-dd6ac132712c4f14b6c23b0070f3a40d">Plugins</a></li><li>2.5: <a href="#pg-b5d102db99ba7e0768287ca2964300cd">Policies</a></li><li>2.6: <a href="#pg-f5287e0cb4088762a08b3f7997b16b8f">Secrets engines</a></li><li>2.7: <a href="#pg-0458546c3492730ad7009f9eb9c2de19">Startup secrets</a></li></ul><li>3: <a href="#pg-c9bd3f4b41ab7ac382833f7bc4d42b14">Environment variables</a></li><ul>
</ul><li>4: <a href="#pg-96c4ff43558e2f86011b50d22caa006c">Operator</a></li><ul>
<li>4.1: <a href="#pg-c02fa8fe03d0456a434494ea53489be6">Running Vault with external end to end encryption</a></li><li>4.2: <a href="#pg-949e2eebfdc98439688db69b29ace521">Using templates for injecting dynamic configuration</a></li><li>4.3: <a href="#pg-2886c2109e2b4def2a9fca4884615cf6">Upgrade Vault with the Bank-Vaults operator</a></li><li>4.4: <a href="#pg-0bf9c9ceafec846263a56eeaff007d5f">Operator Configuration for Functioning Webhook Secrets Mutation</a></li></ul><li>5: <a href="#pg-e5fbbbffbf0d95ae495ebd89ab145439">Mutating Webhook</a></li><ul>
<li>5.1: <a href="#pg-ca011539082e4a0e051bd02ace83c3e5">Deploy the webhook</a></li><li>5.2: <a href="#pg-2d9a764f72223def1f5372077db5d9d3">Configuration examples and scenarios</a></li><li>5.3: <a href="#pg-3114defb3d9cb8776803617067a58907">Annotations</a></li><li>5.4: <a href="#pg-b05dd7ba49df3a955b7908ff777f3a2b">Using Vault Agent Templating in the mutating webhook</a></li><li>5.5: <a href="#pg-9ad4aac418ac0e1def9bf0c4bfe6b5f4">Using consul-template in the mutating webhook</a></li><li>5.6: <a href="#pg-4fdd9c4aa5b4e731487b9967ac5afd93">Transit Encryption</a></li><li>5.7: <a href="#pg-789c03a017d516c224edcadf80386609">Monitoring the Webhook with Grafana and Prometheus</a></li><li>5.8: <a href="#pg-d01053a982de9bc8c5063273f84aa47f">Injecting consul-template into the Prometheus operator for Vault metrics</a></li><li>5.9: <a href="#pg-40ade858fb140e470d28b5c4d75ad0ef">Comparison of Banzai Cloud and HashiCorp mutating webhook for Vault</a></li><li>5.10: <a href="#pg-06a0154e4fe026f4982258ce9841854f">Running the webhook and Vault on different clusters</a></li></ul><li>6: <a href="#pg-0300ffba6202f9ac291d350220c40174">Unseal keys</a></li><ul>
</ul><li>7: <a href="#pg-790ab2316602afe20aacd021437ce00d">TLS</a></li><ul>
</ul><li>8: <a href="#pg-693b5b7c6aa0741d04206716de562ffe">Cloud permissions</a></li><ul>
</ul><li>9: <a href="#pg-775eaf4271da79cc2631e217d7779d22">Backing up Vault</a></li><ul>
</ul><li>10: <a href="#pg-c1595f38d483461f6dd56c889fe355d2">Running the Bank-Vaults secret webhook alongside Istio</a></li><ul>
<li>10.1: <a href="#pg-94914e31e06eb46fb176a25ca68509d1">Scenario 1 - Vault runs outside, the application inside the mesh</a></li><li>10.2: <a href="#pg-b903e9610a0524bda4a27e27b93ed164">Scenario 2 - Running Vault inside the mesh</a></li><li>10.3: <a href="#pg-3901a1aaad74c653def694b23cd5d371">Scenario 3 - Both Vault and the app are running inside the mesh</a></li></ul><li>11: <a href="#pg-69bc5d1aaecbcd0707873de44ca465ec">HSM Support</a></li><ul>
<li>11.1: <a href="#pg-dc66273caf9253f55709a2b96999fe12">NitroKey HSM support (OpenSC)</a></li><li>11.2: <a href="#pg-6aa446bed53e7dbb32f03693a7de4464">SoftHSM support for testing</a></li></ul><li>12: <a href="#pg-d1d67302dbc57a8fb46426ac0075ee73">The CLI tool</a></li><ul>
</ul><li>13: <a href="#pg-64ae4cd33575303212292e924408942f">The Go library</a></li><ul>
</ul><li>14: <a href="#pg-e92236d181fd38f552e14b0770227143">Monitoring</a></li><ul>
</ul><li>15: <a href="#pg-da3a81be596bb98f259c9afae940c6b4">Annotations and labels</a></li><ul>
</ul><li>16: <a href="#pg-3309e9b896978010784680d5d7c7c406">Watching External Secrets</a></li><ul>
</ul><li>17: <a href="#pg-06363047ee9e9f418fb8351eb60a4059">Tips and tricks</a></li><ul>
</ul><li>18: <a href="#pg-3ade8a7754000f0595f59f570b1f9a85">Support</a></li><li>19: <a href="#pg-1bf07101845de6da98f1c948b82c5ce0">Development</a></li><li>20: <a href="#pg-99612595f9f698dd585c96dcc8298d9a">Contributing</a></li><ul>
</ul><li>21: <a href="#pg-580feadace0eda0383d7052c8aba3630">Maintainer guide</a></li></ul><div class="content">
<p>Bank-Vaults is a <strong>Vault</strong> swiss-army knife: a K8s operator, Go client with automatic token renewal, automatic configuration, multiple unseal options and more. A CLI tool to init, unseal and configure Vault (auth methods, secret engines). Direct secret injection into Pods.</p><p>Bank-Vaults provides the following tools for Hashicorp Vault to make its use easier and more automated:</p><ul>
<li>A <a href="/docs/operator/">Kubernetes operator for provisioning secrets</a>.</li><li>A <a href="/docs/mutating-webhook/">mutating webhook for injecting secrets</a>.</li><li>A <a href="/docs/cli-tool/">CLI tool</a> to automatically initialize, unseal, and configure Vault with authentication methods and secret engines.</li><li>A <a href="/docs/go-library/">Go client wrapper</a> for the official Vault client with automatic token renewal, built-in Kubernetes support, and a dynamic database credential provider.</li></ul><p><img src="/docs/images/bank-vault-overview.png" alt="Bank-Vaults overview"></p><p>The package also includes Helm charts for installing the various components, and a collection of scripts to support advanced features (for example, dynamic SSH).</p><h2 id="first-step">First step</h2><ul>
<li>If you are new to <strong>Bank-Vaults</strong>, begin with the <a href="/docs/installing/">getting started guide</a>.</li><li>If you need help using Bank-Vaults, see the <a href="/docs/support/">Support page</a> for ways to contact us.</li></ul></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-1f85133d183862b1211294fc67f08802">1 - Getting started</h1><p>Bank-Vaults is a swiss-army knife with multiple manifestations, so the first steps depend on what you want to achieve.
Check one of the following guides to get an overview:</p><ul>
<li><a href="https://techblog.cisco.com/vault-dynamic-secrets/">Dynamic credentials with Vault using Kubernetes Service Accounts</a></li><li><a href="https://techblog.cisco.com/vault-operator/">Vault Operator</a></li><li><a href="https://techblog.cisco.com/vault-unsealing/">Vault unseal flow with KMS</a></li><li><a href="https://techblog.cisco.com/monitoring-vault-grafana/">Monitoring Vault on Kubernetes using Cloud Native technologies</a></li><li><a href="https://techblog.cisco.com/inject-secrets-into-pods-vault-revisited/">Inject secrets directly into pods from Vault</a></li></ul><h2 id="deploy-with-helm">Deploy with Helm</h2><p>We have some fully fledged, production-ready Helm charts for deploying:</p><ul>
<li><a href="https://github.com/bank-vaults/bank-vaults/tree/master/charts/vault">Vault</a> using <code>bank-vaults</code>,</li><li>the <a href="https://github.com/bank-vaults/bank-vaults/tree/master/charts/vault-operator">Vault Operator</a>, and also</li><li>the <a href="https://github.com/bank-vaults/bank-vaults/tree/master/charts/vault-secrets-webhook">Vault Secrets Webhook</a>.</li></ul><p>With the help of these charts you can run a HA Vault instance with automatic initialization, unsealing, and external configuration which would otherwise be a tedious manual operation. Also secrets from Vault can be injected into your Pods directly as environment variables (without using Kubernetes Secrets). These charts can be used easily for development purposes as well.</p><blockquote>
<p>Note: Starting with Bank-Vaults version 1.6.0, only Helm 3 is supported. If you have installed the chart with Helm 2 and now you are trying to upgrade with Helm3, see the <a href="https://github.com/bank-vaults/bank-vaults/releases/tag/1.6.0">Bank-Vaults 1.6.0 release notes</a> for detailed instructions.</p></blockquote><h2 id="deploy-operator">Deploy a local Vault operator</h2><p>This is the simplest scenario: you install the Vault operator on a simple cluster. The following commands install a single-node Vault instance that stores unseal and root tokens in Kubernetes secrets.</p><ol>
<li>
<p>Install the Bank-Vaults operator:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm repo add banzaicloud-stable https://kubernetes-charts.banzaicloud.com
</span></span><span style="display:flex"><span>helm upgrade --install vault-operator banzaicloud-stable/vault-operator
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>Release <span style="color:#4e9a06">&#34;vault-operator&#34;</span> does not exist. Installing it now.
</span></span><span style="display:flex"><span>NAME: vault-operator
</span></span><span style="display:flex"><span>LAST DEPLOYED: Fri Jul <span style="color:#0000cf;font-weight:700">14</span> 14:41:18 <span style="color:#0000cf;font-weight:700">2023</span>
</span></span><span style="display:flex"><span>NAMESPACE: default
</span></span><span style="display:flex"><span>STATUS: deployed
</span></span><span style="display:flex"><span>REVISION: <span style="color:#0000cf;font-weight:700">1</span>
</span></span><span style="display:flex"><span>TEST SUITE: None
</span></span></code></pre></div></li><li>
<p>Create a Vault instance using the Vault custom resources. This will create a Kubernetes <code>CustomResource</code> called <code>vault</code> and a PersistentVolumeClaim for it:</p><blockquote>
<p>Note: The following commands use a specific version of the CRs, because the current version is not yet working, as we are in the process of migrating the Bank-Vaults repositories.</p></blockquote><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/banzaicloud/bank-vaults/v1.15.3/operator/deploy/rbac.yaml
</span></span><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/banzaicloud/bank-vaults/v1.15.3/operator/deploy/cr.yaml
</span></span></code></pre></div></li><li>
<p>Wait a few seconds, then check the operator and the vault pods:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get pods
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>NAME                                                        READY     STATUS    RESTARTS   AGE
</span></span><span style="display:flex"><span>vault-0                                                     3/3       Running   <span style="color:#0000cf;font-weight:700">0</span>          10s
</span></span><span style="display:flex"><span>vault-configurer-6c545cb6b4-dmvb5                           1/1       Running   <span style="color:#0000cf;font-weight:700">0</span>          10s
</span></span><span style="display:flex"><span>vault-operator-788559bdc5-kgqkg                             1/1       Running   <span style="color:#0000cf;font-weight:700">0</span>          23s
</span></span></code></pre></div></li><li>
<p>Configure your Vault client to access the Vault instance running in the <em>vault-0</em> pod.</p><ol>
<li>
<p>Port-forward into the pod:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl port-forward vault-0 <span style="color:#0000cf;font-weight:700">8200</span> <span style="color:#000;font-weight:700">&amp;</span>
</span></span></code></pre></div></li><li>
<p>Set the address of the Vault instance.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#204a87">export</span> <span style="color:#000">VAULT_ADDR</span><span style="color:#ce5c00;font-weight:700">=</span>https://127.0.0.1:8200
</span></span></code></pre></div></li><li>
<p>Import the CA certificate of the Vault instance by running the following commands (otherwise, you&rsquo;ll get <em>x509: certificate signed by unknown authority</em> errors):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get secret vault-tls -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;{.data.ca\.crt}&#34;</span> <span style="color:#000;font-weight:700">|</span> base64 --decode &gt; <span style="color:#000">$PWD</span>/vault-ca.crt
</span></span><span style="display:flex"><span><span style="color:#204a87">export</span> <span style="color:#000">VAULT_CACERT</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#000">$PWD</span>/vault-ca.crt
</span></span></code></pre></div><p>Alternatively, you can instruct the Vault client to skip verifying the certificate of Vault by running: <code>export VAULT_SKIP_VERIFY=true</code></p></li><li>
<p>If you already have the <a href="https://developer.hashicorp.com/vault/downloads">Vault CLI installed</a>, check that you can access the Vault:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>vault status
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>Key             Value
</span></span><span style="display:flex"><span>---             -----
</span></span><span style="display:flex"><span>Seal Type       shamir
</span></span><span style="display:flex"><span>Initialized     <span style="color:#204a87">true</span>
</span></span><span style="display:flex"><span>Sealed          <span style="color:#204a87">false</span>
</span></span><span style="display:flex"><span>Total Shares    <span style="color:#0000cf;font-weight:700">5</span>
</span></span><span style="display:flex"><span>Threshold       <span style="color:#0000cf;font-weight:700">3</span>
</span></span><span style="display:flex"><span>Version         1.5.4
</span></span><span style="display:flex"><span>Cluster Name    vault-cluster-27ecd0e6
</span></span><span style="display:flex"><span>Cluster ID      ed5492f3-7ef3-c600-aef3-bd77897fd1e7
</span></span><span style="display:flex"><span>HA Enabled      <span style="color:#204a87">false</span>
</span></span></code></pre></div></li><li>
<p>To authenticate to Vault, you can access its root token by running:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#204a87">export</span> <span style="color:#000">VAULT_TOKEN</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#204a87;font-weight:700">$(</span>kubectl get secrets vault-unseal-keys -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:700">={</span>.data.vault-root<span style="color:#ce5c00;font-weight:700">}</span> <span style="color:#000;font-weight:700">|</span> base64 --decode<span style="color:#204a87;font-weight:700">)</span>
</span></span></code></pre></div><blockquote>
<p>Note: Using the root token is recommended only in test environments. In production environment, create dedicated, time-limited tokens.</p></blockquote></li><li>
<p>Now you can interact with Vault. For example, add a secret by running <code>vault kv put secret/demosecret/aws AWS_SECRET_ACCESS_KEY=s3cr3t</code>
If you want to access the Vault web interface, open <em>https://127.0.0.1:8200</em> in your browser using the root token (to reveal the token, run <code>echo $VAULT_TOKEN</code>).</p></li></ol></li></ol><p>For other configuration examples of the Vault CustomResource, see the YAML files in the <a href="https://github.com/bank-vaults/bank-vaults/tree/master/operator/deploy">operator/deploy directory of the project</a> (we use these for testing). After you are done experimenting with Bank-Vaults and you want to delete the operator, you can delete the related CRs:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl delete -f https://raw.githubusercontent.com/banzaicloud/bank-vaults/master/operator/deploy/rbac.yaml
</span></span><span style="display:flex"><span>kubectl delete -f https://raw.githubusercontent.com/banzaicloud/bank-vaults/master/operator/deploy/cr.yaml
</span></span></code></pre></div><h2 id="deploy-the-mutating-webhook">Deploy the mutating webhook</h2><p>You can deploy the Vault Secrets Webhook using Helm. Note that:</p><ul>
<li>The Helm chart of the vault-secrets-webhook contains the templates of the required permissions as well.</li><li>The deployed RBAC objects contain the necessary permissions fo running the webhook.</li></ul><h3 id="prerequisites">Prerequisites</h3><ul>
<li>The user you use for deploying the chart to the Kubernetes cluster must have cluster-admin privileges.</li><li>The chart requires Helm 3.</li><li>To interact with Vault (for example, for testing), the <em>vault</em> command line client must be installed on your computer.</li><li>You have deployed Vault with the operator and configured your Vault client to access it, as described in <a href="/docs/installing/#deploy-operator">Deploy a local Vault operator</a>.</li></ul><h3 id="deploy-the-webhook">Deploy the webhook</h3><ol>
<li>
<p>Create a namespace for the webhook and add a label to the namespace, for example, <em>vault-infra</em>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl create namespace vault-infra
</span></span><span style="display:flex"><span>kubectl label namespace vault-infra <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:700">=</span>vault-infra
</span></span></code></pre></div></li><li>
<p>Deploy the vault-secrets-webhook chart:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm repo add banzaicloud-stable https://kubernetes-charts.banzaicloud.com
</span></span><span style="display:flex"><span>helm upgrade --namespace vault-infra --install vault-secrets-webhook banzaicloud-stable/vault-secrets-webhook
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>Release <span style="color:#4e9a06">&#34;vault-secrets-webhook&#34;</span> does not exist. Installing it now.
</span></span><span style="display:flex"><span>NAME: vault-secrets-webhook
</span></span><span style="display:flex"><span>LAST DEPLOYED: Fri Jul <span style="color:#0000cf;font-weight:700">14</span> 15:42:36 <span style="color:#0000cf;font-weight:700">2023</span>
</span></span><span style="display:flex"><span>NAMESPACE: vault-infra
</span></span><span style="display:flex"><span>STATUS: deployed
</span></span><span style="display:flex"><span>REVISION: <span style="color:#0000cf;font-weight:700">1</span>
</span></span><span style="display:flex"><span>TEST SUITE: None
</span></span></code></pre></div><p>For further details, see the <a href="https://github.com/bank-vaults/bank-vaults/tree/master/charts/vault-secrets-webhook">webhook&rsquo;s Helm chart repository</a>.</p></li><li>
<p>Check that the pods are running:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get pods --namespace vault-infra
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>NAME                                     READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex"><span>vault-secrets-webhook-58b97c8d6d-qfx8c   1/1     Running   <span style="color:#0000cf;font-weight:700">0</span>          22s
</span></span><span style="display:flex"><span>vault-secrets-webhook-58b97c8d6d-rthgd   1/1     Running   <span style="color:#0000cf;font-weight:700">0</span>          22s
</span></span></code></pre></div></li><li>
<p>If you already have the <a href="https://developer.hashicorp.com/vault/downloads">Vault CLI installed</a>, write a secret into Vault:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>vault kv put secret/demosecret/aws <span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#ce5c00;font-weight:700">=</span>s3cr3t
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>Key              Value
</span></span><span style="display:flex"><span>---              -----
</span></span><span style="display:flex"><span>created_time     2020-11-04T11:39:01.863988395Z
</span></span><span style="display:flex"><span>deletion_time    n/a
</span></span><span style="display:flex"><span>destroyed        <span style="color:#204a87">false</span>
</span></span><span style="display:flex"><span>version          <span style="color:#0000cf;font-weight:700">1</span>
</span></span></code></pre></div></li><li>
<p>Apply the following deployment to your cluster. The webhook will mutate this deployment because it has an environment variable having a value which is a reference to a path in Vault:</p><pre>
    <code class="language-yaml">kubectl create -f - &lt;&lt;EOF
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: vault-test
    spec:
      replicas: 1
      selector:
        matchLabels:
          app.kubernetes.io/name: vault
      template:
        metadata:
          labels:
            app.kubernetes.io/name: vault
          annotations:
            vault.security.banzaicloud.io/vault-addr: &#34;https://vault:8200&#34; # optional, the address of the Vault service, default values is https://vault:8200
            vault.security.banzaicloud.io/vault-role: &#34;default&#34; # optional, the default value is the name of the ServiceAccount the Pod runs in, in case of Secrets and ConfigMaps it is &#34;default&#34;
            vault.security.banzaicloud.io/vault-skip-verify: &#34;false&#34; # optional, skip TLS verification of the Vault server certificate
            vault.security.banzaicloud.io/vault-tls-secret: &#34;vault-tls&#34; # optional, the name of the Secret where the Vault CA cert is, if not defined it is not mounted
            vault.security.banzaicloud.io/vault-agent: &#34;false&#34; # optional, if true, a Vault Agent will be started to do Vault authentication, by default not needed and vault-env will do Kubernetes Service Account based Vault authentication
            vault.security.banzaicloud.io/vault-path: &#34;kubernetes&#34; # optional, the Kubernetes Auth mount path in Vault the default value is &#34;kubernetes&#34;
        spec:
          serviceAccountName: default
          containers:
          - name: alpine
            image: alpine
            command: [&#34;sh&#34;, &#34;-c&#34;, &#34;echo $AWS_SECRET_ACCESS_KEY &amp;&amp; echo going to sleep... &amp;&amp; sleep 10000&#34;]
            env:
            - name: AWS_SECRET_ACCESS_KEY
              value: vault:secret/data/demosecret/aws#AWS_SECRET_ACCESS_KEY
    EOF</code>
    </pre><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>deployment.apps/vault-test created
</span></span></code></pre></div></li><li>
<p>Check the mutated deployment.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl describe deployment vault-test
</span></span></code></pre></div><p>The output should look similar to the following:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">Name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#000">vault-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Namespace</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">CreationTimestamp</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">Wed, 04 Nov 2020 12:44:18 +0100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#000">&lt;none&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Annotations:            deployment.kubernetes.io/revision</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Selector</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#000">app.kubernetes.io/name=vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Replicas</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:700">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">desired | 1 updated | 1 total | 1 available | 0 unavailable</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">StrategyType</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#000">RollingUpdate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">MinReadySeconds</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:700">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">RollingUpdateStrategy</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#0000cf;font-weight:700">25</span><span style="color:#000">% max unavailable, 25% max surge</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Pod Template</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">Labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#000">app.kubernetes.io/name=vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">Annotations:      vault.security.banzaicloud.io/vault-addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://vault:8200</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-agent</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-role</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-skip-verify</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-tls-secret</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-tls</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">Service Account</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">Containers</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:700">alpine</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">Image</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">alpine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">Port</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">&lt;none&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">Host Port</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">&lt;none&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">Command</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">sh</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>-<span style="color:#000">c</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">echo $AWS_SECRET_ACCESS_KEY &amp;&amp; echo going to sleep... &amp;&amp; sleep 10000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">Environment</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">AWS_SECRET_ACCESS_KEY</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">vault:secret/data/demosecret/aws#AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">Mounts</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#000">&lt;none&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">Volumes</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">&lt;none&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Conditions</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Type           Status  Reason</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>---- <span style="color:#f8f8f8;text-decoration:underline">          </span>------ <span style="color:#f8f8f8;text-decoration:underline"> </span>------<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Available      True    MinimumReplicasAvailable</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Progressing    True    NewReplicaSetAvailable</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">OldReplicaSets</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">&lt;none&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">NewReplicaSet</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">vault-test-55c569f9 (1/1 replicas created)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Events</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Type    Reason             Age   From                   Message</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>---- <span style="color:#f8f8f8;text-decoration:underline">   </span>------ <span style="color:#f8f8f8;text-decoration:underline">            </span>---- <span style="color:#f8f8f8;text-decoration:underline"> </span>---- <span style="color:#f8f8f8;text-decoration:underline">                  </span>-------<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Normal  ScalingReplicaSet  29s   deployment-controller  Scaled up replica set vault-test-55c569f9 to 1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>As you can see, the original environment variables in the definition are unchanged, and the sensitive value of the AWS_SECRET_ACCESS_KEY variable is only visible within the alpine container.</p></li></ol><h2 id="install-the-cli-tool">Install the CLI tool</h2><p>On macOs, you can directly install the CLI from Homebrew:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>brew install banzaicloud/tap/bank-vaults
</span></span></code></pre></div><p>Alternatively, fetch the source code and compile it using go get:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>go get github.com/bank-vaults/bank-vaults/cmd/bank-vaults
</span></span><span style="display:flex"><span>go get github.com/bank-vaults/bank-vaults/cmd/vault-env
</span></span></code></pre></div><h2 id="docker-images">Docker images</h2><p>If you want to build upon our Docker images, you can find them on Docker Hub:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>docker pull banzaicloud/bank-vaults
</span></span><span style="display:flex"><span>docker pull banzaicloud/vault-operator
</span></span><span style="display:flex"><span>docker pull banzaicloud/vault-env
</span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-fbb24e4e19a4e351b9ef1b63f7a64769">1.1 - Deploy vault into a custom namespace</h1><p>To deploy vault into a custom namespace (not into <code>default</code>), you have to deploy the vault CustomResource to the custom namespace. Also, you have to use the custom namespace in the following fields:</p><p>In the RBAC resources:</p><ul>
<li><a href="https://github.com/bank-vaults/bank-vaults/blob/master/operator/deploy/rbac.yaml#L49">subjects.namespace of the ClusterRoleBinding</a></li></ul><p>In the Vault CR:</p><ul>
<li><a href="https://github.com/bank-vaults/bank-vaults/blob/master/operator/deploy/cr.yaml#L101">unsealConfig.kubernetes.secretNamespace</a></li><li><a href="https://github.com/bank-vaults/bank-vaults/blob/master/operator/deploy/cr.yaml#L155-L157">secrets.configuration.config.issuing_certificates and crl_distribution_points:</a></li></ul></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-56ce7d9aa7a769a51d7dc74449c33c58">2 - External configuration for Vault</h1><p>In addition to the <a href="https://www.vaultproject.io/docs/configuration/index.html">standard Vault configuration</a>, the operator and CLI can continuously configure Vault using an external YAML/JSON configuration. That way you can configure Vault declaratively using your usual automation tools and workflow.</p><p>The following sections describe the configuration sections you can use.</p><ul>
<li><a href="/docs/external-configuration/purge-unmanaged-configuration/">Purge unmanaged configuration</a></li><li><a href="/docs/external-configuration/audit-devices/">Audit devices</a></li><li><a href="/docs/external-configuration/authentication/">Authentication</a></li><li><a href="/docs/external-configuration/plugins/">Plugins</a></li><li><a href="/docs/external-configuration/policies/">Policies</a></li><li><a href="/docs/external-configuration/secrets-engines/">Secrets engines</a></li><li><a href="/docs/external-configuration/startup-secrets/">Startup secrets</a></li></ul></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-fec16b127bdfe268f830ef92f17403f0">2.1 - Fully or partially purging unmanaged configuration in Vault</h1><p>Bank-Vaults gives you a full control over Vault in a declarative style by removing any unmanaged configuration.</p><p>By enabling <code>purgeUnmanagedConfig</code> you keep Vault configuration up-to-date.
So if you added a policy using Bank-Vaults then removed it from the configuration,
Bank-Vaults will remove it from Vault too. In other words, if you enabled <code>purgeUnmanagedConfig</code>
then any changes not in Bank-Vaults configuration will be removed (including manual changes).</p><blockquote>
<p>Note:</p><p>This feature is <code>destructive</code>, so be carful when you enable it especially for the first time
<strong>because it could delete all data in your Vault.</strong> We recommend you to test it a non-production environment first.</p></blockquote><p>This feature is disabled by default and it needs to be enabled explicitly in your configuration.</p><h2 id="mechanism">Mechanism</h2><p>Bank-Vaults handles unmanaged configuration by simply comparing what in Bank-Vaults configuration (the desired state)
and what&rsquo;s already in Vault (the actual state), then it removes any differences that are not in Bank-Vaults
configuration.</p><h2 id="fully-purge-unmanaged-configuration">Fully purge unmanaged configuration</h2><p>You can remove <strong>all</strong> unmanaged configuration by enabling the purge option as following:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">purgeUnmanagedConfig</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">enabled</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="partially-purge-unmanaged-configuration">Partially purge unmanaged configuration</h2><p>You can also enable the purge feature for some of the config by excluding any config that
you don&rsquo;t want to purge its unmanaged config.</p><p>It could be done by explicitly exclude the Vault configuration that you don&rsquo;t want to mange:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">purgeUnmanagedConfig</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">enabled</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">exclude</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">secrets</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>This will remove any unmanaged or manual changes in Vault but it will leave <code>secrets</code> untouched.
So if you enabled a new secret engine manually (and it&rsquo;s not in Bank-Vaults configuration),
Bank-Vaults will not remove it.</p></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-7b0377a17f1d979bab6eaef8dfe186a0">2.2 - Audit devices</h1><p>You can configure <a href="https://www.vaultproject.io/docs/audit/">Audit Devices in Vault</a> (File, Syslog, Socket).</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">audit</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">file</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">description</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;File based audit logging device&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">options</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">file_path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/tmp/vault.log</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-d415ff483df105bc7d627aa67e57a694">2.3 - Authentication</h1><p>You can configure <a href="https://www.vaultproject.io/docs/auth/index.html">Auth Methods in Vault</a>.</p><p>Currently the following auth methods are supported:</p><ul>
<li><a href="#auth-approle">AppRole</a></li><li><a href="#auth-aws">AWS</a></li><li><a href="#auth-azure">Azure</a></li><li><a href="#auth-gcp">GCP</a></li><li><a href="#auth-github">GitHub</a></li><li><a href="#auth-jwt">JWT</a></li><li><a href="#auth-kubernetes">Kubernetes</a></li><li><a href="#auth-ldap">LDAP</a></li></ul><h2 id="auth-approle">AppRole auth method</h2><p>Allow machines/apps to authenticate with Vault-defined roles. For details,
see the <a href="https://www.vaultproject.io/docs/auth/approle.html">official Vault documentation</a>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">auth</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">approle</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">secret_id_ttl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">token_num_uses</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">token_ttl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">20m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">token_max_ttl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">30m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">secret_id_num_uses</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">40</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="auth-aws">AWS auth method</h2><p>Creating roles in Vault which can be used for
<a href="https://www.vaultproject.io/docs/auth/aws.html">AWS IAM based authentication</a>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">auth</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Make the auth provider visible in the web ui</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># See https://www.vaultproject.io/api/system/auth.html#config for more</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># information.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">options</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">listing_visibility</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;unauth&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">access_key</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">VKIAJBRHKH6EVTTNXDHA</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">secret_key</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vCtSM8ZUEQ3mOFVlYPBQkf2sO6F/W7a5TVzrl3Oj</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">iam_server_id_header_value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-dev.example.com</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># consider setting this to the Vault server&#39;s DNS name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">crossaccountrole</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Add cross account number and role to assume in the cross account</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># https://www.vaultproject.io/api/auth/aws/index.html#create-sts-role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">sts_account</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">12345671234</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">sts_role</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">arn:aws:iam::12345671234:role/crossaccountrole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Add roles for AWS instances or principals</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># See https://www.vaultproject.io/api/auth/aws/index.html#create-role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dev-role-iam</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">bound_iam_principal_arn</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">arn:aws:iam::123456789012:role/dev-vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">period</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1h</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cross-account-role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">bound_iam_principal_arn</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">arn:aws:iam::12345671234:role/crossaccountrole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">period</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1h</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="auth-azure">Azure auth method</h2><p>The Azure auth method allows authentication against Vault using
<a href="https://www.vaultproject.io/docs/auth/azure.html">Azure Active Directory credentials</a> for more information.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">auth</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">azure</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">tenant_id</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">00000000-0000-0000-0000-000000000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">resource</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://vault-dev.example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">client_id</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">00000000-0000-0000-0000-000000000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">client_secret</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">00000000-0000-0000-0000-000000000000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Add roles for azure identities</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># See https://www.vaultproject.io/api/auth/azure/index.html#create-role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dev-mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">bound_subscription_ids</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#4e9a06">&#34;00000000-0000-0000-0000-000000000000&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">bound_service_principal_ids</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#4e9a06">&#34;00000000-0000-0000-0000-000000000000&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="auth-gcp">GCP auth method</h2><p>Create roles in Vault which can be used for
<a href="https://www.vaultproject.io/docs/auth/gcp.html">GCP IAM based authentication</a>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">auth</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcp</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Make the auth provider visible in the web ui</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># See https://www.vaultproject.io/api/system/auth.html#config for more</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># information.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">options</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">listing_visibility</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;unauth&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># Credentials context is service account&#39;s key. Can download when you create a key for service account. </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># No need to manually create it. Just paste the json context as multiline yaml.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">credentials</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#000;font-weight:700">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">        {
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">          &#34;type&#34;: &#34;service_account&#34;,
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">          &#34;project_id&#34;: &#34;PROJECT_ID&#34;,
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">          &#34;private_key_id&#34;: &#34;KEY_ID&#34;,
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">          &#34;private_key&#34;: &#34;-----BEGIN PRIVATE KEY-----.....-----END PRIVATE KEY-----\n&#34;,
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">          &#34;client_email&#34;: &#34;SERVICE_ACCOUNT@PROJECT_ID.iam.gserviceaccount.com&#34;,
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">          &#34;client_id&#34;: &#34;CLIENT_ID&#34;,
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">          &#34;auth_uri&#34;: &#34;https://accounts.google.com/o/oauth2/auth&#34;,
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">          &#34;token_uri&#34;: &#34;https://oauth2.googleapis.com/token&#34;,
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">          &#34;auth_provider_x509_cert_url&#34;: &#34;https://www.googleapis.com/oauth2/v1/certs&#34;,
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">          &#34;client_x509_cert_url&#34;: &#34;https://www.googleapis.com/robot/v1/metadata/x509/SERVICE_ACCOUNT%40PROJECT_ID.iam.gserviceaccount.com&#34;
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">        }</span><span style="color:#f8f8f8;text-decoration:underline">        
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Add roles for gcp service account</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># See https://www.vaultproject.io/api/auth/gcp/index.html#create-role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">user-role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">iam</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">project_id</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PROJECT_ID</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;readonly_secrets&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">bound_service_accounts</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;USER_SERVICE_ACCOUNT@PROJECT_ID.iam.gserviceaccount.com&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin-role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">iam</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">project_id</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PROJECT_ID</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;allow_secrets&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">bound_service_accounts</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;ADMIN_SERVICE_ACCOUNT@PROJECT_ID.iam.gserviceaccount.com&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="auth-github">GitHub auth method</h2><p>Create team mappings in Vault which can be used later on for the
<a href="https://www.vaultproject.io/docs/auth/github.html#configuration">GitHub authentication</a>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">auth</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">github</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Make the auth provider visible in the web ui</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># See https://www.vaultproject.io/api/system/auth.html#config for more</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># information.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">options</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">listing_visibility</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;unauth&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">organization</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">banzaicloud</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">map</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># Map the banzaicloud GitHub team on to the dev policy in Vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">teams</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">dev</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dev</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># Map my username (bonifaido) to the root policy in Vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">users</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">bonifaido</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="auth-jwt">JWT auth method</h2><p>Create roles in Vault which can be used for <a href="https://www.vaultproject.io/docs/auth/jwt.html">JWT-based authentication</a>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">auth</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">jwt</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">jwt</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">oidc_discovery_url</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://myco.auth0.com/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">role1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">bound_audiences</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">https://vault.plugin.auth.jwt.test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">user_claim</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://vault/user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">groups_claim</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://vault/groups</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">ttl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1h</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="auth-kubernetes">Kubernetes auth method</h2><p>Use the <a href="https://www.vaultproject.io/docs/auth/kubernetes.html">Kubernetes auth method</a> to authenticate with Vault
using a Kubernetes Service Account Token.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">auth</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># If you want to configure with specific kubernetes service account instead of default service account</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># https://www.vaultproject.io/docs/auth/kubernetes.html</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># config:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#   token_reviewer_jwt: eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9....</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#   kubernetes_ca_cert: |</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#     -----BEGIN CERTIFICATE-----</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#     ...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#     -----END CERTIFICATE-----</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#   kubernetes_host: https://192.168.64.42:8443</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Allows creating roles in Vault which can be used later on for the Kubernetes based</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># authentication.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#  See https://www.vaultproject.io/docs/auth/kubernetes.html#creating-a-role for</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># more information.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># Allow every pod in the default namespace to use the secret kv store</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">bound_service_account_names</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">bound_service_account_namespaces</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">ttl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1h</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="auth-ldap">LDAP auth method</h2><p>Create group mappings in Vault which can be used for
<a href="https://www.vaultproject.io/docs/auth/ldap.html#configuration">LDAP based authentication</a>.</p><ul>
<li>To start an LDAP test server, run: <strong>docker run -it &ndash;rm -p 389:389 -e LDAP_TLS=false &ndash;name ldap osixia/openldap</strong></li><li>To start an LDAP admin server, run: <strong>docker run -it &ndash;rm -p 6443:443 &ndash;link ldap:ldap -e PHPLDAPADMIN_LDAP_HOSTS=ldap -e PHPLDAPADMIN_LDAP_CLIENT_TLS=false osixia/phpldapadmin</strong></li></ul><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">auth</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ldap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">description</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LDAP directory auth.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># add mount options</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># See https://www.vaultproject.io/api/system/auth.html#config for more</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># information.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">options</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">listing_visibility</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;unauth&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">url</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ldap://localhost</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">binddn</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;cn=admin,dc=example,dc=org&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">bindpass</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;admin&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">userattr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">uid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">userdn</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;ou=users,dc=example,dc=org&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">groupdn</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;ou=groups,dc=example,dc=org&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">groups</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># Map the banzaicloud dev team on GitHub to the dev policy in Vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">developers</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Map myself to the allow_secrets policy in Vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">users</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">bonifaido</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">groups</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">developers</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-dd6ac132712c4f14b6c23b0070f3a40d">2.4 - Plugins</h1><p>To register a new plugin in <a href="https://www.vaultproject.io/api/system/plugins-catalog.html">Vault&rsquo;s plugin catalog</a>,
set the <strong>plugin_directory</strong> option in the Vault server configuration to the directory where the plugin binary
is located. Also, for some plugins readOnlyRootFilesystem Pod Security Policy should be disabled to allow RPC
communication between plugin and Vault server via Unix socket. For details,
see the <a href="https://github.com/hashicorp/go-plugin/blob/master/docs/internals.md">Hashicorp Go plugin documentation</a>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">plugins</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">plugin_name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ethereum-plugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">command</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ethereum-vault-plugin --ca-cert=/vault/tls/client/ca.crt --client-cert=/vault/tls/server/server.crt --client-key=/vault/tls/server/server.key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">sha256</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">62fb461a8743f2a0af31d998074b58bb1a589ec1d28da3a2a5e8e5820d2c6e0a</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-b5d102db99ba7e0768287ca2964300cd">2.5 - Policies</h1><p>You can create policies in Vault, and later use these policies in roles for the
<a href="/docs/external-configuration/authentication/">Kubernetes-based authentication</a>. For details,
see <a href="https://www.vaultproject.io/docs/concepts/policies.html">Policies in the official Vault documentation</a>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">rules</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path &#34;secret/*&#34; {</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">capabilities = [&#34;create&#34;, &#34;read&#34;, &#34;update&#34;, &#34;delete&#34;, &#34;list&#34;]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">           </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">readonly_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">rules</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path &#34;secret/*&#34; {</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">capabilities = [&#34;read&#34;, &#34;list&#34;]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">           </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-f5287e0cb4088762a08b3f7997b16b8f">2.6 - Secrets engines</h1><p>You can configure <a href="https://www.vaultproject.io/docs/secrets/index.html">Secrets Engines in Vault</a>.
The Key-Value, Database, and SSH values are tested, but the configuration is free form, so probably others work as well.</p><h2 id="aws">AWS</h2><p>The <a href="https://www.vaultproject.io/docs/secrets/aws/index.html">AWS secrets engine</a> generates AWS access credentials
dynamically based on IAM policies.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">secrets</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">description</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS Secret Backend</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">configuration</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">access_key</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${env `AWS_ACCESS_KEY_ID`}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">secret_key</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${env `AWS_SECRET_ACCESS_KEY`}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">region</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">us-east-1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">credential_type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">iam_user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">policy_arns</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">arn-of-policy</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my-aws-role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="database">Database</h2><p>This plugin stores database credentials dynamically based on configured roles for the
<a href="https://www.vaultproject.io/docs/secrets/databases/mysql-maria.html">MySQL/MariaDB database</a>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">secrets</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">database</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">description</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MySQL Database secret engine.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">configuration</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my-mysql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">plugin_name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;mysql-database-plugin&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">connection_url</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{{username}}:{{password}}@tcp(127.0.0.1:3306)/&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">allowed_roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">[</span><span style="color:#000">pipeline]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">username</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${env `ROOT_USERNAME`}&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Example how to read environment variables</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">password</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${env `ROOT_PASSWORD`}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pipeline</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">db_name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my-mysql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">creation_statements</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;GRANT ALL ON *.* TO &#39;{{name}}&#39;@&#39;%&#39; IDENTIFIED BY &#39;{{password}}&#39;;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">default_ttl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;10m&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">max_ttl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;24h&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="identity-groups">Identity Groups</h2><p>Allows you to configure <a href="https://www.vaultproject.io/docs/secrets/identity#identity-groups">identity groups</a>.</p><blockquote>
<p>Note:</p><p>Only external groups are supported at the moment through the use of group-aliases.
For supported authentication backends (for example JWT, which automatically matches those aliases
to groups returned by the backend) the configuration files for the groups and group-aliases
need to be parsed after the authentication backend has been mounted. Ideally they should be in the same file
to avoid of errors.</p></blockquote><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">groups</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">admin</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">priviliged</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">external</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">group-aliases</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">mountpath</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">jwt</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">group</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="key-values">Key-Values</h2><p>This plugin stores arbitrary secrets within the configured
<a href="https://www.vaultproject.io/docs/secrets/kv/index.html">physical storage for Vault</a>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">secrets</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kv</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">description</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">General secrets.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">options</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">version</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">configuration</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">max_versions</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="non-default-plugin-path">Non-default plugin path</h2><p>Mounts a non-default plugin&rsquo;s path.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ethereum-gateway</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">plugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">plugin_name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ethereum-plugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">description</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Immutability&#39;s Ethereum Wallet</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="pki">PKI</h2><p>The <a href="https://www.vaultproject.io/docs/secrets/pki/index.html">PKI secrets engine</a> generates X.509 certificates.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">secrets</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pki</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">description</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Vault PKI Backend</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">default_lease_ttl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">168h</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">max_lease_ttl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">720h</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">configuration</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">urls</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">issuing_certificates</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://vault.default:8200/v1/pki/ca</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">crl_distribution_points</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://vault.default:8200/v1/pki/crl</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">root/generate</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">internal</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">common_name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault.default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">allowed_domains</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">localhost,pod,svc,default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">allow_subdomains</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">generate_lease</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">ttl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">30m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="rabbitmq">RabbitMQ</h2><p>The <a href="https://www.vaultproject.io/docs/secrets/rabbitmq/index.html">RabbitMQ secrets engine</a>
generates user credentials dynamically based on configured permissions and virtual hosts.</p><p>To start a RabbitMQ test server, run: <strong>docker run -it &ndash;rm -p 15672:15672 rabbitmq:3.7-management-alpine</strong></p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">secrets</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rabbitmq</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">description</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">local-rabbit</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">configuration</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">connection</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">connection_uri</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;http://localhost:15672&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">username</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">guest</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">password</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">guest</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prod_role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">vhosts</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{&#34;/web&#34;:{&#34;write&#34;: &#34;production_.*&#34;, &#34;read&#34;: &#34;production_.*&#34;}}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="ssh">SSH</h2><p>Create a named Vault role for
<a href="https://www.vaultproject.io/docs/secrets/ssh/signed-ssh-certificates.html#client-key-signing">signing SSH client keys</a>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">secrets</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ssh</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ssh-client-signer</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">description</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SSH Client Key Signing.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">configuration</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ca</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">generate_signing_key</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my-role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">allow_user_certificates</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">allowed_users</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">key_type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;ca&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">default_user</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;ubuntu&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">ttl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;24h&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">default_extensions</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">permit-pty</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">permit-port-forwarding</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">permit-agent-forwarding</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-0458546c3492730ad7009f9eb9c2de19">2.7 - Startup secrets</h1><p>Allows writing some secrets to Vault (useful for development purposes). For details,
see the <a href="https://www.vaultproject.io/docs/secrets/kv/index.html">Key-Value secrets engine</a>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">startupSecrets</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kv</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">secret/data/accounts/aws</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">AWS_ACCESS_KEY_ID</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">secretId</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">AWS_SECRET_ACCESS_KEY</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">s3cr3t</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-c9bd3f4b41ab7ac382833f7bc4d42b14">3 - Environment variables</h1><p>Add environment variables. See the <a href="/docs/external-configuration/secrets-engines/">database secret engine</a> section for usage. Further information:</p><ul>
<li><a href="https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/">List of Kubernetes environment variables</a></li><li><a href="https://kubernetes.io/docs/concepts/configuration/secret/#using-secrets-as-environment-variables">Using secrets as environment variables</a></li></ul><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">envsConfig</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ROOT_USERNAME</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">valueFrom</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">secretKeyRef</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mysql-login</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">key</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ROOT_PASSWORD</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">valueFrom</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">secretKeyRef</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mysql-login</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">key</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">password</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-96c4ff43558e2f86011b50d22caa006c">4 - Operator</h1><p>The Vault operator builds on Bank-Vaults features such as:</p><ul>
<li>external, API based configuration (secret engines, auth methods, policies) to automatically re/configure a Vault cluster</li><li>automatic unsealing (AWS, GCE, Azure, Alibaba, Kubernetes Secrets (for dev purposes), Oracle)</li><li>TLS support</li></ul><p>The operator flow is the following:</p><p><img src="vaultoperator.png" alt="operator"></p><p>The source code can be found in the <a href="https://github.com/bank-vaults/bank-vaults/tree/master/operator">operator</a> directory.</p><p>The operator requires the following <a href="/docs/cloud-permissions/">cloud permissions</a>.</p><h2 id="deploy-operator">Deploy a local Vault operator</h2><p>This is the simplest scenario: you install the Vault operator on a simple cluster. The following commands install a single-node Vault instance that stores unseal and root tokens in Kubernetes secrets.</p><ol>
<li>
<p>Install the Bank-Vaults operator:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm repo add banzaicloud-stable https://kubernetes-charts.banzaicloud.com
</span></span><span style="display:flex"><span>helm upgrade --install vault-operator banzaicloud-stable/vault-operator
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>Release <span style="color:#4e9a06">&#34;vault-operator&#34;</span> does not exist. Installing it now.
</span></span><span style="display:flex"><span>NAME: vault-operator
</span></span><span style="display:flex"><span>LAST DEPLOYED: Fri Jul <span style="color:#0000cf;font-weight:700">14</span> 14:41:18 <span style="color:#0000cf;font-weight:700">2023</span>
</span></span><span style="display:flex"><span>NAMESPACE: default
</span></span><span style="display:flex"><span>STATUS: deployed
</span></span><span style="display:flex"><span>REVISION: <span style="color:#0000cf;font-weight:700">1</span>
</span></span><span style="display:flex"><span>TEST SUITE: None
</span></span></code></pre></div></li><li>
<p>Create a Vault instance using the Vault custom resources. This will create a Kubernetes <code>CustomResource</code> called <code>vault</code> and a PersistentVolumeClaim for it:</p><blockquote>
<p>Note: The following commands use a specific version of the CRs, because the current version is not yet working, as we are in the process of migrating the Bank-Vaults repositories.</p></blockquote><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/banzaicloud/bank-vaults/v1.15.3/operator/deploy/rbac.yaml
</span></span><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/banzaicloud/bank-vaults/v1.15.3/operator/deploy/cr.yaml
</span></span></code></pre></div></li><li>
<p>Wait a few seconds, then check the operator and the vault pods:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get pods
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>NAME                                                        READY     STATUS    RESTARTS   AGE
</span></span><span style="display:flex"><span>vault-0                                                     3/3       Running   <span style="color:#0000cf;font-weight:700">0</span>          10s
</span></span><span style="display:flex"><span>vault-configurer-6c545cb6b4-dmvb5                           1/1       Running   <span style="color:#0000cf;font-weight:700">0</span>          10s
</span></span><span style="display:flex"><span>vault-operator-788559bdc5-kgqkg                             1/1       Running   <span style="color:#0000cf;font-weight:700">0</span>          23s
</span></span></code></pre></div></li><li>
<p>Configure your Vault client to access the Vault instance running in the <em>vault-0</em> pod.</p><ol>
<li>
<p>Port-forward into the pod:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl port-forward vault-0 <span style="color:#0000cf;font-weight:700">8200</span> <span style="color:#000;font-weight:700">&amp;</span>
</span></span></code></pre></div></li><li>
<p>Set the address of the Vault instance.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#204a87">export</span> <span style="color:#000">VAULT_ADDR</span><span style="color:#ce5c00;font-weight:700">=</span>https://127.0.0.1:8200
</span></span></code></pre></div></li><li>
<p>Import the CA certificate of the Vault instance by running the following commands (otherwise, you&rsquo;ll get <em>x509: certificate signed by unknown authority</em> errors):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get secret vault-tls -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;{.data.ca\.crt}&#34;</span> <span style="color:#000;font-weight:700">|</span> base64 --decode &gt; <span style="color:#000">$PWD</span>/vault-ca.crt
</span></span><span style="display:flex"><span><span style="color:#204a87">export</span> <span style="color:#000">VAULT_CACERT</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#000">$PWD</span>/vault-ca.crt
</span></span></code></pre></div><p>Alternatively, you can instruct the Vault client to skip verifying the certificate of Vault by running: <code>export VAULT_SKIP_VERIFY=true</code></p></li><li>
<p>If you already have the <a href="https://developer.hashicorp.com/vault/downloads">Vault CLI installed</a>, check that you can access the Vault:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>vault status
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>Key             Value
</span></span><span style="display:flex"><span>---             -----
</span></span><span style="display:flex"><span>Seal Type       shamir
</span></span><span style="display:flex"><span>Initialized     <span style="color:#204a87">true</span>
</span></span><span style="display:flex"><span>Sealed          <span style="color:#204a87">false</span>
</span></span><span style="display:flex"><span>Total Shares    <span style="color:#0000cf;font-weight:700">5</span>
</span></span><span style="display:flex"><span>Threshold       <span style="color:#0000cf;font-weight:700">3</span>
</span></span><span style="display:flex"><span>Version         1.5.4
</span></span><span style="display:flex"><span>Cluster Name    vault-cluster-27ecd0e6
</span></span><span style="display:flex"><span>Cluster ID      ed5492f3-7ef3-c600-aef3-bd77897fd1e7
</span></span><span style="display:flex"><span>HA Enabled      <span style="color:#204a87">false</span>
</span></span></code></pre></div></li><li>
<p>To authenticate to Vault, you can access its root token by running:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#204a87">export</span> <span style="color:#000">VAULT_TOKEN</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#204a87;font-weight:700">$(</span>kubectl get secrets vault-unseal-keys -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:700">={</span>.data.vault-root<span style="color:#ce5c00;font-weight:700">}</span> <span style="color:#000;font-weight:700">|</span> base64 --decode<span style="color:#204a87;font-weight:700">)</span>
</span></span></code></pre></div><blockquote>
<p>Note: Using the root token is recommended only in test environments. In production environment, create dedicated, time-limited tokens.</p></blockquote></li><li>
<p>Now you can interact with Vault. For example, add a secret by running <code>vault kv put secret/demosecret/aws AWS_SECRET_ACCESS_KEY=s3cr3t</code>
If you want to access the Vault web interface, open <em>https://127.0.0.1:8200</em> in your browser using the root token (to reveal the token, run <code>echo $VAULT_TOKEN</code>).</p></li></ol></li></ol><p>For other configuration examples of the Vault CustomResource, see the YAML files in the <a href="https://github.com/bank-vaults/bank-vaults/tree/master/operator/deploy">operator/deploy directory of the project</a> (we use these for testing). After you are done experimenting with Bank-Vaults and you want to delete the operator, you can delete the related CRs:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl delete -f https://raw.githubusercontent.com/banzaicloud/bank-vaults/master/operator/deploy/rbac.yaml
</span></span><span style="display:flex"><span>kubectl delete -f https://raw.githubusercontent.com/banzaicloud/bank-vaults/master/operator/deploy/cr.yaml
</span></span></code></pre></div><h2 id="ha-setup-with-raft">HA setup with Raft</h2><p>In a production environment you want to run Vault as a cluster. The following CR creates a 3-node Vault instance that uses the Raft storage backend:</p><ol>
<li>
<p>Install the Bank-Vaults operator:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm repo add banzaicloud-stable https://kubernetes-charts.banzaicloud.com
</span></span><span style="display:flex"><span>helm upgrade --install vault-operator banzaicloud-stable/vault-operator
</span></span></code></pre></div></li><li>
<p>Create a Vault instance using the <code>cr-raft.yaml</code> custom resource. This will create a Kubernetes <code>CustomResource</code> called <code>vault</code> that uses the Raft backend:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/banzaicloud/bank-vaults/master/operator/deploy/rbac.yaml
</span></span><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/banzaicloud/bank-vaults/master/operator/deploy/cr-raft.yaml
</span></span></code></pre></div></li></ol><div class="warning-block">
<p><strong>CAUTION:</strong></p>Backing up the storage backend to prevent data loss, is not handled by the Vault operator. We recommend using <a href="/docs/backup/">Velero</a> for backups.
</div><h2 id="pod-anti-affinity">Pod anti-affinity</h2><p>If you want to setup pod anti-affinity, you can set <code>podAntiAffinity</code> vault with a topologyKey value.
For example, you can use <code>failure-domain.beta.kubernetes.io/zone</code> to force K8S deploy vault on multi AZ.</p><h2 id="delete-a-resource-created-by-the-operator">Delete a resource created by the operator</h2><p>If you manually delete a resource that the Bank-Vaults operator has created (for example, the Ingress resource), the operator automatically recreates it every 30 seconds. If it doesn&rsquo;t, then something went wrong, or the operator is not running. In this case, check the logs of the operator.</p></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-c02fa8fe03d0456a434494ea53489be6">4.1 - Running Vault with external end to end encryption</h1><p>This document assumes you have a working Kubernetes cluster which has a:</p><ul>
<li>Working install of Vault.</li><li>That you have a working knowledge of Kubernetes.</li><li>A working install of helm</li><li>A working knowledge of Kubernetes ingress</li><li>A valid external (<a href="https://www.example.com">www.example.com</a>) SSL certificate, verified by your provider as a Kubernetes secret.</li></ul><h2 id="background">Background</h2><p>The bank-vaults operator takes care of creating and maintaining internal cluster communications but if you wish to use your vault install
outside of your Kubernetes cluster what is the best way to maintain a secure state. Creating a standard Ingress object will reverse proxy
these requests to your vault instance but this is a hand off between the external SSL connection and the internal one. This might not be acceptable
under some circumstances, for example, if you have to adhere to strict security standards.</p><h2 id="workflow">Workflow</h2><p>Here we will create a separate TCP listener for vault using a custom SSL certificate on an external domain of your choosing. We will then
install a unique ingress-nginx controller allowing SSL pass through. SSL Pass through comes with a performance hit, so you would not use this
on a production website or ingress-controller that has a lot of traffic.</p><h2 id="install">Install</h2><h3 id="ingress-nginx">ingress-nginx</h3><p>values.yaml</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">controller</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">electionID</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-ingress-controller-leader</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">ingressClass</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx-vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">extraArgs</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">enable-ssl-passthrough</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">publishService</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">enabled</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">scope</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">enabled</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">replicaCount</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">affinity</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">podAntiAffinity</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">labelSelector</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">matchExpressions</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">key</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">release</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">operator</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">In</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">values</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">[</span><span style="color:#4e9a06">&#34;vault-ingress&#34;</span><span style="color:#000;font-weight:700">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">topologyKey</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes.io/hostname</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="install-nginx-ingress-via-helm">Install nginx-ingress via helm</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm install nginx-stable/nginx-ingress --name my-release -f values.yaml
</span></span></code></pre></div><h2 id="configuration">Configuration</h2><h3 id="ssl-secret-example">SSL Secret example:</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">tls.crt</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LS0tLS1......=</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">tls.key</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LS0tLS.......==</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">ssl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">tls</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wildcard.example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Opaque</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="cr-vault-config">CR Vault Config:</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault.banzaicloud.com/v1alpha1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">namespace</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">size</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">image</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault:1.1.2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">bankVaultsImage</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">banzaicloud/bank-vaults:0.4.16</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># A YAML representation of a final vault config file.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># See https://www.vaultproject.io/docs/configuration/ for more information.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">listener</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">tcp</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">address</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;0.0.0.0:8200&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">tls_cert_file</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/vault/tls/server.crt</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">tls_key_file</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/vault/tls/server.key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">tcp</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">address</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;0.0.0.0:8300&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">tls_cert_file</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/ingress-tls/tls.crt</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">tls_key_file</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/ingress-tls/tls.key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">api_addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://vault:8200</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">cluster_addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://vault:8201</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">ui</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="cr-service">CR Service:</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Specify the Service&#39;s type where the Vault Service is exposed</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">serviceType</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterIP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">servicePorts</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">api-port</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">8200</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">cluster-port</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">8201</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">ext-api-port</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">8300</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">ext-clu-port</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">8301</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="mount-the-secret-into-your-vault-pod">Mount the secret into your vault pod</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">volumes</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wildcard-ssl</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">secret</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">defaultMode</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">420</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">secretName</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wildcard.example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">volumeMounts</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wildcard-ssl</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">mountPath</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/ingress-tls</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="cr-ingress">CR Ingress:</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Request an Ingress controller with the default configuration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">ingress</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">annotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">kubernetes.io/ingress.allow-http</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;false&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">kubernetes.io/ingress.class</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;nginx-vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">nginx.ingress.kubernetes.io/force-ssl-redirect</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">nginx.ingress.kubernetes.io/ssl-passthrough</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">nginx.ingress.kubernetes.io/backend-protocol</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;HTTPS&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">nginx.ingress.kubernetes.io/whitelist-source-range</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">rules</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">host</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault.example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">http</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">paths</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#204a87;font-weight:700">path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:700">backend</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87;font-weight:700">serviceName</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87;font-weight:700">servicePort</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">8300</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-949e2eebfdc98439688db69b29ace521">4.2 - Using templates for injecting dynamic configuration</h1><h2 id="background">Background</h2><p>When configuring a <code>Vault</code> object via the <code>externalConfig</code> property, sometimes it&rsquo;s convenient (or necessary) to inject settings that are only known at runtime, for example:</p><ul>
<li>secrets that you don&rsquo;t want to store in source control</li><li>dynamic resources managed elsewhere</li><li>computations based on multiple values (string or arithmetic operations).</li></ul><p>For these cases, the operator supports parameterized templating. The <code>vault-configurer</code> component evaluates the templates and injects the rendered configuration into Vault.</p><p>This templating is based on <a href="https://golang.org/pkg/text/template/">Go templates</a>, extended by <a href="https://github.com/Masterminds/sprig">Sprig</a>, with some custom functions available specifically for bank-vaults (for example, to decrypt strings using the AWS Key Management Service or the Cloud Key Management Service of the Google Cloud Platform).</p><h2 id="using-templates">Using templates</h2><p>To avoid confusion and potential parsing errors (and interference with other templating tools like <a href="https://helm.sh/docs/chart_best_practices/templates/">Helm</a>), the templates don&rsquo;t use the default delimiters that Go templates use (<code>{{</code> and <code>}}</code>). Instead, use the following characters:</p><ul>
<li><strong>${</strong> for the left delimiter</li><li><strong>}</strong> for the right one.</li><li>To quote parameters being passed to functions, surround them with backticks (<strong>`</strong>) instead.</li></ul><p>For example, to call the <code>env</code> function, you can use this in your manifest:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">password</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${ env `MY_ENVIRONMENT_VARIABLE` }&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>In this case, <code>vault-configurer</code> evaluates the value of <code>MY_ENVIRONMENT_VARIABLE</code> at runtime (assuming it was properly injected), and sets the result as the value of the <code>password</code> field.</p><p>Note that you can also use <a href="#sprig-functions">Sprig functions</a> and <a href="#custom-functions">custom Kubernetes-related functions</a> in your templates.</p><p>For a detailed example, see the <a href="https://techblog.cisco.com/bank-vaults-templates#full-example">Using templates for injecting dynamic configuration in Vault</a> blog post.</p><h2 id="sprig-functions">Sprig functions</h2><p>In addition to the default functions in Go templates, you can also use <a href="http://masterminds.github.io/sprig/">Sprig functions</a> in your configuration.</p><div class="warning-block">
<p><strong>CAUTION:</strong></p>Use only functions that return a string, otherwise the generated configuration is invalid.
</div><h2 id="custom-functions">Custom functions</h2><p>To provide functionality that&rsquo;s more Kubernetes-friendly and cloud-native, bank-vaults provides a few additional functions not available in Sprig or Go. The functions and their parameters (in the order they should go in the function) are documented below.</p><h3 id="awskms"><code>awskms</code></h3><p>Takes a base64-encoded, KMS-encrypted string and returns the decrypted string. Additionally, the function takes an optional second parameter for any encryption context that might be required for decrypting. If any encryption context is required, the function will take any number of additional parameters, each of which should be a key-value pair (separated by a <code>=</code> character), corresponding to the full context.</p><blockquote>
<p>Note: This function assumes that the <code>vault-configurer</code> pod has the appropriate AWS IAM credentials and permissions to decrypt the given string. You can inject the AWS IAM credentials by using Kubernetes secrets as environment variables, an EC2 instance role, <a href="https://github.com/jtblin/kube2iam">kube2iam</a>, or <a href="/docs/cloud-permissions/#aws">EKS IAM roles</a>, and so on.</p></blockquote><table>
<thead>
<tr>
<th>Parameter</th><th>Type</th><th>Required</th></tr></thead><tbody>
<tr>
<td>encodedString</td><td>Base64-encoded string</td><td>Yes</td></tr><tr>
<td>encryptionContext</td><td>Variadic list of strings</td><td>No</td></tr></tbody></table><p>For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">password</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${ awskms (env `ENCRYPTED_DB_CREDS`) }&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>You can also nest functions in the template, for example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">password</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${ awskms (blob `s3://bank-vaults/encrypted/db-creds?region=eu-west-1`) }&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="gcpkms"><code>gcpkms</code></h3><p>Takes a base64-encoded string, encrypted with a Google Cloud Platform (GCP) symmetric key and returns the decrypted string.</p><blockquote>
<p>Note: This function assumes that the <code>vault-configurer</code> pod has the appropriate GCP IAM credentials and permissions to decrypt the given string. You can inject the GCP IAM credentials by using Kubernetes secrets as environment variables, or they can be acquired via a service account authentication, and so on.</p></blockquote><table>
<thead>
<tr>
<th>Parameter</th><th>Type</th><th>Required</th></tr></thead><tbody>
<tr>
<td>encodedString</td><td>Base64-encoded string</td><td>Yes</td></tr><tr>
<td>projectId</td><td>String</td><td>Yes</td></tr><tr>
<td>location</td><td>String</td><td>Yes</td></tr><tr>
<td>keyRing</td><td>String</td><td>Yes</td></tr><tr>
<td>key</td><td>String</td><td>Yes</td></tr></tbody></table><h3 id="blob"><code>blob</code></h3><p>Reads the content of a blob from disk (file) or from cloud blob storage services (object storage) at the given URL and returns it. This assumes that the path exists, and is readable by <code>vault-configurer</code>.</p><p>Valid values for the URL parameters are listed below, for more fine grained options check the documentation of the <a href="https://gocloud.dev/howto/blob/">underlying library</a>:</p><ul>
<li><code>file:///path/to/dir/file</code></li><li><code>s3://my-bucket/object?region=us-west-1</code></li><li><code>gs://my-bucket/object</code></li><li><code>azblob://my-container/blob</code></li></ul><blockquote>
<p>Note: This function assumes that the <code>vault-configurer</code> pod has the appropriate rights to access the given cloud service. For details, see the <a href="#awskms">awskms</a> and <a href="#gcpkms">gcpkms</a> functions.</p></blockquote><table>
<thead>
<tr>
<th>Parameter</th><th>Type</th><th>Required</th></tr></thead><tbody>
<tr>
<td>url</td><td>String</td><td>Yes</td></tr></tbody></table><p>For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">password</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${ blob `s3://bank-vaults/encrypted/db-creds?region=eu-west-1` }&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>You can also nest functions in the template, for example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">password</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${ awskms (blob `s3://bank-vaults/encrypted/db-creds?region=eu-west-1`) }&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="file"><code>file</code></h3><p>Reads the content of a file from disk at the given path and returns it. This assumes that the file exists, it&rsquo;s mounted, and readable by <code>vault-configurer</code>.</p><table>
<thead>
<tr>
<th>Parameter</th><th>Type</th><th>Required</th></tr></thead><tbody>
<tr>
<td>path</td><td>String</td><td>Yes</td></tr></tbody></table><h3 id="accessor"><code>accessor</code></h3><p>Looks up the accessor id of the given auth path and returns it. This function is only useful in policies that use <a href="https://www.vaultproject.io/docs/concepts/policies#templated-policies">templated policies</a>, to generalize the <code>&lt;mount accessor></code> field.</p><table>
<thead>
<tr>
<th>Parameter</th><th>Type</th><th>Required</th></tr></thead><tbody>
<tr>
<td>path</td><td>String</td><td>Yes</td></tr></tbody></table><p>For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">rules</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path &#34;secret/data/{{identity.entity.aliases.${ accessor `kubernetes/` }.metadata.service_account_namespace}}/*&#34; {</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">capabilities = [&#34;read&#34;]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">           </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-2886c2109e2b4def2a9fca4884615cf6">4.3 - Upgrade Vault with the Bank-Vaults operator</h1><p>To upgrade Vault using the Bank-Vaults operator, complete the following steps.</p><ol>
<li>Check the release notes of Vault for any special upgrade instructions. Usually there are no instructions, but it&rsquo;s better to be safe than sorry.</li><li><a href="https://github.com/bank-vaults/bank-vaults/blob/e83a577ddc5fc36f1756d17d8ff63a8ad02438f3/operator/deploy/cr.yaml#L7">Adjust the spec.image in field in the Vault custom resource</a>.</li><li>The Bank-Vaults operator updates the statefulset. (It does not take the HA leader into account in HA scenarios, but this has never caused any issues so far.)</li></ol></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-0bf9c9ceafec846263a56eeaff007d5f">4.4 - Operator Configuration for Functioning Webhook Secrets Mutation</h1><p>You can find several examples of the vault operator CR manifest in
<a href="https://github.com/bank-vaults/bank-vaults/blob/master/operator/deploy">the project repository</a>. The following examples use only this <a href="https://github.com/bank-vaults/bank-vaults/blob/master/operator/deploy/cr.yaml">vanilla CR</a>
to demonstrate some main points about how to properly configure the
operator for secrets mutations to function.</p><p>This document does not attempt to explain every possible scenario with respect to
the CRs in the aforementioned directory, but instead attempts to explain at
a high level the important aspects of the CR, so that you can determine how best to configure your operator.</p><h2 id="main-points">Main points</h2><p>Some important aspects of the operator and its configuration with respect to secrets
mutation are:</p><ul>
<li>The vault operator instantiates:
<ul>
<li>the vault configurer pod(s),</li><li>the vault pod(s),</li><li>the vault-secrets-webhook pod(s).</li></ul></li><li>The vault configurer:
<ul>
<li>unseals the vault,</li><li>configures vault with policies, roles, and so on.</li></ul></li><li>vault-secrets-webhook does nothing more than:
<ul>
<li>monitors cluster for resources with specific annotations for secrets injection, and</li><li>integrates with vault API to answer secrets requests from those resources for
requested secrets.</li><li>For pods using environment secrets, it injects a binary <code>vault-env</code> into pods
and updates ENTRYPOINT to run <code>vault-env CMD</code> instead of <code>CMD</code>.
<code>vault-env</code> intercepts requests for env secrets requests during runtime of
pod and upon such requests makes vault API call for requested secret
injecting secret into environment variable so <code>CMD</code> works with proper
secrets.</li></ul></li><li>Vault
<ul>
<li>the secrets workhorse</li><li>surfaces a RESTful API for secrets management</li></ul></li></ul><h2 id="cr-configuration-properties">CR configuration properties</h2><p>This section goes over some important properties of the CR and their purpose.</p><h3 id="vaults-service-account">Vault&rsquo;s service account</h3><p>This is the serviceaccount where Vault will be running. The Configurer runs
in the same namespace and should have the same service account. The operator
assigns this serviceaccount to Vault.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Specify the ServiceAccount where the Vault Pod and the Bank-Vaults configurer/unsealer is running</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">serviceAccount</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="canamespaces">caNamespaces</h3><p>In order for vault communication to be encrypted, valid TLS certificates need to
be used. The following property automatically creates TLS certificate secrets for
the namespaces specified here. Notice that this is a list, so you can
specify multiple namespaces per line, or use the splat or wildcard asterisk to
specify all namespaces:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Support for distributing the generated CA certificate Secret to other namespaces.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Define a list of namespaces or use [&#34;*&#34;] for all namespaces.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">caNamespaces</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="vault-config">Vault Config</h2><p>The following is simply a YAML representation (as the comment says) for the
Vault configuration you want to run. This is the configuration that vault
configurer uses to configure your running Vault:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># A YAML representation of a final vault config file.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">api_addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://vault:8200</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">cluster_addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://${.Env.POD_NAME}:8201</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">listener</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">tcp</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">address</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">0.0.0.0</span><span style="color:#000;font-weight:700">:</span><span style="color:#0000cf;font-weight:700">8200</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># Commenting the following line and deleting tls_cert_file and tls_key_file disables TLS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">tls_cert_file</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/vault/tls/server.crt</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">tls_key_file</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/vault/tls/server.key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">storage</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">file</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${ .Env.VAULT_STORAGE_FILE }&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">ui</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">credentialsConfig</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">secretName</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">etcdSize</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">etcdVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">externalConfig</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">rules</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path &#34;secret/*&#34; {</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">capabilities = [&#34;create&#34;, &#34;read&#34;, &#34;update&#34;, &#34;delete&#34;, &#34;list&#34;]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">auth</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># Allow every pod in the default namespace to use the secret kv store</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">bound_service_account_names</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">external-secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">dex</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">bound_service_account_namespaces</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">external-secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">dex</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">auth-system</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">loki</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">ttl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1h</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># Allow mutation of secrets using secrets-mutation annotation to use the secret kv store</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">secretsmutation</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">bound_service_account_names</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">vault-secrets-webhook</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">bound_service_account_namespaces</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">vault-secrets-webhook</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">ttl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1h</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="externalconfig">externalConfig</h3><p>The <code>externalConfig</code> portion of <strong>this CR example</strong> correlates to <a href="https://www.vaultproject.io/api/auth/kubernetes#configure-method">Kubernetes
configuration</a> as specified by <code>.auth[].type</code>.</p><p>This YAML representation of configuration is flexible enough to work with any
auth methods available to Vault as documented <a href="https://www.vaultproject.io/api/auth/kubernetes#configure-method">in the Vault documentation</a>.
For now, we&rsquo;ll stick with this kubernetes configuration.</p><h3 id="externalconfigpurgeunmanagedconfig">externalConfig.purgeUnmanagedConfig</h3><p>Delete any configuration that in Vault but not in <code>externalConfig</code>. For more details please check
<a href="/docs/external-configuration/purge-unmanaged-configuration/">Purge unmanaged configuration</a></p><h3 id="externalconfigpolicies">externalConfig.policies</h3><p>Correlates 1:1 to the creation of the specified policy in conjunction with <a href="https://www.vaultproject.io/api-docs/system/policy">Vault
policies</a>.</p><h3 id="externalconfigauthtype">externalConfig.auth[].type</h3><p><code>- type: kubernetes</code> - specifies to configure Vault to use <a href="https://www.vaultproject.io/api/auth/kubernetes#configure-method">Kubernetes
authentication</a></p><p><a href="https://www.vaultproject.io/api/auth">Other types</a> are yet to be documented with respect to the operator
configuration.</p><h3 id="externalconfigauthroles">externalConfig.auth[].roles[]</h3><p>Correlates to <a href="https://www.vaultproject.io/api/auth/kubernetes#create-role">Creating Kubernetes roles</a>. Some important nuances here are:</p><ul>
<li>Vault does not respect inline secrets serviceaccount annotations, so the
namespace of any serviceaccount annotations for secrets are irrelevant to
getting inline secrets mutations functioning.</li><li>Instead, the serviceaccount of the vault-secrets-webhook pod(s) should be
used to configure the <code>bound_service_account_names</code> and
<code>bound_service_account_namespaces</code> for inline secrets to mutate.</li><li>Pod serviceaccounts, however, are respected so
<code>bound_service_account_namespaces</code> and <code>bound_service_account_names</code> for
environment mutations must identify such of the running pods.</li></ul><blockquote>
<p>Note: There are two roles specified in the YAML example above: one for pods, and one for inline secrets mutations. While this was not strictly required, it makes for cleaner implementation.</p></blockquote></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-e5fbbbffbf0d95ae495ebd89ab145439">5 - Mutating Webhook</h1><h2 id="how-the-webhook-works---overview">How the webhook works - overview</h2><p>Kubernetes secrets are the standard way in which applications consume secrets and credentials on Kubernetes. Any secret that is securely stored in Vault and then unsealed for consumption eventually ends up as a Kubernetes secret. However, despite their name, Kubernetes secrets are not exactly secure, since they are only base64 encoded.</p><p>The mutating webhook of Bank-Vaults is a solution that bypasses the Kubernetes secrets mechanism and injects the secrets retrieved from Vault directly into the Pods. Specifically, the mutating admission webhook injects (in a very non-intrusive way) an executable into containers of Deployments and StatefulSets. This executable can request secrets from Vault through special environment variable definitions.</p><p><img src="/img/vault-mutating-webhook-revisited.gif" alt="Kubernetes API requests"></p><p>An important and unique aspect of the webhook is that it is a <em>daemonless</em> solution (although if you need it, you can <a href="/docs/mutating-webhook/deploy/#daemon-mode">deploy the webhook in daemon mode</a> as well).</p><h2 id="why-is-this-more-secure-than-using-kubernetes-secrets-or-any-other-custom-sidecar-container">Why is this more secure than using Kubernetes secrets or any other custom sidecar container?</h2><p>Our solution is particularly lightweight and uses only existing Kubernetes constructs like annotations and environment variables. No confidential data ever persists on the disk or in etcd - not even temporarily. All secrets are stored in memory, and are only visible to the process that requested them. Additionally, there is no persistent connection with Vault, and any Vault token used to read environment variables is flushed from memory before the application starts, in order to minimize attack surface.</p><p>If you want to make this solution even more robust, you can disable <em>kubectl exec</em>-ing in running containers. If you do so, no one will be able to hijack injected environment variables from a process.</p><p>The webhook checks if a container has environment variables defined in the following formats, and reads the values for those variables directly from Vault during startup time.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault:secret/data/accounts/aws#AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># or</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">valueFrom</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">secretKeyRef</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">key</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># or</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">valueFrom</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">configMapKeyRef</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-configmap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:700">key</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>The webhook checks if a container has <em>envFrom</em> and parses the defined ConfigMaps and Secrets:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">envFrom</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">secretRef</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># or</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">configMapRef</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-configmap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="secret-and-configmap-examples">Secret and ConfigMap examples</h2><p>Secrets require their payload to be base64 encoded, the API rejects manifests with plaintext in them.
The secret value should contain a base64 encoded template string referencing the vault path you want to insert.
Run <code>echo -n "vault:secret/data/accounts/aws#AWS_SECRET_ACCESS_KEY" | base64</code> to get the correct string.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">AWS_SECRET_ACCESS_KEY</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dmF1bHQ6c2VjcmV0L2RhdGEvYWNjb3VudHMvYXdzI0FXU19TRUNSRVRfQUNDRVNTX0tFWQ==</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Opaque</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ConfigMap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-configmap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">AWS_SECRET_ACCESSKEY</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault:secret/data/accounts/aws#AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>For further examples and use cases, see <a href="/docs/mutating-webhook/configuration/">Configuration examples and scenarios</a>.</p></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-ca011539082e4a0e051bd02ace83c3e5">5.1 - Deploy the webhook</h1><h2 id="deploy-the-mutating-webhook">Deploy the mutating webhook</h2><p>You can deploy the Vault Secrets Webhook using Helm. Note that:</p><ul>
<li>The Helm chart of the vault-secrets-webhook contains the templates of the required permissions as well.</li><li>The deployed RBAC objects contain the necessary permissions fo running the webhook.</li></ul><h3 id="prerequisites">Prerequisites</h3><ul>
<li>The user you use for deploying the chart to the Kubernetes cluster must have cluster-admin privileges.</li><li>The chart requires Helm 3.</li><li>To interact with Vault (for example, for testing), the <em>vault</em> command line client must be installed on your computer.</li><li>You have deployed Vault with the operator and configured your Vault client to access it, as described in <a href="/docs/installing/#deploy-operator">Deploy a local Vault operator</a>.</li></ul><h3 id="deploy-the-webhook">Deploy the webhook</h3><ol>
<li>
<p>Create a namespace for the webhook and add a label to the namespace, for example, <em>vault-infra</em>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl create namespace vault-infra
</span></span><span style="display:flex"><span>kubectl label namespace vault-infra <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:700">=</span>vault-infra
</span></span></code></pre></div></li><li>
<p>Deploy the vault-secrets-webhook chart:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm repo add banzaicloud-stable https://kubernetes-charts.banzaicloud.com
</span></span><span style="display:flex"><span>helm upgrade --namespace vault-infra --install vault-secrets-webhook banzaicloud-stable/vault-secrets-webhook
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>Release <span style="color:#4e9a06">&#34;vault-secrets-webhook&#34;</span> does not exist. Installing it now.
</span></span><span style="display:flex"><span>NAME: vault-secrets-webhook
</span></span><span style="display:flex"><span>LAST DEPLOYED: Fri Jul <span style="color:#0000cf;font-weight:700">14</span> 15:42:36 <span style="color:#0000cf;font-weight:700">2023</span>
</span></span><span style="display:flex"><span>NAMESPACE: vault-infra
</span></span><span style="display:flex"><span>STATUS: deployed
</span></span><span style="display:flex"><span>REVISION: <span style="color:#0000cf;font-weight:700">1</span>
</span></span><span style="display:flex"><span>TEST SUITE: None
</span></span></code></pre></div><p>For further details, see the <a href="https://github.com/bank-vaults/bank-vaults/tree/master/charts/vault-secrets-webhook">webhook&rsquo;s Helm chart repository</a>.</p></li><li>
<p>Check that the pods are running:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get pods --namespace vault-infra
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>NAME                                     READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex"><span>vault-secrets-webhook-58b97c8d6d-qfx8c   1/1     Running   <span style="color:#0000cf;font-weight:700">0</span>          22s
</span></span><span style="display:flex"><span>vault-secrets-webhook-58b97c8d6d-rthgd   1/1     Running   <span style="color:#0000cf;font-weight:700">0</span>          22s
</span></span></code></pre></div></li><li>
<p>If you already have the <a href="https://developer.hashicorp.com/vault/downloads">Vault CLI installed</a>, write a secret into Vault:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>vault kv put secret/demosecret/aws <span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#ce5c00;font-weight:700">=</span>s3cr3t
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>Key              Value
</span></span><span style="display:flex"><span>---              -----
</span></span><span style="display:flex"><span>created_time     2020-11-04T11:39:01.863988395Z
</span></span><span style="display:flex"><span>deletion_time    n/a
</span></span><span style="display:flex"><span>destroyed        <span style="color:#204a87">false</span>
</span></span><span style="display:flex"><span>version          <span style="color:#0000cf;font-weight:700">1</span>
</span></span></code></pre></div></li><li>
<p>Apply the following deployment to your cluster. The webhook will mutate this deployment because it has an environment variable having a value which is a reference to a path in Vault:</p><pre>
    <code class="language-yaml">kubectl create -f - &lt;&lt;EOF
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: vault-test
    spec:
      replicas: 1
      selector:
        matchLabels:
          app.kubernetes.io/name: vault
      template:
        metadata:
          labels:
            app.kubernetes.io/name: vault
          annotations:
            vault.security.banzaicloud.io/vault-addr: &#34;https://vault:8200&#34; # optional, the address of the Vault service, default values is https://vault:8200
            vault.security.banzaicloud.io/vault-role: &#34;default&#34; # optional, the default value is the name of the ServiceAccount the Pod runs in, in case of Secrets and ConfigMaps it is &#34;default&#34;
            vault.security.banzaicloud.io/vault-skip-verify: &#34;false&#34; # optional, skip TLS verification of the Vault server certificate
            vault.security.banzaicloud.io/vault-tls-secret: &#34;vault-tls&#34; # optional, the name of the Secret where the Vault CA cert is, if not defined it is not mounted
            vault.security.banzaicloud.io/vault-agent: &#34;false&#34; # optional, if true, a Vault Agent will be started to do Vault authentication, by default not needed and vault-env will do Kubernetes Service Account based Vault authentication
            vault.security.banzaicloud.io/vault-path: &#34;kubernetes&#34; # optional, the Kubernetes Auth mount path in Vault the default value is &#34;kubernetes&#34;
        spec:
          serviceAccountName: default
          containers:
          - name: alpine
            image: alpine
            command: [&#34;sh&#34;, &#34;-c&#34;, &#34;echo $AWS_SECRET_ACCESS_KEY &amp;&amp; echo going to sleep... &amp;&amp; sleep 10000&#34;]
            env:
            - name: AWS_SECRET_ACCESS_KEY
              value: vault:secret/data/demosecret/aws#AWS_SECRET_ACCESS_KEY
    EOF</code>
    </pre><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>deployment.apps/vault-test created
</span></span></code></pre></div></li><li>
<p>Check the mutated deployment.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl describe deployment vault-test
</span></span></code></pre></div><p>The output should look similar to the following:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">Name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#000">vault-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Namespace</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">CreationTimestamp</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">Wed, 04 Nov 2020 12:44:18 +0100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#000">&lt;none&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Annotations:            deployment.kubernetes.io/revision</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Selector</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#000">app.kubernetes.io/name=vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Replicas</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:700">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">desired | 1 updated | 1 total | 1 available | 0 unavailable</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">StrategyType</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#000">RollingUpdate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">MinReadySeconds</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:700">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">RollingUpdateStrategy</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#0000cf;font-weight:700">25</span><span style="color:#000">% max unavailable, 25% max surge</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Pod Template</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">Labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#000">app.kubernetes.io/name=vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">Annotations:      vault.security.banzaicloud.io/vault-addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://vault:8200</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-agent</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-role</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-skip-verify</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-tls-secret</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-tls</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">Service Account</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">Containers</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:700">alpine</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">Image</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">alpine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">Port</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">&lt;none&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">Host Port</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">&lt;none&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">Command</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">sh</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>-<span style="color:#000">c</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">echo $AWS_SECRET_ACCESS_KEY &amp;&amp; echo going to sleep... &amp;&amp; sleep 10000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">Environment</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">AWS_SECRET_ACCESS_KEY</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">vault:secret/data/demosecret/aws#AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">Mounts</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#000">&lt;none&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">Volumes</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">&lt;none&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Conditions</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Type           Status  Reason</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>---- <span style="color:#f8f8f8;text-decoration:underline">          </span>------ <span style="color:#f8f8f8;text-decoration:underline"> </span>------<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Available      True    MinimumReplicasAvailable</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Progressing    True    NewReplicaSetAvailable</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">OldReplicaSets</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">&lt;none&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">NewReplicaSet</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">vault-test-55c569f9 (1/1 replicas created)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Events</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Type    Reason             Age   From                   Message</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>---- <span style="color:#f8f8f8;text-decoration:underline">   </span>------ <span style="color:#f8f8f8;text-decoration:underline">            </span>---- <span style="color:#f8f8f8;text-decoration:underline"> </span>---- <span style="color:#f8f8f8;text-decoration:underline">                  </span>-------<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Normal  ScalingReplicaSet  29s   deployment-controller  Scaled up replica set vault-test-55c569f9 to 1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>As you can see, the original environment variables in the definition are unchanged, and the sensitive value of the AWS_SECRET_ACCESS_KEY variable is only visible within the alpine container.</p></li></ol><h2 id="deploy-the-webhook-from-a-private-registry">Deploy the webhook from a private registry</h2><p>If you are getting the <strong>x509: certificate signed by unknown authority app=vault-secrets-webhook</strong> error when the webhook is trying to download the manifest from a private image registry, you can:</p><ul>
<li>Build a docker image where the CA store of the OS layer of the image contains the CA certificate of the registry.</li><li>Alternatively, you can disable certificate verification for the registry by using the <strong>REGISTRY_SKIP_VERIFY=&ldquo;true&rdquo;</strong> environment variable in the deployment of the webhook.</li></ul><h2 id="daemon-mode">Deploy in daemon mode</h2><p><code>vault-env</code> by default replaces itself with the original process of the Pod after reading the secrets from Vault, but with the <code>vault.security.banzaicloud.io/vault-env-daemon: "true"</code> annotation this behavior can be changed. So <code>vault-env</code> can change to <code>daemon mode</code>, so <code>vault-env</code> starts the original process as a child process and remains in memory, and renews the lease of the requested Vault token and of the dynamic secrets (if requested any) until their final expiration time.</p><p>You can find a full example using MySQL dynamic secrets in the <a href="https://raw.githubusercontent.com/banzaicloud/bank-vaults/master/deploy/test-dynamic-env-vars.yaml">Bank-Vaults project repository</a>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Deploy MySQL first as the Vault storage backend and our application will request dynamic secrets for this database as well:</span>
</span></span><span style="display:flex"><span>helm upgrade --install mysql stable/mysql --set <span style="color:#000">mysqlRootPassword</span><span style="color:#ce5c00;font-weight:700">=</span>your-root-password --set <span style="color:#000">mysqlDatabase</span><span style="color:#ce5c00;font-weight:700">=</span>vault --set <span style="color:#000">mysqlUser</span><span style="color:#ce5c00;font-weight:700">=</span>vault --set <span style="color:#000">mysqlPassword</span><span style="color:#ce5c00;font-weight:700">=</span>secret --set <span style="color:#4e9a06">&#39;initializationFiles.app-db\.sql=CREATE DATABASE IF NOT EXISTS app;&#39;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Deploy the vault-operator and the vault-secerts-webhook</span>
</span></span><span style="display:flex"><span>kubectl create namespace vault-infra
</span></span><span style="display:flex"><span>kubectl label namespace vault-infra <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:700">=</span>vault-infra
</span></span><span style="display:flex"><span>helm upgrade --namespace vault-infra --install vault-operator banzaicloud-stable/vault-operator
</span></span><span style="display:flex"><span>helm upgrade --namespace vault-infra --install vault-secrets-webhook banzaicloud-stable/vault-secrets-webhook
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Create a Vault instance with MySQL storage and a configured dynamic database secrets backend</span>
</span></span><span style="display:flex"><span>kubectl apply -f operator/deploy/rbac.yaml
</span></span><span style="display:flex"><span>kubectl apply -f operator/deploy/cr-mysql-ha.yaml
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Deploy the example application requesting dynamic database credentials from the above Vault instance</span>
</span></span><span style="display:flex"><span>kubectl apply -f deploy/test-dynamic-env-vars.yaml
</span></span><span style="display:flex"><span>kubectl logs -f deployment/hello-secrets
</span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-2d9a764f72223def1f5372077db5d9d3">5.2 - Configuration examples and scenarios</h1><p>The following examples show you how to configure the mutating webhook to best suit your environment.</p><p>The webhook checks if a container has environment variables defined in the following formats, and reads the values for those variables directly from Vault during startup time.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault:secret/data/accounts/aws#AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># or</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">valueFrom</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">secretKeyRef</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">key</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># or</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">valueFrom</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">configMapKeyRef</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-configmap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:700">key</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>The webhook checks if a container has <em>envFrom</em> and parses the defined ConfigMaps and Secrets:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">envFrom</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">secretRef</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># or</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">configMapRef</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-configmap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="secret-and-configmap-examples">Secret and ConfigMap examples</h2><p>Secrets require their payload to be base64 encoded, the API rejects manifests with plaintext in them.
The secret value should contain a base64 encoded template string referencing the vault path you want to insert.
Run <code>echo -n "vault:secret/data/accounts/aws#AWS_SECRET_ACCESS_KEY" | base64</code> to get the correct string.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">AWS_SECRET_ACCESS_KEY</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dmF1bHQ6c2VjcmV0L2RhdGEvYWNjb3VudHMvYXdzI0FXU19TRUNSRVRfQUNDRVNTX0tFWQ==</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Opaque</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ConfigMap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-configmap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">AWS_SECRET_ACCESSKEY</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault:secret/data/accounts/aws#AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="prerequisites-for-inline-injection-to-work">Prerequisites for inline injection to work</h2><p>Vault needs to be properly configured for mutation to function; namely
<code>externalConfig.auth</code> and <code>externConfig.roles</code> (from the perspective of the
vault operator CR) need to be properly configured. If you&rsquo;re not using the vault
operator then you must make sure that your Vault configuration for <code>Kubernetes</code>
auth methods <a href="https://www.vaultproject.io/docs/auth/kubernetes">are properly configured</a>. This configuration is outside the scope
of this document. If you use the operator for managing Vault in your cluster, see the <a href="/docs/operator/">Vault operator documentation</a>.</p><h2 id="inject-secret-into-resources">Inject secret into resources</h2><p>The webhook can inject into any kind of resources, even into CRDs, for example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mysql.example.github.com/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MySQLCluster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;my-cluster&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">caBundle</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault:pki/cert/43138323834372136778363829719919055910246657114#ca&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="inline">Inline mutation</h2><p>The webhook also supports inline mutation when your secret needs to be replaced somewhere inside a string.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">config.yaml</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">foo</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bar</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">secret</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${vault:secret/data/mysecret#supersecret}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Opaque</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>This works also for ConfigMap resources when <code>configMapMutation: true</code> is set in the webhook&rsquo;s Helm chart.</p><p>You can specify the version of the injected Vault secret as well in the special reference, the format is: <code>vault:PATH#KEY_OR_TEMPLATE#VERSION</code></p><p>Example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault:secret/data/accounts/aws#AWS_SECRET_ACCESS_KEY#2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="define-multiple-inline-secrets-in-resources">Define multiple inline-secrets in resources</h2><p>You can also inject multiple secrets under the same key in a Secret/ConfigMap/Object. This means that you can use multiple Vault paths in a value, for example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ConfigMap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sample-configmap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">annotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;https://vault.default:8200&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-role</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-tls-secret</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-tls</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;kubernetes&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">aws-access-key-id</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault:secret/data/accounts/aws#AWS_ACCESS_KEY_ID&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">aws-access-template</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault:secret/data/accounts/aws#AWS key in base64: ${.AWS_ACCESS_KEY_ID | b64enc}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">aws-access-inline</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;AWS_ACCESS_KEY_ID: ${vault:secret/data/accounts/aws#AWS_ACCESS_KEY_ID} AWS_SECRET_ACCESS_KEY: ${vault:secret/data/accounts/aws#AWS_SECRET_ACCESS_KEY}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>This example also shows how a CA certificate (created by the operator) can be used with the <code>vault.security.banzaicloud.io/vault-tls-secret: vault-tls</code> annotation to validate the TLS connection in case of a non-Pod resource.</p><h2 id="request-a-vault-token">Request a Vault token</h2><p>There is a special <code>vault:login</code> reference format to request a working Vault token into an environment variable to be later consumed by your application:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">VAULT_TOKEN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault:login</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="read-a-value-from-vault">Read a value from Vault</h2><p>Values starting with <code>"vault:"</code> issue a <code>read</code> (HTTP GET) request towards the Vault API, this can be also used to request a <a href="https://www.vaultproject.io/docs/secrets/databases/mysql-maria.html#usage">dynamic database username/password pair for MySQL</a>:</p><p><em><strong>NOTE</strong>: This feature takes advantage of secret caching since we need to access the <code>my-role</code> endpoint twice, but in the background, it is written only once in Vault:</em></p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MYSQL_USERNAME</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault:database/creds/my-role#username&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MYSQL_PASSWORD</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault:database/creds/my-role#password&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REDIS_URI</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;redis://${vault:database/creds/my-role#username}:${vault:database/creds/my-role#password}@127.0.0.1:6739&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="write-a-value-into-vault">Write a value into Vault</h2><p>Values starting with <code>">>vault:"</code> issue a <code>write</code> (HTTP POST/PUT) request towards the Vault API, some secret engine APIs should be <code>written</code> instead of <code>reading from</code> like the <a href="https://github.com/sethvargo/vault-secrets-gen">Password Generator for HashiCorp Vault</a>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MY_SECRET_PASSWORD</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&gt;&gt;vault:gen/password#value&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Or with <a href="https://www.vaultproject.io/api-docs/secret/transit#decrypt-data">Transit Secret Engine</a> which is a fairly complex example since we are using templates when rendering the response and send data in the write request as well, the format is: <code>vault:PATH#KEY_OR_TEMPLATE#DATA</code></p><p>Example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MY_SECRET_PASSWORD</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&gt;&gt;vault:transit/decrypt/mykey#${.plaintext | b64dec}#{&#34;</span><span style="color:#000">ciphertext&#34;:&#34;vault:v1:/DupSiSbX/ATkGmKAmhqD0tvukByrx6gmps7dVI=&#34;}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="templating-in-values">Templating in values</h2><p><a href="https://golang.org/pkg/text/template/">Templating</a> is also supported on the secret sourced from Vault (in the key part, after the first <code>#</code>), in the very same fashion as in the Vault configuration and external configuration with all <a href="http://masterminds.github.io/sprig/">the Sprig functions</a> (this is supported only for Pods right now):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DOCKER_USERNAME</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault:secret/data/accounts/dockerhub#My username on DockerHub is: ${title .DOCKER_USERNAME}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>In this case, an init-container will be injected into the given Pod. This container copies the <code>vault-env</code> binary into an in-memory volume and mounts that Volume to every container which has an environment variable definition like that. It also changes the <code>command</code> of the container to run <code>vault-env</code> instead of your application directly. When <code>vault-env</code> starts up, it connects to Vault to checks the environment variables. (By default, <code>vault-env</code> uses the <a href="https://www.vaultproject.io/docs/auth/kubernetes.html">Kubernetes Auth method</a>, but you can also <a href="#webhook-auth">configure other authentication methods for the webhook</a>.) The variables that have a reference to a value stored in Vault (<code>vault:secret/....</code>) are replaced with that value read from the Secret backend. After this, <code>vault-env</code> immediately executes (with <code>syscall.Exec()</code>) your process with the given arguments, replacing itself with that process (in non-daemon mode).</p><p><strong>With this solution none of your Secrets stored in Vault will ever land in Kubernetes Secrets, thus in etcd.</strong></p><p><code>vault-env</code> was designed to work in Kubernetes in the first place, but nothing stops you to use it outside Kubernetes as well. It can be configured with the standard Vault client&rsquo;s <a href="https://www.vaultproject.io/docs/commands/#environment-variables">environment variables</a> (because there is a standard Go Vault client underneath).</p><p>Currently, the Kubernetes Service Account-based Vault authentication mechanism is used by <code>vault-env</code>, so it requests a Vault token based on the Service Account of the container it is injected into.</p><ul>
<li><a href="https://www.vaultproject.io/docs/auth/gcp">GCP</a> and general <a href="https://www.vaultproject.io/docs/auth/gcp">OIDC/JWT</a> authentication methods are supported as well, see the <a href="https://github.com/bank-vaults/bank-vaults/blob/master/deploy/test-deployment-gcp.yaml">example manifest</a>.</li><li>Kubernetes <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection">Projected Service Account Tokens</a> work too, as shown in <a href="https://github.com/bank-vaults/bank-vaults/blob/master/hack/oidc-pod.yaml">this example</a>.</li></ul><p>Kubernetes 1.12 introduced a feature called <a href="https://kubernetes.io/blog/2019/01/14/apiserver-dry-run-and-kubectl-diff/">APIServer dry-run</a> which became beta as of 1.13. This feature requires some changes in webhooks with side effects. Vault mutating admission webhook is <code>dry-run aware</code>.</p><h2 id="mutate-data-from-vault-and-replace-it-in-kubernetes-secret">Mutate data from Vault and replace it in Kubernetes Secret</h2><p>You can mutate Secrets (and ConfigMaps) as well if you set annotations and define proper Vault path in the <code>data</code> section:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sample-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">annotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;https://vault.default.svc.cluster.local:8200&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-role</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-skip-verify</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;kubernetes&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes.io/dockerconfigjson</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">.dockerconfigjson</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">eyJhdXRocyI6eyJodHRwczovL2RvY2tlci5pbyI6eyJ1c2VybmFtZSI6InZhdWx0OnNlY3JldC9kYXRhL2RvY2tlcnJlcG8vI0RPQ0tFUl9SRVBPX1VTRVIiLCJwYXNzd29yZCI6InZhdWx0OnNlY3JldC9kYXRhL2RvY2tlcnJlcG8vI0RPQ0tFUl9SRVBPX1BBU1NXT1JEIiwiYXV0aCI6ImRtRjFiSFE2YzJWamNtVjBMMlJoZEdFdlpHOWphMlZ5Y21Wd2J5OGpSRTlEUzBWU1gxSkZVRTlmVlZORlVqcDJZWFZzZERwelpXTnlaWFF2WkdGMFlTOWtiMk5yWlhKeVpYQnZMeU5FVDBOTFJWSmZVa1ZRVDE5UVFWTlRWMDlTUkE9PSJ9fX0=</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>In the example above the secret type is <code>kubernetes.io/dockerconfigjson</code> and the webhook can get credentials from Vault.
The base64 encoded data contain vault path in case of username and password for docker repository and you can create it with commands:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl create secret docker-registry dockerhub --docker-username<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;vault:secret/data/dockerrepo#DOCKER_REPO_USER&#34;</span> --docker-password<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;vault:secret/data/dockerrepo#DOCKER_REPO_PASSWORD&#34;</span>
</span></span><span style="display:flex"><span>kubectl annotate secret dockerhub vault.security.banzaicloud.io/vault-addr<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;https://vault.default.svc.cluster.local:8200&#34;</span>
</span></span><span style="display:flex"><span>kubectl annotate secret dockerhub vault.security.banzaicloud.io/vault-role<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;default&#34;</span>
</span></span><span style="display:flex"><span>kubectl annotate secret dockerhub vault.security.banzaicloud.io/vault-skip-verify<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;true&#34;</span>
</span></span><span style="display:flex"><span>kubectl annotate secret dockerhub vault.security.banzaicloud.io/vault-path<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;kubernetes&#34;</span>
</span></span></code></pre></div><h2 id="use-charts-without-explicit-containercommand-and-containerargs">Use charts without explicit container.command and container.args</h2><p>The Webhook can determine the container&rsquo;s <code>ENTRYPOINT</code> and <code>CMD</code> with the help of image metadata queried from the image registry. This data is cached until the webhook Pod is restarted. If the registry is publicly accessible (without authentication) you don&rsquo;t need to do anything, but if the registry requires authentication the credentials have to be available in the Pod&rsquo;s <code>imagePullSecrets</code> section.</p><p>Some examples (apply <code>cr.yaml</code> from the operator samples first):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm upgrade --install mysql stable/mysql <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>  --set <span style="color:#000">mysqlRootPassword</span><span style="color:#ce5c00;font-weight:700">=</span>vault:secret/data/mysql#MYSQL_ROOT_PASSWORD <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>  --set <span style="color:#000">mysqlPassword</span><span style="color:#ce5c00;font-weight:700">=</span>vault:secret/data/mysql#MYSQL_PASSWORD <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>  --set <span style="color:#4e9a06">&#34;podAnnotations.vault\.security\.banzaicloud\.io/vault-addr&#34;</span><span style="color:#ce5c00;font-weight:700">=</span>https://vault:8200 <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>  --set <span style="color:#4e9a06">&#34;podAnnotations.vault\.security\.banzaicloud\.io/vault-tls-secret&#34;</span><span style="color:#ce5c00;font-weight:700">=</span>vault-tls
</span></span></code></pre></div><h2 id="registry-access">Registry access</h2><p>You can also specify a default secret being used by the webhook for cases where a pod has no <code>imagePullSecrets</code> specified. To make this work you have to set the environment variables <code>DEFAULT_IMAGE_PULL_SECRET</code> and <code>DEFAULT_IMAGE_PULL_SECRET_NAMESPACE</code> when deploying the vault-secrets-webhook. Have a look at the values.yaml of the
<a href="https://github.com/bank-vaults/bank-vaults/blob/master/charts/vault-secrets-webhook/values.yaml">vault-secrets-webhook</a> helm chart to see how this is done.</p><blockquote>
<p>Note:</p><ul>
<li>If your EC2 nodes have the ECR instance role, the webhook can request an ECR access token through that role automatically, instead of an explicit <code>imagePullSecret</code></li><li>If your workload is running on GCP nodes, the webhook automatically authenticates to GCR.</li></ul></blockquote><p>Future improvements:</p><ul>
<li>on Azure/Alibaba get a credential dynamically with the specific SDK (for AWS ECR and GCP GCR this is already done)</li></ul><h3 id="using-a-private-image-repository">Using a private image repository</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Docker Hub</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>kubectl create secret docker-registry dockerhub --docker-username<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">${</span><span style="color:#000">DOCKER_USERNAME</span><span style="color:#4e9a06">}</span> --docker-password<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#000">$DOCKER_PASSWORD</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>helm upgrade --install mysql stable/mysql --set <span style="color:#000">mysqlRootPassword</span><span style="color:#ce5c00;font-weight:700">=</span>vault:secret/data/mysql#MYSQL_ROOT_PASSWORD --set <span style="color:#4e9a06">&#34;imagePullSecrets[0].name=dockerhub&#34;</span> --set-string <span style="color:#4e9a06">&#34;podAnnotations.vault\.security\.banzaicloud\.io/vault-skip-verify=true&#34;</span> --set <span style="color:#000">image</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;private-repo/mysql&#34;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># GCR</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>kubectl create secret docker-registry gcr <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>--docker-server<span style="color:#ce5c00;font-weight:700">=</span>gcr.io <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>--docker-username<span style="color:#ce5c00;font-weight:700">=</span>_json_key <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>--docker-password<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:700">$(</span>cat ~/json-key-file.json<span style="color:#204a87;font-weight:700">)</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>helm upgrade --install mysql stable/mysql --set <span style="color:#000">mysqlRootPassword</span><span style="color:#ce5c00;font-weight:700">=</span>vault:secret/data/mysql#MYSQL_ROOT_PASSWORD --set <span style="color:#4e9a06">&#34;imagePullSecrets[0].name=gcr&#34;</span> --set-string <span style="color:#4e9a06">&#34;podAnnotations.vault\.security\.banzaicloud\.io/vault-skip-verify=true&#34;</span> --set <span style="color:#000">image</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;gcr.io/your-repo/mysql&#34;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># ECR</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#000">TOKEN</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">`</span>aws ecr --region<span style="color:#ce5c00;font-weight:700">=</span>eu-west-1 get-authorization-token --output text --query authorizationData<span style="color:#ce5c00;font-weight:700">[]</span>.authorizationToken <span style="color:#000;font-weight:700">|</span> base64 --decode <span style="color:#000;font-weight:700">|</span> cut -d: -f2<span style="color:#4e9a06">`</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>kubectl create secret docker-registry ecr <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span> --docker-server<span style="color:#ce5c00;font-weight:700">=</span>https://171832738826.dkr.ecr.eu-west-1.amazonaws.com <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span> --docker-username<span style="color:#ce5c00;font-weight:700">=</span>AWS <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span> --docker-password<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">TOKEN</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span> helm upgrade --install mysql stable/mysql --set <span style="color:#000">mysqlRootPassword</span><span style="color:#ce5c00;font-weight:700">=</span>vault:secret/data/mysql#MYSQL_ROOT_PASSWORD --set <span style="color:#4e9a06">&#34;imagePullSecrets[0].name=ecr&#34;</span> --set-string <span style="color:#4e9a06">&#34;podAnnotations.vault\.security\.banzaicloud\.io/vault-skip-verify=true&#34;</span> --set <span style="color:#000">image</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;171832738826.dkr.ecr.eu-west-1.amazonaws.com/mysql&#34;</span> --set-string <span style="color:#000">imageTag</span><span style="color:#ce5c00;font-weight:700">=</span>5.7
</span></span></code></pre></div><h2 id="mount-all-keys-from-vault-secret-to-env">Mount all keys from Vault secret to env</h2><p>This feature is very similar to Kubernetes&rsquo; standard <code>envFrom:</code> <a href="https://kubernetes.io/docs/concepts/configuration/secret/#use-case-as-container-environment-variables">construct</a>, but instead of a Kubernetes Secret/ConfigMap, all its keys are mounted from a Vault secret using the webhook and vault-env.</p><p>You can set the Vault secret to mount using the <code>vault.security.banzaicloud.io/vault-env-from-path</code> annotation.</p><p>Compared to the original environment variable definition in the Pod <code>env</code> construct, the only difference is that you won&rsquo;t see the actual environment variables in the definition, because they are dynamic, and are based on the contents of the Vault secret&rsquo;s, just like <code>envFrom:</code>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hello-secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">selector</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">matchLabels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hello-secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">template</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hello-secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">annotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;https://vault:8200&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-tls-secret</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-tls</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-env-from-path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;secret/data/accounts/aws&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">initContainers</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">init-ubuntu</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">image</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ubuntu</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">command</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">[</span><span style="color:#4e9a06">&#34;sh&#34;</span><span style="color:#000;font-weight:700">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;-c&#34;</span><span style="color:#000;font-weight:700">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;echo AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID &amp;&amp; echo initContainers ready&#34;</span><span style="color:#000;font-weight:700">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">containers</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">alpine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">image</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">alpine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">command</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">[</span><span style="color:#4e9a06">&#34;sh&#34;</span><span style="color:#000;font-weight:700">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;-c&#34;</span><span style="color:#000;font-weight:700">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;echo AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY &amp;&amp; echo going to sleep... &amp;&amp; sleep 10000&#34;</span><span style="color:#000;font-weight:700">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="webhook-auth">Authenticate the webhook to Vault</h2><p>By default, the webhook uses Kubernetes <a href="https://www.vaultproject.io/docs/auth/kubernetes">ServiceAccount-based authentication</a> in Vault. Use the <code>vault.security.banzaicloud.io/vault-auth-method</code> annotation to request different authentication types from the following supported types: <strong>&ldquo;kubernetes&rdquo;, &ldquo;aws-ec2&rdquo;, &ldquo;gcp-gce&rdquo;, &ldquo;gcp-iam&rdquo;, &ldquo;jwt&rdquo;, &ldquo;azure&rdquo;</strong>.</p><blockquote>
<p>Note: GCP IAM authentication (<strong>gcp-iam</strong>) only allows for authentication with the &lsquo;default&rsquo; service account of the caller, and a new token is generated at every request.
Note: Azure MSI authentication (<strong>azure</strong>) a new token is generated at every request.</p></blockquote><p>The following deployment - if running on a GCP instance - will automatically receive a signed JWT token from the metadata server of the cloud provider, and use it to authenticate against Vault. The same goes for <code>vault-auth-method: "aws-ec2"</code>, when running on an EC2 node with the right instance-role.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-env-gcp-auth</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">selector</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">matchLabels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-env-gcp-auth</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">template</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-env-gcp-auth</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">annotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># These annotations enable Vault GCP GCE auth, see:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># https://www.vaultproject.io/docs/auth/gcp#gce-login</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;https://vault:8200&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-tls-secret</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-tls</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-role</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;my-role&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;gcp&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-auth-method</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;gcp-gce&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">containers</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">alpine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">image</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">alpine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">command</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#4e9a06">&#34;sh&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#4e9a06">&#34;-c&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#4e9a06">&#34;echo $MYSQL_PASSWORD &amp;&amp; echo going to sleep... &amp;&amp; sleep 10000&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MYSQL_PASSWORD</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault:secret/data/mysql#MYSQL_PASSWORD</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-3114defb3d9cb8776803617067a58907">5.3 - Annotations</h1><p>The mutating webhook adds the following PodSpec, Secret, ConfigMap, and CRD annotations.</p><table>
<thead>
<tr>
<th>Annotation</th><th>default</th><th>Explanation</th></tr></thead><tbody>
<tr>
<td><code>vault.security.banzaicloud.io/vault-addr</code></td><td><code>"https://vault:8200"</code></td><td>Same as VAULT_ADDR</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-image</code></td><td><code>"vault:latest"</code></td><td>Vault agent image</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-image-pull-policy</code></td><td><code>IfNotPresent</code></td><td>the Pull policy for the vault agent container</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-role</code></td><td><code>""</code></td><td>The Vault role for Vault agent to use, for Pods it is the name of the ServiceAccount if not specified</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-path</code></td><td><code>"kubernetes"</code></td><td>The mount path of the auth method</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-skip-verify</code></td><td><code>"false"</code></td><td>Same as VAULT_SKIP_VERIFY</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-tls-secret</code></td><td><code>""</code></td><td>Name of the Kubernetes Secret holding the CA certificate for Vault</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-ignore-missing-secrets</code></td><td><code>"false"</code></td><td>When enabled will only log warnings when Vault secrets are missing</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-env-passthrough</code></td><td><code>""</code></td><td>Comma separated list of <code>VAULT_*</code> related environment variables to pass through to <code>vault-env</code> to the main process. E.g. <code>VAULT_ADDR,VAULT_ROLE</code>.</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-env-daemon</code></td><td><code>"false"</code></td><td>Run <code>vault-env</code> as a daemon instead of replacing itself with the main process. For details, see /docs/mutating-webhook/deploy/#daemon-mode.</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-env-image</code></td><td><code>"banzaicloud/vault-env:latest"</code></td><td>vault-env image</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-env-image-pull-policy</code></td><td><code>IfNotPresent</code></td><td>the Pull policy for the vault-env container</td></tr><tr>
<td><code>vault.security.banzaicloud.io/enable-json-log</code></td><td><code>"false"</code></td><td>Log in JSON format in <code>vault-env</code></td></tr><tr>
<td><code>vault.security.banzaicloud.io/mutate</code></td><td><code>""</code></td><td>Defines the mutation of the given resource, possible values: <code>"skip"</code> which prevents it.</td></tr><tr>
<td><code>vault.security.banzaicloud.io/mutate-probes</code></td><td><code>"false"</code></td><td>Mutate the ENV passed to a liveness or readiness probe.</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-env-from-path</code></td><td><code>""</code></td><td>Comma-delimited list of vault paths to pull in all secrets as environment variables</td></tr><tr>
<td><code>vault.security.banzaicloud.io/token-auth-mount</code></td><td><code>""</code></td><td><code>{volume:file}</code> to be injected as <code>.vault-token</code>.</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-auth-method</code></td><td><code>"jwt"</code></td><td>The <a href="https://www.vaultproject.io/docs/auth">Vault authentication method</a> to be used, one of <code>["kubernetes", "aws-ec2", "aws-iam", "gcp-gce", "gcp-iam", "jwt", "azure", "namespaced"]</code></td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-serviceaccount</code></td><td><code>""</code></td><td>The ServiceAccount in the objects namespace to use, useful for non-pod resources</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-namespace</code></td><td><code>""</code></td><td>The <a href="https://www.vaultproject.io/docs/enterprise/namespaces">Vault Namespace</a> secrets will be pulled from. This annotation sets the <code>VAULT_NAMESPACE</code> environment variable. More information on <code>namespaces</code> within Vault can be found <a href="https://learn.hashicorp.com/tutorials/vault/namespaces">here</a></td></tr><tr>
<td><code>vault.security.banzaicloud.io/run-as-non-root</code></td><td><code>"false"</code></td><td>When enabled will add <code>runAsNonRoot: true</code> to the <code>securityContext</code> of all injected containers</td></tr><tr>
<td><code>vault.security.banzaicloud.io/run-as-user</code></td><td><code>"0"</code></td><td>Set the UID (<code>runAsUser</code>) for all injected containers. The default value of <code>"0"</code> means that no modifications will be made to the <code>securityContext</code> of injected containers.</td></tr><tr>
<td><code>vault.security.banzaicloud.io/run-as-group</code></td><td><code>"0"</code></td><td>Set the GID (<code>runAsGroup</code>) for all injected containers. The default value of <code>"0"</code> means that no modifications will be made to the <code>securityContext</code> of injected containers.</td></tr><tr>
<td><code>vault.security.banzaicloud.io/readonly-root-fs</code></td><td><code>"false"</code></td><td>When enabled will add <code>readOnlyRootFilesystem: true</code> to the <code>securityContext</code> of all injected containers</td></tr></tbody></table></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-b05dd7ba49df3a955b7908ff777f3a2b">5.4 - Using Vault Agent Templating in the mutating webhook</h1><p>With Bank-Vaults you can use <a href="https://www.vaultproject.io/docs/agent/">Vault Agent</a> to handle secrets that expire, and supply them to applications that read their configurations from a file.</p><h2 id="when-to-use-vault-agent">When to use vault-agent</h2><ul>
<li>You have an application or tool that requires to read its configuration from a file.</li><li>You wish to have secrets that have a TTL and expire.</li><li>You have no issues with running your application with a sidecar.</li></ul><blockquote>
<p>Note: If you need to revoke tokens, or use additional secret backends, see <a href="/docs/mutating-webhook/consul-template/">Using consul-template in the mutating webhook</a>.</p></blockquote><h2 id="workflow">Workflow</h2><ul>
<li>Your pod starts up, the webhook will inject one container into the pods lifecycle.</li><li>The sidecar container is running Vault, using the <a href="https://www.vaultproject.io/docs/agent/">vault agent</a> that accesses Vault using the configuration specified inside a configmap and writes a configuration file based on a pre configured template (written inside the same configmap) onto a temporary file system which your application can use.</li></ul><h2 id="prerequisites">Prerequisites</h2><p>This document assumes the following.</p><ul>
<li>
<p>You have a working Kubernetes cluster which has:</p><ul>
<li>a working Vault installation</li><li>a working installation of the <a href="/docs/mutating-webhook/">mutating webhook</a>.</li></ul></li><li>
<p>You have a working knowledge of Kubernetes.</p></li><li>
<p>You can apply Deployments or PodSpec&rsquo;s to the cluster.</p></li><li>
<p>You can change the configuration of the <a href="/docs/mutating-webhook/configuration/">mutating webhook</a>.</p></li></ul><h2 id="use-vault-ttls">Use Vault TTLs</h2><p>If you wish to use Vault TTLs, you need a way to HUP your application on configuration file change. You can <a href="https://www.vaultproject.io/docs/agent/template/index.html">configure the Vault Agent to execute a command</a> when it writes a new configuration file using the <code>command</code> attribute. The following is a basic example which uses the Kubernetes authentication method.</p><pre data-src="https://bank-vaults.dev/docs/mutating-webhook/vault-agent-templating-example.yaml" data-download-link data-download-link-label="Download this file">
</pre><h2 id="configuration">Configuration</h2><p>To configure the webhook, you can either:</p><ul>
<li>set some sane defaults in the <a href="#defaults">environment of the mutating webhook</a>, or</li><li>configure it via annotations in your <a href="#podspec">PodSpec</a>.</li></ul><h3 id="enable-vault-agent-in-the-webhook">Enable vault agent in the webhook</h3><p>For the webhook to detect that it will need to mutate or change a PodSpec, add the <code>vault.security.banzaicloud.io/vault-agent-configmap</code> annotation to the Deployment or PodSpec you want to mutate, otherwise it will be ignored for configuration with Vault Agent.</p><h3 id="defaults">Defaults via environment variables</h3><table>
<thead>
<tr>
<th>Variable</th><th>default</th><th>Explanation</th></tr></thead><tbody>
<tr>
<td>VAULT_IMAGE</td><td>vault:latest</td><td>the vault image to use for the sidecar container</td></tr><tr>
<td>VAULT_IMAGE_PULL_POLICY</td><td>IfNotPresent</td><td>The pull policy for the vault agent container</td></tr><tr>
<td>VAULT_ADDR</td><td>https://127.0.0.1:8200</td><td>Kubernetes service Vault endpoint URL</td></tr><tr>
<td>VAULT_TLS_SECRET</td><td>""</td><td>supply a secret with the vault TLS CA so TLS can be verified</td></tr><tr>
<td>VAULT_AGENT_SHARE_PROCESS_NAMESPACE</td><td>Kubernetes version &lt;1.12 default off, 1.12 or higher default on</td><td>ShareProcessNamespace override</td></tr></tbody></table><h3 id="podspec">PodSpec annotations</h3><table>
<thead>
<tr>
<th>Annotation</th><th>default</th><th>Explanation</th></tr></thead><tbody>
<tr>
<td>vault.security.banzaicloud.io/vault-addr</td><td>Same as VAULT_ADDR above</td><td></td></tr><tr>
<td>vault.security.banzaicloud.io/vault-tls-secret</td><td>Same as VAULT_TLS_SECRET above</td><td></td></tr><tr>
<td>vault.security.banzaicloud.io/vault-agent-configmap</td><td>""</td><td>A configmap name which holds the vault agent configuration</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-agent-once</td><td>false</td><td>do not run vault-agent in daemon mode, useful for kubernetes jobs</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-agent-share-process-namespace</td><td>Same as VAULT_AGENT_SHARE_PROCESS_NAMESPACE above</td><td></td></tr><tr>
<td>vault.security.banzaicloud.io/vault-agent-cpu</td><td>&ldquo;100m&rdquo;</td><td>Specify the vault-agent container CPU resource limit</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-agent-memory</td><td>&ldquo;128Mi&rdquo;</td><td>Specify the vault-agent container memory resource limit</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-configfile-path</td><td>&ldquo;/vault/secrets&rdquo;</td><td>Mount path of Vault Agent rendered files</td></tr></tbody></table></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-9ad4aac418ac0e1def9bf0c4bfe6b5f4">5.5 - Using consul-template in the mutating webhook</h1><p>With Bank-Vaults you can use <a href="https://github.com/hashicorp/consul-template">Consul Template</a> as an addition to vault-env to handle secrets that expire, and supply them to applications that read their configurations from a file.</p><h2 id="when-to-use-consul-template">When to use consul-template</h2><ul>
<li>You have an application or tool that must read its configuration from a file.</li><li>You wish to have secrets that have a TTL and expire.</li><li>You do not wish to be limited on which vault secrets backend you use.</li><li>You can also expire tokens/revoke tokens (to do this you need to have a ready/live probe that can send a HUP to consul-template when the current details fail).</li></ul><h2 id="workflow">Workflow</h2><p>The following shows the general workflow for using Consul Template:</p><ol>
<li>Your pod starts up. The webhook injects an init container (running vault agent) and a sidecar container (running consul-template) into the pods lifecycle.</li><li>The <a href="https://www.vaultproject.io/docs/agent/">vault agent</a> in the init container logs in to Vault and retrieves a Vault token based on the configured VAULT_ROLE and Kubernetes Service Account.</li><li>The consul-template running in the sidecar container logs in to Vault using the Vault token and writes a configuration file based on a pre-configured template in a configmap onto a temporary file system which your application can use.</li></ol><h2 id="prerequisites">Prerequisites</h2><p>This document assumes the following.</p><ul>
<li>
<p>You have a working Kubernetes cluster which has:</p><ul>
<li>a working Vault installation</li><li>a working installation of the <a href="/docs/mutating-webhook/">mutating webhook</a>.</li></ul></li><li>
<p>You have a working knowledge of Kubernetes.</p></li><li>
<p>You can apply Deployments or PodSpec&rsquo;s to the cluster.</p></li><li>
<p>You can change the configuration of the <a href="/docs/mutating-webhook/configuration/">mutating webhook</a>.</p></li></ul><h2 id="use-vault-ttls">Use Vault TTLs</h2><p>If you wish to use Vault TTLs, you need a way to HUP your application on configuration file change. You can <a href="https://github.com/hashicorp/consul-template#configuration-file-format">configure the Consul Template to execute a command</a> when it writes a new configuration file using the <code>command</code> attribute. The following is a basic example (adapted from <a href="https://github.com/sethvargo/vault-kubernetes-workshop/blob/master/k8s/db-sidecar.yaml#L79-L100">here</a>).</p><pre data-src="https://bank-vaults.dev/docs/mutating-webhook/consul-template-example.yaml" data-download-link data-download-link-label="Download this file">
</pre><h2 id="configuration">Configuration</h2><p>To configure the webhook, you can either:</p><ul>
<li>set some sane defaults in the <a href="#defaults">environment of the mutating webhook</a>, or</li><li>configure it via annotations in your <a href="#podspec">PodSpec</a>.</li></ul><h3 id="enable-consul-template-in-the-webhook">Enable Consul Template in the webhook</h3><p>For the webhook to detect that it will need to mutate or change a PodSpec, add the <code>vault.security.banzaicloud.io/vault-ct-configmap</code> annotation to the Deployment or PodSpec you want to mutate, otherwise it will be ignored for configuration with Consul Template.</p><h3 id="defaults">Defaults via environment variables</h3><table>
<thead>
<tr>
<th>Variable</th><th>default</th><th>Explanation</th></tr></thead><tbody>
<tr>
<td>VAULT_IMAGE</td><td>vault:latest</td><td>the vault image to use for the init container</td></tr><tr>
<td>VAULT_ENV_IMAGE</td><td>banzaicloud/vault-env:latest</td><td>the vault-env image to use</td></tr><tr>
<td>VAULT_CT_IMAGE</td><td>hashicorp/consul-template:latest</td><td>the consul template image to use</td></tr><tr>
<td>VAULT_ADDR</td><td>https://127.0.0.1:8200</td><td>Kubernetes service Vault endpoint URL</td></tr><tr>
<td>VAULT_SKIP_VERIFY</td><td>&ldquo;false&rdquo;</td><td>should vault agent and consul template skip verifying TLS</td></tr><tr>
<td>VAULT_TLS_SECRET</td><td>""</td><td>supply a secret with the vault TLS CA so TLS can be verified</td></tr><tr>
<td>VAULT_AGENT</td><td>&ldquo;true&rdquo;</td><td>enable the vault agent</td></tr><tr>
<td>VAULT_CT_SHARE_PROCESS_NAMESPACE</td><td>Kubernetes version &lt;1.12 default off, 1.12 or higher default on</td><td>ShareProcessNamespace override</td></tr></tbody></table><h3 id="podspec">PodSpec annotations</h3><table>
<thead>
<tr>
<th>Annotation</th><th>default</th><th>Explanation</th></tr></thead><tbody>
<tr>
<td>vault.security.banzaicloud.io/vault-addr</td><td>Same as VAULT_ADDR above</td><td></td></tr><tr>
<td>vault.security.banzaicloud.io/vault-role</td><td>default</td><td>The Vault role for Vault agent to use</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-path</td><td>auth/&lt;method type></td><td>The mount path of the method</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-skip-verify</td><td>Same as VAULT_SKIP_VERIFY above</td><td></td></tr><tr>
<td>vault.security.banzaicloud.io/vault-tls-secret</td><td>Same as VAULT_TLS_SECRET above</td><td></td></tr><tr>
<td>vault.security.banzaicloud.io/vault-agent</td><td>Same as VAULT_AGENT above</td><td></td></tr><tr>
<td>vault.security.banzaicloud.io/vault-ct-configmap</td><td>""</td><td>A configmap name which holds the consul template configuration</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-ct-image</td><td>""</td><td>Specify a custom image for consul template</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-ct-once</td><td>false</td><td>do not run consul-template in daemon mode, useful for kubernetes jobs</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-ct-pull-policy</td><td>IfNotPresent</td><td>the Pull policy for the consul template container</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-ct-share-process-namespace</td><td>Same as VAULT_CT_SHARE_PROCESS_NAMESPACE above</td><td></td></tr><tr>
<td>vault.security.banzaicloud.io/vault-ct-cpu</td><td>&ldquo;100m&rdquo;</td><td>Specify the consul-template container CPU resource limit</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-ct-memory</td><td>&ldquo;128Mi&rdquo;</td><td>Specify the consul-template container memory resource limit</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-ignore-missing-secrets</td><td>&ldquo;false&rdquo;</td><td>When enabled will only log warnings when Vault secrets are missing</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-env-passthrough</td><td>""</td><td>Comma seprated list of <code>VAULT_*</code> related environment variables to pass through to main process. E.g.<code>VAULT_ADDR,VAULT_ROLE</code>.</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-ct-secrets-mount-path</td><td>&ldquo;/vault/secret&rdquo;</td><td>Mount path of Consul template rendered files</td></tr></tbody></table></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-4fdd9c4aa5b4e731487b9967ac5afd93">5.6 - Transit Encryption</h1><p>The transit secrets engine handles cryptographic functions on data in-transit, mainly to encrypt data from applications while still storing that encrypted data in some primary data store. Vault doesn&rsquo;t store the data sent to the secrets engine, it can also be viewed as &ldquo;cryptography as a service&rdquo; or &ldquo;encryption as a service&rdquo;. For details about transit encryption, see the <a href="https://www.vaultproject.io/docs/secrets/transit/index.html">official documentation</a>.</p><blockquote>
<p>Note:</p><ul>
<li>Transit encryption supports only POD mutations.</li><li>You can also <a href="/docs/istio/">use Bank-Vaults with Istio</a>.</li></ul></blockquote><h2 id="enable-transit-secrets-engine">Enable Transit secrets engine</h2><p>To enable and test the Transit secrets engine, complete the following steps.</p><ol>
<li>
<p>Enable the Transit secrets engine:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>vault secrets <span style="color:#204a87">enable</span> transit
</span></span></code></pre></div></li><li>
<p>Create a named encryption key:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>vault write -f transit/keys/my-key
</span></span></code></pre></div></li><li>
<p>Encrypt data with encryption key:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>vault write transit/encrypt/my-key <span style="color:#000">plaintext</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#204a87;font-weight:700">$(</span>base64 <span style="color:#ce5c00;font-weight:700">&lt;&lt;&lt;</span> <span style="color:#4e9a06">&#34;my secret data&#34;</span><span style="color:#204a87;font-weight:700">)</span>
</span></span></code></pre></div></li><li>
<p>After completing the previous steps, the webhook will mutate pods that have at least one environment variable with a value which is encrypted by Vault. For example (in the last line of the example):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">replicas</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">selector</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">matchLabels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">template</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">annotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;https://vault:8200&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, the address of the Vault service, default values is https://vault:8200</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-role</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, the default value is the name of the ServiceAccount the Pod runs in, in case of Secrets and ConfigMaps it is &#34;default&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-skip-verify</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;false&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, skip TLS verification of the Vault server certificate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-tls-secret</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault-tls&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optinal, the name of the Secret where the Vault CA cert is, if not defined it is not mounted</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-agent</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;false&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, if true, a Vault Agent will be started to do Vault authentication, by default not needed and vault-env will do Kubernetes Service Account based Vault authentication</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;kubernetes&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, the Kubernetes Auth mount path in Vault the default value is &#34;kubernetes&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/transit-key-id</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;my-key&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># required if encrypted data was found; transit key id that created before</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">serviceAccountName</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">containers</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">alpine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">image</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">alpine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">command</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">[</span><span style="color:#4e9a06">&#34;sh&#34;</span><span style="color:#000;font-weight:700">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;-c&#34;</span><span style="color:#000;font-weight:700">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;echo $AWS_SECRET_ACCESS_KEY &amp;&amp; echo going to sleep... &amp;&amp; sleep 10000&#34;</span><span style="color:#000;font-weight:700">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># Value based on encrypted key that stored in Vault, so value from this example</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># not the same as you can get after `encrypt`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault:v1:8SDd3WHDOjf7mq69CyCqYjBXAiQQAVZRkFM13ok481zoCmHnSeDX9vyf7w==</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li></ol></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-789c03a017d516c224edcadf80386609">5.7 - Monitoring the Webhook with Grafana and Prometheus</h1><p>To monitor the webhook with Prometheus and Grafana, complete the following steps.</p><h2 id="prerequisites">Prerequisites</h2><ul>
<li>An already deployed and configured mutating webhook. For details, see <a href="/docs/mutating-webhook/">Mutating Webhook</a>.</li></ul><h2 id="steps">Steps</h2><ol>
<li>
<p>Install the Prometheus Operator Bundle:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/bundle.yaml
</span></span></code></pre></div></li><li>
<p>Install the webhook with monitoring and Prometheus Operator ServiceMonitor enabled:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm upgrade --wait --install vault-secrets-webhook <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    banzaicloud-stable/vault-secrets-webhook <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    --namespace vault-infra <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    --set metrics.enabled<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#204a87">true</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    --set metrics.serviceMonitor.enabled<span style="color:#ce5c00;font-weight:700">={}</span>
</span></span></code></pre></div></li><li>
<p>Create a Prometheus instance which monitors the components of Bank-Vaults:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/banzaicloud/bank-vaults/master/hack/prometheus.yaml
</span></span></code></pre></div></li><li>
<p>Create a Grafana instance and expose it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl create deployment grafana --image grafana/grafana
</span></span><span style="display:flex"><span>kubectl expose deployment grafana --port <span style="color:#0000cf;font-weight:700">3000</span> --type LoadBalancer
</span></span></code></pre></div></li><li>
<p>Fetch the external IP address of the Grafana instance, and open it in your browser on port 3000.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get service grafana
</span></span></code></pre></div></li><li>
<p><a href="https://prometheus.io/docs/visualization/grafana/#creating-a-prometheus-data-source">Create a Prometheus Data Source</a> in this Grafana instance which grabs data from http://prometheus-operated:9090/.</p></li><li>
<p><a href="https://prometheus.io/docs/visualization/grafana/#importing-pre-built-dashboards-from-grafana-com">Import</a> the <a href="https://grafana.com/grafana/dashboards/7088">Kubewebhook admission webhook dashboard</a> to Grafana (created by Xabier Larrakoetxea).</p></li><li>
<p>Select the previously created Data Source to feed this dashboard.</p></li></ol></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-d01053a982de9bc8c5063273f84aa47f">5.8 - Injecting consul-template into the Prometheus operator for Vault metrics</h1><p>To get vault metrics into Prometheus you need to log in to Vault to get access to a native Vault endpoint that provides the metrics.</p><h2 id="workflow">Workflow</h2><ol>
<li>The webhook injects <code>vault-agent</code> as an init container, based on the Kubernetes Auth role configuration <code>prometheus-operator-prometheus</code>.</li><li>The vault-agent grabs a token with the policy of <code>prometheus-operator-prometheus</code>.</li><li><code>consul-template</code> runs as a sidecar, and uses the token from the previous step to retrieve a new token using the Token Auth role <code>prometheus-metrics</code> which has the policy <code>prometheus-metrics</code> applied to it.</li><li>Prometheus can now use this second token to read the Vault Prometheus endpoint.</li></ol><p>The trick here is that Prometheus runs with the SecurityContext UID of 1000 but the default <code>consul-template</code> image is running under the UID of 100. This is because of a Dockerfile Volume that is configured which dockerd mounts as 100 (/consul-template/data).</p><p>Subsequently using this <code>consul-template</code> means it will never start, so we need to ensure we do not use this declared volume and change the UID using a custom Dockerfile and entrypoint.</p><h2 id="prerequisites">Prerequisites</h2><p>This document assumes you have a working Kubernetes cluster which has a:</p><ul>
<li>
<p>You have a working Kubernetes cluster which has:</p><ul>
<li>a working Vault installation</li><li>a working installation of the <a href="/docs/mutating-webhook/">mutating webhook</a>.</li></ul></li><li>
<p>You have the <a href="https://github.com/coreos/prometheus-operator">CoreOS Prometheus Operator</a> installed and working.</p></li><li>
<p>You have a working knowledge of Kubernetes.</p></li><li>
<p>You can apply Deployments or PodSpec&rsquo;s to the cluster.</p></li><li>
<p>You can change the configuration of the mutating webhook.</p></li></ul><h2 id="configuration">Configuration</h2><h3 id="custom-consul-template-image-docker-entrypointsh">Custom consul-template image; docker-entrypoint.sh</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">#!/bin/dumb-init /bin/sh
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">set</span> -ex
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Note above that we run dumb-init as PID 1 in order to reap zombie processes</span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># as well as forward signals to all processes in its session. Normally, sh</span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># wouldn&#39;t do either of these functions so we&#39;d leak zombies as well as do</span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># unclean termination of all our sub-processes.</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># CONSUL_DATA_DIR is exposed as a volume for possible persistent storage.</span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># CT_CONFIG_DIR isn&#39;t exposed as a volume but you can compose additional config</span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># files in there if you use this image as a base, or use CT_LOCAL_CONFIG below.</span>
</span></span><span style="display:flex"><span><span style="color:#000">CT_DATA_DIR</span><span style="color:#ce5c00;font-weight:700">=</span>/consul-template/config
</span></span><span style="display:flex"><span><span style="color:#000">CT_CONFIG_DIR</span><span style="color:#ce5c00;font-weight:700">=</span>/consul-template/config
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># You can also set the CT_LOCAL_CONFIG environment variable to pass some</span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Consul Template configuration JSON without having to bind any volumes.</span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">if</span> <span style="color:#ce5c00;font-weight:700">[</span> -n <span style="color:#4e9a06">&#34;</span><span style="color:#000">$CT_LOCAL_CONFIG</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:700">]</span><span style="color:#000;font-weight:700">;</span> <span style="color:#204a87;font-weight:700">then</span>
</span></span><span style="display:flex"><span>  <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$CT_LOCAL_CONFIG</span><span style="color:#4e9a06">&#34;</span> &gt; <span style="color:#4e9a06">&#34;</span><span style="color:#000">$CT_CONFIG_DIR</span><span style="color:#4e9a06">/local-config.hcl&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">fi</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># If the user is trying to run consul-template directly with some arguments, then</span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># pass them to consul-template.</span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">if</span> <span style="color:#ce5c00;font-weight:700">[</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">1</span><span style="color:#000;font-weight:700">:</span><span style="color:#000">0</span><span style="color:#000;font-weight:700">:</span><span style="color:#000">1</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#4e9a06">&#39;-&#39;</span> <span style="color:#ce5c00;font-weight:700">]</span><span style="color:#000;font-weight:700">;</span> <span style="color:#204a87;font-weight:700">then</span>
</span></span><span style="display:flex"><span>  <span style="color:#204a87">set</span> -- /bin/consul-template <span style="color:#4e9a06">&#34;</span><span style="color:#000">$@</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">fi</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># If we are running Consul, make sure it executes as the proper user.</span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">if</span> <span style="color:#ce5c00;font-weight:700">[</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$1</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#4e9a06">&#39;/bin/consul-template&#39;</span> <span style="color:#ce5c00;font-weight:700">]</span><span style="color:#000;font-weight:700">;</span> <span style="color:#204a87;font-weight:700">then</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>  <span style="color:#8f5902;font-style:italic"># Set the configuration directory</span>
</span></span><span style="display:flex"><span>  <span style="color:#204a87">shift</span>
</span></span><span style="display:flex"><span>  <span style="color:#204a87">set</span> -- /bin/consul-template <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    -config<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#000">$CT_CONFIG_DIR</span><span style="color:#4e9a06">&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    <span style="color:#4e9a06">&#34;</span><span style="color:#000">$@</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>  <span style="color:#8f5902;font-style:italic"># Check the user we are running as</span>
</span></span><span style="display:flex"><span>  <span style="color:#000">current_user</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:700">$(</span>id -un<span style="color:#204a87;font-weight:700">)</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex"><span>  <span style="color:#204a87;font-weight:700">if</span> <span style="color:#ce5c00;font-weight:700">[</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">current_user</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:700">==</span> <span style="color:#4e9a06">&#34;root&#34;</span> <span style="color:#ce5c00;font-weight:700">]</span><span style="color:#000;font-weight:700">;</span> <span style="color:#204a87;font-weight:700">then</span>
</span></span><span style="display:flex"><span>    <span style="color:#8f5902;font-style:italic"># Run under the right user</span>
</span></span><span style="display:flex"><span>    <span style="color:#204a87">set</span> -- gosu consul-template <span style="color:#4e9a06">&#34;</span><span style="color:#000">$@</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex"><span>  <span style="color:#204a87;font-weight:700">fi</span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">fi</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#204a87">exec</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$@</span><span style="color:#4e9a06">&#34;</span>
</span></span></code></pre></div><h3 id="dockerfile">Dockerfile</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">FROM</span><span style="color:#4e9a06"> hashicorp/consul-template:0.19.6-dev-alpine</span><span style="color:#a40000">
</span></span></span><span style="display:flex"><span><span style="color:#a40000">
</span></span></span><span style="display:flex"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:700">ADD</span> build/docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh<span style="color:#a40000">
</span></span></span><span style="display:flex"><span><span style="color:#a40000">
</span></span></span><span style="display:flex"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:700">RUN</span> apk --no-cache add shadow <span style="color:#ce5c00;font-weight:700">&amp;&amp;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    usermod -u <span style="color:#0000cf;font-weight:700">1000</span> consul-template <span style="color:#ce5c00;font-weight:700">&amp;&amp;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    chown -Rc consul-template:consul-template /consul-template/<span style="color:#a40000">
</span></span></span><span style="display:flex"><span><span style="color:#a40000">
</span></span></span><span style="display:flex"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:700">USER</span><span style="color:#4e9a06"> consul-template:consul-template</span><span style="color:#a40000">
</span></span></span></code></pre></div><h3 id="configmap">ConfigMap</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ConfigMap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">prometheus</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">consul-template</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-consul-template</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">config.hcl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">    vault {
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      ssl {
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">        ca_cert = &#34;/vault/tls/ca.crt&#34;
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      }
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      grace = &#34;5m&#34;
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      retry {
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">        backoff = &#34;1s&#34;
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      }
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">    }
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">    template {
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      destination = &#34;/vault/secrets/vault-token&#34;
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      command     = &#34;/bin/sh -c &#39;/usr/bin/curl -s http://127.0.0.1:9090/-/reload&#39;&#34;
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      contents = &lt;&lt;-EOH
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      {{with secret &#34;/auth/token/create/prometheus-metrics&#34; &#34;policy=prometheus-metrics&#34; }}{{.Auth.ClientToken}}{{ end }}
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      EOH
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      wait {
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">        min = &#34;2s&#34;
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">        max = &#34;60s&#34;
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      }
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">    }</span><span style="color:#f8f8f8;text-decoration:underline">    
</span></span></span></code></pre></div><h2 id="vault-cr-snippets">Vault CR snippets</h2><p>Set the vault image to use:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault.banzaicloud.com/v1alpha1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">size</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">image</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault:1.1.2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Our Vault config for telemetry:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># A YAML representation of a final vault config file.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># See https://www.vaultproject.io/docs/configuration/ for more information.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">telemetry</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">prometheus_retention_time</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">30s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">disable_hostname</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Disable statsd:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># since we are running Vault 1.1.0 with the native Prometheus support, we do not need the statsD exporter</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">statsdDisabled</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Vault externalConfig policies:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">externalConfig</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-operator-prometheus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">rules</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">          path &#34;auth/token/create/prometheus-metrics&#34; {
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">            capabilities = [&#34;read&#34;, &#34;update&#34;]
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">          }</span><span style="color:#f8f8f8;text-decoration:underline">          
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-metrics</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">rules</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path &#34;sys/metrics&#34; {</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">capabilities = [&#34;list&#34;, &#34;read&#34;]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>auth:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">auth</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">token</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-metrics</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">allowed_policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">prometheus-metrics</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">orphan</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-operator-prometheus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">bound_service_account_names</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-operator-prometheus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">bound_service_account_namespaces</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mynamespace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-operator-prometheus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">ttl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">4h</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="prometheus-operator-snippets">Prometheus Operator Snippets</h2><h3 id="prometheusspec">prometheusSpec</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">prometheusSpec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#prometheusspec</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">podMetadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">annotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-ct-configmap</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;prometheus-consul-template&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-role</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-operator-prometheus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-ct-image</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;mycustomimage:latest&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">secrets</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">etcd-client-tls</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">vault-tls</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="prometheus-crd-servicemonitor">Prometheus CRD ServiceMonitor</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitoring.coreos.com/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceMonitor</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/instance</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-operator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-operator-vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">endpoints</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">bearerTokenFile</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/vault/secrets/vault-token</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">interval</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">30s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">params</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">format</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">[</span><span style="color:#4e9a06">&#39;prometheus&#39;</span><span style="color:#000;font-weight:700">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/v1/sys/metrics</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">port</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">api-port</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">scheme</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">tlsConfig</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">caFile</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/prometheus/secrets/vault-tls/ca.crt</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">certFile</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/prometheus/secrets/vault-tls/server.crt</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">keyFile</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/prometheus/secrets/vault-tls/server.key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">insecureSkipVerify</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">selector</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">matchLabels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">vault_cr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-40ade858fb140e470d28b5c4d75ad0ef">5.9 - Comparison of Banzai Cloud and HashiCorp mutating webhook for Vault</h1><h4 id="legend">Legend</h4><ul>
<li>✅: Implemented</li><li>o: Planned/In-progress</li></ul><table>
<thead>
<tr>
<th>Feature</th><th>Banzai Cloud Webhook</th><th>HashiCorp Webhook</th></tr></thead><tbody>
<tr>
<td>Automated Vault and K8S setup</td><td>✅ (operator)</td><td></td></tr><tr>
<td>vault-agent/consul-template sidecar injection</td><td>✅</td><td>✅</td></tr><tr>
<td>Direct env var injection</td><td>✅</td><td></td></tr><tr>
<td>Injecting into K8S Secrets</td><td>✅</td><td></td></tr><tr>
<td>Injecting into K8S ConfigMaps</td><td>✅</td><td></td></tr><tr>
<td>Injecting into K8S CRDs</td><td>✅</td><td></td></tr><tr>
<td>Sidecar-less dynamic secrets</td><td>✅</td><td></td></tr><tr>
<td>CSI Driver</td><td>o</td><td></td></tr><tr>
<td>Native Kubernetes sidecar</td><td>o</td><td></td></tr></tbody></table></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-06a0154e4fe026f4982258ce9841854f">5.10 - Running the webhook and Vault on different clusters</h1><p>This section describes how to configure the webhook and Vault when the webhook runs on a different cluster from Vault, or if Vault runs outside Kubernetes.</p><p>Let&rsquo;s suppose you have two different K8S clusters:</p><ul>
<li><code>cluster1</code> contains <code>vault-operator</code></li><li><code>cluster2</code> contains <code>vault-secrets-webhook</code></li></ul><p>Basically, you have to grant <code>cluster2</code> access to the Vault running on <code>cluster1</code>. To achieve this, complete the following steps.</p><ol>
<li>
<p>Extract the <em>cluster.certificate-authority-data</em> and the <em>cluster.server</em> fields from your <code>cluster2</code> kubeconfig file. You will need them in the <code>externalConfig</code> section of the <code>cluster1</code> configuration. For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl config view -o yaml --minify<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#204a87">true</span> --raw<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#204a87">true</span>
</span></span></code></pre></div></li><li>
<p>Decode the certificate from the <em>cluster.certificate-authority-data</em> field, for example::</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>grep <span style="color:#4e9a06">&#39;certificate-authority-data&#39;</span> <span style="color:#000">$HOME</span>/.kube/config <span style="color:#000;font-weight:700">|</span> awk <span style="color:#4e9a06">&#39;{print $2}&#39;</span> <span style="color:#000;font-weight:700">|</span> base64 --decode
</span></span></code></pre></div></li><li>
<p>On <code>cluster2</code>, create a <code>vault</code> ServiceAccount and the <code>vault-auth-delegator</code> ClusterRoleBinding:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f https://github.com/bank-vaults/bank-vaults/raw/main/operator/deploy/rbac.yaml
</span></span></code></pre></div><p>You can use the <code>vault</code> ServiceAccount token as a <code>token_reviewer_jwt</code> in the auth configuration. To retrieve the token, run the following command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get secret <span style="color:#204a87;font-weight:700">$(</span>kubectl get sa vault -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#39;{.secrets[0].name}&#39;</span><span style="color:#204a87;font-weight:700">)</span> -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#39;{.data.token}&#39;</span> <span style="color:#000;font-weight:700">|</span> base64 --decode
</span></span></code></pre></div></li><li>
<p>In the <code>vault.banzaicloud.com</code> custom resource (for example, <a href="https://github.com/bank-vaults/bank-vaults/raw/main/operator/deploy/cr.yaml">https://github.com/bank-vaults/bank-vaults/raw/main/operator/deploy/cr.yaml</a>) of <code>cluster1</code>, define an <code>externalConfig</code> section. Fill the values of the <code>kubernetes_ca_cert</code>, <code>kubernetes_host</code>, and <code>token_reviewer_jwt</code> using the data collected in the previous steps.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">externalConfig</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">rules</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path &#34;secret/*&#34; {</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">capabilities = [&#34;create&#34;, &#34;read&#34;, &#34;update&#34;, &#34;delete&#34;, &#34;list&#34;]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">auth</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">token_reviewer_jwt</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;token-for-cluster2-service-account&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">kubernetes_ca_cert</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">            -----BEGIN CERTIFICATE-----
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">            &lt;certificate-from-certificate-authority-data-on-cluster2&gt;
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">            -----END CERTIFICATE-----</span><span style="color:#f8f8f8;text-decoration:underline">            
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">kubernetes_host</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;cluster.server-field-on-cluster2&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># Allow every pod in the default namespace to use the secret kv store</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">bound_service_account_names</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">[</span><span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#000;font-weight:700">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault-secrets-webhook&#34;</span><span style="color:#000;font-weight:700">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">bound_service_account_namespaces</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">[</span><span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#000;font-weight:700">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vswh&#34;</span><span style="color:#000;font-weight:700">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">ttl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1h</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li><li>
<p>In a production environment, it is highly recommended to specify TLS config for your Vault ingress.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Request an Ingress controller with the default configuration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">ingress</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Specify Ingress object annotations here, if TLS is enabled (which is by default)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># the operator will add NGINX, Traefik and HAProxy Ingress compatible annotations</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># to support TLS backends</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">annotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Override the default Ingress specification here</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># This follows the same format as the standard Kubernetes Ingress</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># See: https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#ingressspec-v1beta1-extensions</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">tls</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">hosts</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">vault-dns-name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">secretName</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-ingress-tls-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li><li>
<p>Deploy the <code>Vault</code> custom resource containing the <code>externalConfig</code> section to <code>cluster1</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f your-proper-vault-cr.yaml
</span></span></code></pre></div></li><li>
<p>After Vault started in <code>cluster1</code>, you can use the <code>vault-secrets-webhook</code> in <code>cluster2</code> with the proper annotations. For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">replicas</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">selector</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">matchLabels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hello-secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">template</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hello-secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">annotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;https://vault-dns-name:443&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-role</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-skip-verify</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;kubernetes&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li></ol><hr>
<p>Also you can use directly cloud identity to auth the mutating-webhook against the external vault.</p><ol>
<li>
<p>Add your cloud auth method in your external vault <a href="https://www.vaultproject.io/docs/auth/azure">https://www.vaultproject.io/docs/auth/azure</a></p></li><li>
<p>Configure your <code>vault-secrets-webhook</code> to use the good method. For example:</p></li></ol><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">VAULT_ADDR</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://external-vault.example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">VAULT_AUTH_METHOD</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">azure</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">VAULT_PATH</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">azure</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">VAULT_ROLE</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>For <code>VAULT_AUTH_METHOD</code> env var, these types: <strong>&ldquo;kubernetes&rdquo;, &ldquo;aws-ec2&rdquo;, &ldquo;gcp-gce&rdquo;, &ldquo;gcp-iam&rdquo;, &ldquo;jwt&rdquo;, &ldquo;azure&rdquo;</strong> are supported.</p></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-0300ffba6202f9ac291d350220c40174">6 - Unseal keys</h1><blockquote>
<p>Unsealing is the process of constructing the master key necessary to read the decryption key to decrypt data, allowing access to Vault. (<a href="https://www.vaultproject.io/docs/concepts/seal.html">From the official Vault documentation</a>)</p></blockquote><p>Vault starts in an uninitialized state, which means it has to be initialized with an initial set of parameters. The response to the init request is the <em>root token</em> and <em>unseal keys</em>. After that, Vault becomes initialized, but remains in a <em>sealed state</em>. A sealed state is a state in which no secrets can reach or leave Vault until a person, possibly more people than one, unseals it with the required number of unseal keys.</p><p>Vault data and the unseal keys live together: if you delete a Vault instance installed by the operator, or if you delete the Helm chart, all your data and the unseal keys to that initialized state should remain untouched. Read more about it in the <a href="https://www.vaultproject.io/docs/concepts/seal/">official documentation</a>.</p><h2 id="the-bank-vaults-init-and-unseal-process">The Bank-Vaults Init and Unseal process</h2><p><a href="https://github.com/bank-vaults/bank-vaults">Bank-Vaults</a> runs in an endless loop and does the following:</p><p><img src="VaultUnsealFlow.png" alt="Vault Unseal Flow"></p><ol>
<li><a href="https://github.com/bank-vaults/bank-vaults">Bank-Vaults</a> checks if Vault is initialized. If yes, it continues to step 2, otherwise Bank-Vaults:
<ol>
<li>Calls Vault init, which returns the root token and the configured number of unseal keys.</li><li>Encrypts the received token and keys with the configured KMS key.</li><li>Stores the encrypted token and keys in the cloud provider&rsquo;s object storage.</li><li>Flushes the root token and keys from its memory with explicit GC as soon as possible.</li></ol></li><li><a href="https://github.com/bank-vaults/bank-vaults">Bank-Vaults</a> checks if Vault is sealed. If it isn&rsquo;t, it continues to step 3, otherwise Bank-Vaults:
<ol>
<li>Reads the encrypted unseal keys from the cloud provider&rsquo;s object storage.</li><li>Decrypts the unseal keys with the configured KMS key.</li><li>Unseals Vault with the decrypted unseal keys.</li><li>Flushes the keys from its memory with explicit GC as soon as possible.</li></ol></li><li>If the <a href="/docs/external-configuration/">external configuration file</a> was changed and an OS signal is received, then Bank-Vaults:
<ol>
<li>Parses the configuration file.</li><li>Reads the encrypted root token from the cloud provider&rsquo;s object storage.</li><li>Decrypts the root token with the configured KMS key.</li><li>Applies the parsed configuration on the Vault API</li><li>Flushes the root token from its memory with explicit GC as soon as possible.</li></ol></li><li>Repeats from the second step after the configured time period.</li></ol><h2 id="keys-stored-by-bank-vaults">Keys stored by Bank-Vaults</h2><p>Bank-Vaults stores the following keys:</p><ul>
<li><code>vault-root</code>, which is the Vault&rsquo;s root token</li><li><code>vault-unseal-N</code>, where <code>N</code> is a number, starting at 0 up to the maximum defined minus 1, e.g. 5 unseal keys will be <code>vault-unseal-0</code> up to including <code>vault-unseal-4</code></li></ul><p>HashiCorp <a href="https://www.vaultproject.io/docs/concepts/tokens.html#root-tokens">recommends to revoke root tokens</a> after the initial set up of Vault has been completed.
To unseal Vault, the <code>vault-root</code> token is not needed and can be removed from the storage if it was put there via the <code>--init</code> call to <code>bank-vaults</code>.</p><h2 id="decrypting-root-token">Decrypting root token</h2><h3 id="aws">AWS</h3><p>To use the KMS-encrypted root token with Vault CLI:</p><p>Required CLI tools:</p><ul>
<li>aws</li></ul><p>Steps:</p><ol>
<li>
<p>Download and decrypt the root token (and the unseal keys, but that is not mandatory) into a file on your local file system:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#000">BUCKET</span><span style="color:#ce5c00;font-weight:700">=</span>bank-vaults-0
</span></span><span style="display:flex"><span><span style="color:#000">REGION</span><span style="color:#ce5c00;font-weight:700">=</span>eu-central-1
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">for</span> key in <span style="color:#4e9a06">&#34;vault-root&#34;</span> <span style="color:#4e9a06">&#34;vault-unseal-0&#34;</span> <span style="color:#4e9a06">&#34;vault-unseal-1&#34;</span> <span style="color:#4e9a06">&#34;vault-unseal-2&#34;</span> <span style="color:#4e9a06">&#34;vault-unseal-3&#34;</span> <span style="color:#4e9a06">&#34;vault-unseal-4&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">do</span>
</span></span><span style="display:flex"><span>    aws s3 cp s3://<span style="color:#4e9a06">${</span><span style="color:#000">BUCKET</span><span style="color:#4e9a06">}</span>/<span style="color:#4e9a06">${</span><span style="color:#000">key</span><span style="color:#4e9a06">}</span> .
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    aws kms decrypt <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>        --region <span style="color:#4e9a06">${</span><span style="color:#000">REGION</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>        --ciphertext-blob fileb://<span style="color:#4e9a06">${</span><span style="color:#000">key</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>        --encryption-context <span style="color:#000">Tool</span><span style="color:#ce5c00;font-weight:700">=</span>bank-vaults <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>        --output text <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>        --query Plaintext <span style="color:#000;font-weight:700">|</span> base64 -d &gt; <span style="color:#4e9a06">${</span><span style="color:#000">key</span><span style="color:#4e9a06">}</span>.txt
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    rm <span style="color:#4e9a06">${</span><span style="color:#000">key</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">done</span>
</span></span></code></pre></div></li><li>
<p>Save it as an environment variable:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#204a87">export</span> <span style="color:#000">VAULT_TOKEN</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:700">$(</span>cat vault-root.txt<span style="color:#204a87;font-weight:700">)</span><span style="color:#4e9a06">&#34;</span>
</span></span></code></pre></div></li></ol><h3 id="google-cloud">Google Cloud</h3><p>To use the KMS-encrypted root token with vault CLI:</p><p>Required CLI tools:</p><ul>
<li><code>gcloud</code></li><li><code>gsutil</code></li></ul><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#000">GOOGLE_PROJECT</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;my-project&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">GOOGLE_REGION</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;us-central1&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">BUCKET</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;bank-vaults-bucket&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">KEYRING</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;beta&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">KEY</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;beta&#34;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#204a87">export</span> <span style="color:#000">VAULT_TOKEN</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#204a87;font-weight:700">$(</span>gsutil cat gs://<span style="color:#4e9a06">${</span><span style="color:#000">BUCKET</span><span style="color:#4e9a06">}</span>/vault-root <span style="color:#000;font-weight:700">|</span> gcloud kms decrypt <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>                     --project <span style="color:#4e9a06">${</span><span style="color:#000">GOOGLE_PROJECT</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>                     --location <span style="color:#4e9a06">${</span><span style="color:#000">GOOGLE_REGION</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>                     --keyring <span style="color:#4e9a06">${</span><span style="color:#000">KEYRING</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>                     --key <span style="color:#4e9a06">${</span><span style="color:#000">KEY</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>                     --ciphertext-file - <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>                     --plaintext-file -<span style="color:#204a87;font-weight:700">)</span>
</span></span></code></pre></div><h3 id="kubernetes">Kubernetes</h3><p>There is a Kubernetes Secret backed unseal storage in Bank-Vaults, you should be aware of that Kubernetes Secrets are base64 encoded only if you are not using a <a href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/">EncryptionConfiguration</a> in your Kubernetes cluster.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#000">VAULT_NAME</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;vault&#34;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#204a87">export</span> <span style="color:#000">VAULT_TOKEN</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#204a87;font-weight:700">$(</span>kubectl get secrets <span style="color:#4e9a06">${</span><span style="color:#000">VAULT_NAME</span><span style="color:#4e9a06">}</span>-unseal-keys -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:700">={</span>.data.vault-root<span style="color:#ce5c00;font-weight:700">}</span> <span style="color:#000;font-weight:700">|</span> base64 -d<span style="color:#204a87;font-weight:700">)</span>
</span></span></code></pre></div><h2 id="migrate-unseal-keys-between-cloud-providers">Migrate unseal keys between cloud providers</h2><p>If you need to move your Vault instance from one provider or an external managed Vault, you have to store those the unseal keys and a root token in the Bank-Vaults format.</p><p>All examples assume that you have created files holding the root-token and the 5 unseal keys in plaintext:</p><ul>
<li>vault-root.txt</li><li>vault-unseal-0.txt</li><li>vault-unseal-1.txt</li><li>vault-unseal-2.txt</li><li>vault-unseal-3.txt</li><li>vault-unseal-4.txt</li></ul><p>For migrating the Vault storage data you will have to use <a href="https://www.vaultproject.io/docs/commands/operator/migrate/">official migration command</a> provided by Vault.</p><h3 id="aws-1">AWS</h3><p>Moving the above mentioned files to an AWS bucket and encrypt them with KMS before:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#000">REGION</span><span style="color:#ce5c00;font-weight:700">=</span>eu-central-1
</span></span><span style="display:flex"><span><span style="color:#000">KMS_KEY_ID</span><span style="color:#ce5c00;font-weight:700">=</span>02a2ba49-42ce-487f-b006-34c64f4b760e
</span></span><span style="display:flex"><span><span style="color:#000">BUCKET</span><span style="color:#ce5c00;font-weight:700">=</span>bank-vaults-1
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">for</span> key in <span style="color:#4e9a06">&#34;vault-root&#34;</span> <span style="color:#4e9a06">&#34;vault-unseal-0&#34;</span> <span style="color:#4e9a06">&#34;vault-unseal-1&#34;</span> <span style="color:#4e9a06">&#34;vault-unseal-2&#34;</span> <span style="color:#4e9a06">&#34;vault-unseal-3&#34;</span> <span style="color:#4e9a06">&#34;vault-unseal-4&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">do</span>
</span></span><span style="display:flex"><span>    aws kms encrypt <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>        --region <span style="color:#4e9a06">${</span><span style="color:#000">REGION</span><span style="color:#4e9a06">}</span> --key-id <span style="color:#4e9a06">${</span><span style="color:#000">KMS_KEY_ID</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>        --plaintext fileb://<span style="color:#4e9a06">${</span><span style="color:#000">key</span><span style="color:#4e9a06">}</span>.txt <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>        --encryption-context <span style="color:#000">Tool</span><span style="color:#ce5c00;font-weight:700">=</span>bank-vaults <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>        --output text <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>        --query CiphertextBlob <span style="color:#000;font-weight:700">|</span> base64 -d &gt; <span style="color:#4e9a06">${</span><span style="color:#000">key</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    aws s3 cp ./<span style="color:#4e9a06">${</span><span style="color:#000">key</span><span style="color:#4e9a06">}</span> s3://<span style="color:#4e9a06">${</span><span style="color:#000">BUCKET</span><span style="color:#4e9a06">}</span>/
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>    rm <span style="color:#4e9a06">${</span><span style="color:#000">key</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">${</span><span style="color:#000">key</span><span style="color:#4e9a06">}</span>.txt
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">done</span>
</span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-790ab2316602afe20aacd021437ce00d">7 - TLS</h1><p>Bank-Vaults tries to automate as much as possible for handling TLS certificates.</p><ul>
<li>The <code>vault-operator</code> automates the creation and renewal of TLS certificates for Vault.</li><li>The <code>vault</code> Helm Chart automates only the creation of TLS certificates for Vault via <a href="https://masterminds.github.io/sprig/crypto.html">Sprig</a>.</li></ul><p>Both the operator and the chart generate a Kubernetes Secret holding the TLS certificates, this is named <code>${VAULT_CR_NAME}-tls</code>. For most examples in the <a href="https://github.com/bank-vaults/bank-vaults/">Bank-Vaults project repository</a>, the name of the secret is <code>vault-tls</code>.</p><p>The Secret data keys are:</p><ul>
<li><code>ca.crt</code></li><li><code>server.crt</code></li><li><code>server.key</code></li></ul><blockquote>
<p>Note: The operator doesn&rsquo;t overwrite this Secret if it already exists, so you can provide this certificate in any other way, for example using <a href="https://cert-manager.io/">cert-manager</a> or by simply placing it there manually.</p></blockquote><h2 id="operator-custom-tls-settings">Operator custom TLS settings</h2><p>The following attributes influence the TLS settings of the operator. The <code>ca.crt</code> key is mandatory in <a href="#existingtlssecretname">existingTlsSecretName</a>, otherwise the Bank-Vaults components can&rsquo;t verify the Vault server certificate.</p><h3 id="canamespaces">CANamespaces</h3><p>The list of namespaces where the generated CA certificate for Vault should be distributed. Use ["*"] for all namespaces.</p><p>Default value: <em>[]</em></p><h3 id="existingtlssecretname">ExistingTLSSecretName</h3><p>The name of the secret that contains a TLS server certificate, key, and the corresponding CA certificate. The secret must be in the <strong>kubernetes.io/tls type secret keys + ca.crt key</strong> format. If the attribute is set, the operator uses the certificate already set in the secret, otherwise it generates a new one.</p><p>The <code>ca.crt</code> key is mandatory, otherwise the Bank-Vaults components can&rsquo;t verify the Vault server certificate.</p><p>Default value: <em>""</em></p><h3 id="tlsadditionalhosts">TLSAdditionalHosts</h3><p>A list hostnames or IP addresses to add to the SAN on the automatically generated TLS certificate.</p><p>Default value: <em>[]</em></p><h3 id="tlsexpirythreshold">TLSExpiryThreshold</h3><p>The expiration threshold of the Vault TLS certificate in Go Duration format.</p><p>Default value: <em>168h</em></p><h2 id="using-the-generated-custom-tls-certificate-with-vault-operator">Using the generated custom TLS certificate with vault-operator</h2><p>To use an existing secret which contains the TLS certificate, define <a href="#existingtlssecretname">existingTlsSecretName</a> in the Vault custom resource.</p><h2 id="generate-custom-certificates-with-cfssl">Generate custom certificates with CFSSL</h2><p>If you don&rsquo;t want to use the certificates generated by Helm or the Bank-Vaults operator, the easiest way to create a custom certificate for Bank-Vaults is using <a href="https://github.com/cloudflare/cfssl">CFSSL</a>.</p><p>The <a href="https://github.com/bank-vaults/bank-vaults-docs/tree/master/docs/tls">https://github.com/bank-vaults/bank-vaults-docs/tree/master/docs/tls directory</a> holds a set of custom CFSSL configurations which are prepared for the Helm release name <code>vault</code> in the <code>default</code> namespace. Of course, you can put any other certificates into the Secret below, this is just an example.</p><ol>
<li>
<p>Install <a href="https://github.com/cloudflare/cfssl">CFSSL</a>.</p></li><li>
<p>Create a CA:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>cfssl genkey -initca csr.json <span style="color:#000;font-weight:700">|</span> cfssljson -bare ca
</span></span></code></pre></div></li><li>
<p>Create a server certificate:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>cfssl gencert -ca<span style="color:#ce5c00;font-weight:700">=</span>ca.pem -ca-key<span style="color:#ce5c00;font-weight:700">=</span>ca-key.pem -config<span style="color:#ce5c00;font-weight:700">=</span>config.json -profile<span style="color:#ce5c00;font-weight:700">=</span>server server.json <span style="color:#000;font-weight:700">|</span> cfssljson -bare server
</span></span></code></pre></div></li><li>
<p>Put these certificates (and the server key) into a Kubernetes Secret:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl create secret generic vault-tls --from-file<span style="color:#ce5c00;font-weight:700">=</span>ca.crt<span style="color:#ce5c00;font-weight:700">=</span>ca.pem --from-file<span style="color:#ce5c00;font-weight:700">=</span>server.crt<span style="color:#ce5c00;font-weight:700">=</span>server.pem --from-file<span style="color:#ce5c00;font-weight:700">=</span>server.key<span style="color:#ce5c00;font-weight:700">=</span>server-key.pem
</span></span></code></pre></div></li><li>
<p>Install the Vault instance:</p><ul>
<li>With the chart which uses this certificate:</li></ul><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm upgrade --install vault ../charts/vault --set tls.secretName<span style="color:#ce5c00;font-weight:700">=</span>vault-tls
</span></span></code></pre></div><ul>
<li>With the operator, create a Vault custom resource, and apply it:</li></ul><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f vault-cr.yaml
</span></span></code></pre></div></li></ol><h2 id="generate-custom-certificates-with-cert-manager">Generate custom certificates with cert-manager</h2><p>You can use the following <a href="https://cert-manager.io">cert-manager custom resource</a> to generate a certificate for Bank-Vaults.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f - <span style="color:#4e9a06">&lt;&lt;EOF
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">apiVersion: cert-manager.io/v1
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">kind: Issuer
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  name: test-selfsigned
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">spec:
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  selfSigned: {}
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">---
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">apiVersion: cert-manager.io/v1
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">kind: Certificate
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  name: selfsigned-cert
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">spec:
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  commonName: vault
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  usages:
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">    - server auth
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  dnsNames:
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">    - vault
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">    - vault.default
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">    - vault.default.svc
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">    - vault.default.svc.cluster.local
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  ipAddresses:
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">    - 127.0.0.1
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  secretName: selfsigned-cert-tls
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  issuerRef:
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">    name: test-selfsigned
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-693b5b7c6aa0741d04206716de562ffe">8 - Cloud permissions</h1><p>The operator and the <code>bank-vaults</code> CLI command needs certain cloud permissions to function properly (init, unseal, configuration).</p><h2 id="google-cloud">Google Cloud</h2><p>The Service Account in which the Pod is running has to have the following IAM Roles:</p><ul>
<li>Cloud KMS Admin</li><li>Cloud KMS CryptoKey Encrypter/Decrypter</li><li>Storage Admin</li></ul><p>A CLI example how to run bank-vaults based Vault configuration on Google Cloud:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>bank-vaults configure --google-cloud-kms-key-ring vault --google-cloud-kms-crypto-key bank-vaults --google-cloud-kms-location global --google-cloud-storage-bucket vault-ha --google-cloud-kms-project continual-flow-276578
</span></span></code></pre></div><h2 id="azure">Azure</h2><p>The Access Policy in which the Pod is running has to have the following IAM Roles:</p><ul>
<li>Key Vault All Key permissions</li><li>Key Vault All Secret permissions</li></ul><h2 id="aws">AWS</h2><h3 id="enable-iam-oidc-provider-for-an-eks-cluster">Enable IAM OIDC provider for an EKS cluster</h3><p>To allow Vault pods to assume IAM roles in order to access AWS services the IAM OIDC provider needs to be enabled on the cluster.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#000">BANZAI_CURRENT_CLUSTER_NAME</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;mycluster&#34;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Enable OIDC provider for the cluster with eksctl</span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Follow the docs here to do it manually https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html</span>
</span></span><span style="display:flex"><span>eksctl utils associate-iam-oidc-provider <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    --cluster <span style="color:#4e9a06">${</span><span style="color:#000">BANZAI_CURRENT_CLUSTER_NAME</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    --approve
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Create a KMS key and S3 bucket and enter details here</span>
</span></span><span style="display:flex"><span><span style="color:#000">AWS_ACCOUNT_ID</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#204a87;font-weight:700">$(</span>aws sts get-caller-identity --query <span style="color:#4e9a06">&#34;Account&#34;</span> --output text<span style="color:#204a87;font-weight:700">)</span>
</span></span><span style="display:flex"><span><span style="color:#000">REGION</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;eu-west-1&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">KMS_KEY_ID</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;9f054126-2a98-470c-9f10-9b3b0cad94a1&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">KMS_KEY_ARN</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;arn:aws:kms:</span><span style="color:#4e9a06">${</span><span style="color:#000">REGION</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">${</span><span style="color:#000">AWS_ACCOUNT_ID</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">:key/</span><span style="color:#4e9a06">${</span><span style="color:#000">KMS_KEY_ID</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">BUCKET</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;bank-vaults&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">OIDC_PROVIDER</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#204a87;font-weight:700">$(</span>aws eks describe-cluster --name <span style="color:#4e9a06">${</span><span style="color:#000">BANZAI_CURRENT_CLUSTER_NAME</span><span style="color:#4e9a06">}</span> --query <span style="color:#4e9a06">&#34;cluster.identity.oidc.issuer&#34;</span> --output text <span style="color:#000;font-weight:700">|</span> sed -e <span style="color:#4e9a06">&#34;s/^https:\/\///&#34;</span><span style="color:#204a87;font-weight:700">)</span>
</span></span><span style="display:flex"><span><span style="color:#000">SERVICE_ACCOUNT_NAME</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;vault&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">SERVICE_ACCOUNT_NAMESPACE</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;vault&#34;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>cat &gt; trust.json <span style="color:#4e9a06">&lt;&lt;EOF
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">{
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  &#34;Statement&#34;: [
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">    {
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">      &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">      &#34;Principal&#34;: {
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">        &#34;Federated&#34;: &#34;arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/${OIDC_PROVIDER}&#34;
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">      },
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">      &#34;Action&#34;: &#34;sts:AssumeRoleWithWebIdentity&#34;,
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">      &#34;Condition&#34;: {
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">        &#34;StringEquals&#34;: {
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">          &#34;${OIDC_PROVIDER}:sub&#34;: &#34;system:serviceaccount:${SERVICE_ACCOUNT_NAMESPACE}:${SERVICE_ACCOUNT_NAME}&#34;
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">        }
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">      }
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">    }
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  ]
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">}
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>cat &gt; vault-policy.json <span style="color:#4e9a06">&lt;&lt;EOF
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">{
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">    &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">    &#34;Statement&#34;: [
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">        {
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">            &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">            &#34;Action&#34;: [
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">                &#34;kms:Decrypt&#34;,
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">                &#34;kms:Encrypt&#34;
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">            ],
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">            &#34;Resource&#34;: [
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">                &#34;${KMS_KEY_ARN}&#34;
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">            ]
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">        },
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">        {
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">            &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">            &#34;Action&#34;: [
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">                &#34;s3:PutObject&#34;,
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">                &#34;s3:GetObject&#34;
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">            ],
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">            &#34;Resource&#34;: [
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">                &#34;arn:aws:s3:::${BUCKET}/*&#34;
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">            ]
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">        },
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">        {
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">            &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">            &#34;Action&#34;: &#34;s3:ListBucket&#34;,
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">            &#34;Resource&#34;: &#34;arn:aws:s3:::${BUCKET}&#34;
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">        }
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">    ]
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">}
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># AWS IAM role and Kubernetes service account setup</span>
</span></span><span style="display:flex"><span>aws iam create-role --role-name vault --assume-role-policy-document file://trust.json
</span></span><span style="display:flex"><span>aws iam create-policy --policy-name vault --policy-document file://vault-policy.json
</span></span><span style="display:flex"><span>aws iam attach-role-policy --role-name vault --policy-arn arn:aws:iam::<span style="color:#4e9a06">${</span><span style="color:#000">AWS_ACCOUNT_ID</span><span style="color:#4e9a06">}</span>:policy/vault
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># If you are having a ServiceAccount already, only the annotation is needed</span>
</span></span><span style="display:flex"><span>kubectl create serviceaccount <span style="color:#000">$SERVICE_ACCOUNT_NAME</span> --namespace <span style="color:#000">$SERVICE_ACCOUNT_NAMESPACE</span>
</span></span><span style="display:flex"><span>kubectl annotate serviceaccount <span style="color:#000">$SERVICE_ACCOUNT_NAME</span>  --namespace <span style="color:#000">$SERVICE_ACCOUNT_NAMESPACE</span> eks.amazonaws.com/role-arn<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;arn:aws:iam::</span><span style="color:#4e9a06">${</span><span style="color:#000">AWS_ACCOUNT_ID</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">:role/vault&#34;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Cleanup</span>
</span></span><span style="display:flex"><span>rm vault-policy.json trust.json
</span></span></code></pre></div><h3 id="getting-the-root-token">Getting the root token</h3><p>After Vault is successfully deployed, you can query the root-token for admin access.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Fetch Vault root token, check bucket for actual name based on unsealConfig.aws.s3Prefix</span>
</span></span><span style="display:flex"><span>aws s3 cp s3://<span style="color:#000">$s3_bucket_name</span>/vault-root /tmp/vault-root
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#204a87">export</span> <span style="color:#000">VAULT_TOKEN</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:700">$(</span>aws kms decrypt <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>  --ciphertext-blob fileb:///tmp/vault-root <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>  --encryption-context <span style="color:#000">Tool</span><span style="color:#ce5c00;font-weight:700">=</span>bank-vaults <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>  --query Plaintext --output text <span style="color:#000;font-weight:700">|</span> base64 --decode<span style="color:#204a87;font-weight:700">)</span><span style="color:#4e9a06">&#34;</span>
</span></span></code></pre></div><p>The Instance profile in which the Pod is running has to have the following IAM Policies:</p><ul>
<li>KMS: <code>kms:Encrypt, kms:Decrypt</code></li><li>S3: <code>s3:GetObject, s3:PutObject</code> on object level and <code>s3:ListBucket</code> on bucket level</li></ul><p>An example command how to init and unseal Vault on AWS:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>bank-vaults unseal --init --mode aws-kms-s3 --aws-kms-key-id 9f054126-2a98-470c-9f10-9b3b0cad94a1 --aws-s3-region eu-west-1 --aws-kms-region eu-west-1 --aws-s3-bucket bank-vaults
</span></span></code></pre></div><p>When using existing unseal keys, you need to make sure to kms encrypt these with the proper <code>EncryptionContext</code>.
If this is not done, the invocation of <code>bank-vaults</code> will trigger an <code>InvalidCiphertextException</code> from AWS KMS.
An example how to encrypt the keys (specify <code>--profile</code> and <code>--region</code> accordingly):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>aws kms encrypt --key-id <span style="color:#4e9a06">&#34;alias/kms-key-alias&#34;</span> --encryption-context <span style="color:#4e9a06">&#34;Tool=bank-vaults&#34;</span>  --plaintext fileb://vault-unseal-0.txt --output text --query CiphertextBlob <span style="color:#000;font-weight:700">|</span> base64 -D &gt; vault-unseal-0
</span></span></code></pre></div><p>From this point on copy the encrypted files to the appropriate S3 bucket.
As an additional security measure make sure to turn on encryption of the S3 bucket before uploading the files.</p><h2 id="alibaba-cloud">Alibaba Cloud</h2><p>A CLI example how to run bank-vaults based Vault unsealing on Alibaba Cloud:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>bank-vaults unseal --mode alibaba-kms-oss --alibaba-access-key-id <span style="color:#4e9a06">${</span><span style="color:#000">ALIBABA_ACCESS_KEY_ID</span><span style="color:#4e9a06">}</span> --alibaba-access-key-secret <span style="color:#4e9a06">${</span><span style="color:#000">ALIBABA_ACCESS_KEY_SECRET</span><span style="color:#4e9a06">}</span> --alibaba-kms-region eu-central-1 --alibaba-kms-key-id <span style="color:#4e9a06">${</span><span style="color:#000">ALIBABA_KMS_KEY_UUID</span><span style="color:#4e9a06">}</span> --alibaba-oss-endpoint oss-eu-central-1.aliyuncs.com --alibaba-oss-bucket bank-vaults
</span></span></code></pre></div><h2 id="kubernetes">Kubernetes</h2><p>The Service Account in which the bank-vaults Pod is running has to have the following Roles rules:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">rules</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:700">apiGroups</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:700">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">resources</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">[</span><span style="color:#4e9a06">&#34;secrets&#34;</span><span style="color:#000;font-weight:700">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">verbs</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#000;font-weight:700">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:700">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:700">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:700">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-775eaf4271da79cc2631e217d7779d22">9 - Backing up Vault</h1><p>You can configure the vault-operator to create backups of the Vault cluster with <a href="https://velero.io/">Velero</a>.</p><h2 id="prerequisites">Prerequisites</h2><ul>
<li>The <a href="https://velero.io/docs/v1.5/basic-install/#install-the-cli">Velero CLI</a> must be installed on your computer.</li><li>To create Persistent Volume (PV) snapshots, you need access to an object storage. The following example uses an Amazon S3 bucket called <code>bank-vaults-velero</code> in the Stockholm region.</li></ul><h2 id="install-velero">Install Velero</h2><p>To configure the vault-operator to create backups of the Vault cluster, complete the following steps.</p><ol>
<li>
<p>Install Velero on the target cluster with Helm.</p><ol>
<li>
<p>Add the Velero Helm repository:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm repo add vmware-tanzu https://vmware-tanzu.github.io/helm-charts
</span></span></code></pre></div></li><li>
<p>Create a namespace for Velero:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl create namespace velero
</span></span></code></pre></div></li><li>
<p>Install Velero with <a href="https://restic.net/">Restic</a> so you can create PV snapshots as well:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#000">BUCKET</span><span style="color:#ce5c00;font-weight:700">=</span>bank-vaults-velero
</span></span><span style="display:flex"><span><span style="color:#000">REGION</span><span style="color:#ce5c00;font-weight:700">=</span>eu-north-1
</span></span><span style="display:flex"><span><span style="color:#000">KMS_KEY_ID</span><span style="color:#ce5c00;font-weight:700">=</span>alias/bank-vaults-velero
</span></span><span style="display:flex"><span><span style="color:#000">SECRET_FILE</span><span style="color:#ce5c00;font-weight:700">=</span>~/.aws/credentials
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>helm upgrade --install velero --namespace velero <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>          --set configuration.provider<span style="color:#ce5c00;font-weight:700">=</span>aws <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>          --set-file credentials.secretContents.cloud<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">${</span><span style="color:#000">SECRET_FILE</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>          --set <span style="color:#000">deployRestic</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#204a87">true</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>          --set configuration.backupStorageLocation.name<span style="color:#ce5c00;font-weight:700">=</span>aws <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>          --set configuration.backupStorageLocation.bucket<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">${</span><span style="color:#000">BUCKET</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>          --set configuration.backupStorageLocation.config.region<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">${</span><span style="color:#000">REGION</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>          --set configuration.backupStorageLocation.config.kmsKeyId<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">${</span><span style="color:#000">KMS_KEY_ID</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>          --set configuration.volumeSnapshotLocation.name<span style="color:#ce5c00;font-weight:700">=</span>aws <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>          --set configuration.volumeSnapshotLocation.config.region<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">${</span><span style="color:#000">REGION</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>          --set <span style="color:#4e9a06">&#34;initContainers[0].name&#34;</span><span style="color:#ce5c00;font-weight:700">=</span>velero-plugin-for-aws <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>          --set <span style="color:#4e9a06">&#34;initContainers[0].image&#34;</span><span style="color:#ce5c00;font-weight:700">=</span>velero/velero-plugin-for-aws:v1.2.1 <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>          --set <span style="color:#4e9a06">&#34;initContainers[0].volumeMounts[0].mountPath&#34;</span><span style="color:#ce5c00;font-weight:700">=</span>/target <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>          --set <span style="color:#4e9a06">&#34;initContainers[0].volumeMounts[0].name&#34;</span><span style="color:#ce5c00;font-weight:700">=</span>plugins <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>          vmware-tanzu/velero
</span></span></code></pre></div></li></ol></li><li>
<p>Install the vault-operator to the cluster:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm upgrade --install vault-operator banzaicloud-stable/vault-operator
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>kubectl apply -f operator/deploy/rbac.yaml
</span></span><span style="display:flex"><span>kubectl apply -f operator/deploy/cr-raft.yaml
</span></span></code></pre></div><blockquote>
<p>Note: The Vault CR in cr-raft.yaml has a special flag called <code>veleroEnabled</code>. This is useful for file-based Vault storage backends (<code>file</code>, <code>raft</code>), see the <a href="https://velero.io/docs/v1.2.0/hooks/">Velero documentation</a>:</p></blockquote><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Add Velero fsfreeze sidecar container and supporting hook annotations to Vault Pods:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># https://velero.io/docs/v1.2.0/hooks/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">veleroEnabled</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li><li>
<p>Create a backup with the <a href="https://velero.io/docs/v1.5/basic-install/#install-the-cli">Velero CLI</a> or with the predefined Velero Backup CR:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>velero backup create --selector <span style="color:#000">vault_cr</span><span style="color:#ce5c00;font-weight:700">=</span>vault vault-1
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># OR</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/banzaicloud/bank-vaults/master/examples/backup/backup.yaml
</span></span></code></pre></div><blockquote>
<p>Note: For a daily scheduled backup, see <a href="https://raw.githubusercontent.com/banzaicloud/bank-vaults/master/examples/backup/schedule.yaml">schedule.yaml</a>.</p></blockquote></li><li>
<p>Check that the Velero backup got created successfully:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>velero backup describe --details vault-1
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>Name:         vault-1
</span></span><span style="display:flex"><span>Namespace:    velero
</span></span><span style="display:flex"><span>Labels:       velero.io/backup<span style="color:#ce5c00;font-weight:700">=</span>vault-1
</span></span><span style="display:flex"><span>              velero.io/pv<span style="color:#ce5c00;font-weight:700">=</span>pvc-6eb4d9c1-25cd-4a28-8868-90fa9d51503a
</span></span><span style="display:flex"><span>              velero.io/storage-location<span style="color:#ce5c00;font-weight:700">=</span>default
</span></span><span style="display:flex"><span>Annotations:  &lt;none&gt;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>Phase:  Completed
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>Namespaces:
</span></span><span style="display:flex"><span>  Included:  *
</span></span><span style="display:flex"><span>  Excluded:  &lt;none&gt;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>Resources:
</span></span><span style="display:flex"><span>  Included:        *
</span></span><span style="display:flex"><span>  Excluded:        &lt;none&gt;
</span></span><span style="display:flex"><span>  Cluster-scoped:  auto
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>Label selector:  <span style="color:#000">vault_cr</span><span style="color:#ce5c00;font-weight:700">=</span>vault
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>Storage Location:  default
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>Snapshot PVs:  auto
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>TTL:  720h0m0s
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>Hooks:  &lt;none&gt;
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>Backup Format Version:  <span style="color:#0000cf;font-weight:700">1</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>Started:    2020-01-29 14:17:41 +0100 CET
</span></span><span style="display:flex"><span>Completed:  2020-01-29 14:17:45 +0100 CET
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>Expiration:  2020-02-28 14:17:41 +0100 CET
</span></span></code></pre></div></li></ol><h2 id="test-the-backup">Test the backup</h2><ol>
<li>
<p>To emulate a catastrophe, remove Vault entirely from the cluster:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl delete vault -l <span style="color:#000">vault_cr</span><span style="color:#ce5c00;font-weight:700">=</span>vault
</span></span><span style="display:flex"><span>kubectl delete pvc -l <span style="color:#000">vault_cr</span><span style="color:#ce5c00;font-weight:700">=</span>vault
</span></span></code></pre></div></li><li>
<p>Now restore Vault from the backup.</p><ol>
<li>
<p>Scale down the vault-operator, so it won&rsquo;t reconcile during the restore process:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl scale deployment vault-operator --replicas <span style="color:#0000cf;font-weight:700">0</span>
</span></span></code></pre></div></li><li>
<p>Restore all Vault-related resources from the backup:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>velero restore create --from-backup vault-1
</span></span></code></pre></div></li><li>
<p>Check that the restore has finished properly:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>velero restore get
</span></span><span style="display:flex"><span>NAME                    BACKUP   STATUS      WARNINGS   ERRORS   CREATED                         SELECTOR
</span></span><span style="display:flex"><span>vault1-20200129142409   vault1   Completed   <span style="color:#0000cf;font-weight:700">0</span>          <span style="color:#0000cf;font-weight:700">0</span>        2020-01-29 14:24:09 +0100 CET   &lt;none&gt;
</span></span></code></pre></div></li><li>
<p>Check that the Vault cluster got actually restored:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get pods
</span></span><span style="display:flex"><span>NAME                                READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex"><span>vault-0                             4/4     Running   <span style="color:#0000cf;font-weight:700">0</span>          1m42s
</span></span><span style="display:flex"><span>vault-1                             4/4     Running   <span style="color:#0000cf;font-weight:700">0</span>          1m42s
</span></span><span style="display:flex"><span>vault-2                             4/4     Running   <span style="color:#0000cf;font-weight:700">0</span>          1m42s
</span></span><span style="display:flex"><span>vault-configurer-5499ff64cb-g75vr   1/1     Running   <span style="color:#0000cf;font-weight:700">0</span>          1m42s
</span></span></code></pre></div></li><li>
<p>Scale the operator back after the restore process:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl scale deployment vault-operator --replicas <span style="color:#0000cf;font-weight:700">1</span>
</span></span></code></pre></div></li></ol></li><li>
<p>Delete the backup if you don&rsquo;t wish to keep it anymore:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>velero backup delete vault-1
</span></span></code></pre></div></li></ol></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-c1595f38d483461f6dd56c889fe355d2">10 - Running the Bank-Vaults secret webhook alongside Istio</h1><p>Both the <code>vault-operator</code> and the <code>vault-secrets-webhook</code> can work on Istio enabled clusters quite well.</p><p>We support the following three scenarios:</p><ul>
<li><a href="/docs/istio/vault-outside-the-mesh/">Scenario 1: Vault runs outside an Istio mesh</a>, whereas the namespace where the application runs and the webhook injects secrets has Istio sidecar injection enabled</li><li><a href="/docs/istio/vault-inside-the-mesh/">Scenario 2</a>: The namespace where Vault is running has Istio sidecar injection enabled</li><li><a href="/docs/istio/vault-and-app-inside-the-mesh/">Scenario 3: Both namespaces have Istio sidecar injection enabled</a></li></ul><h2 id="prerequisites">Prerequisites</h2><ol>
<li>
<p>Install the <a href="https://github.com/banzaicloud/istio-operator">Istio operator</a>.</p></li><li>
<p>Make sure you have <a href="https://istio.io/docs/tasks/security/authentication/authn-policy/#globally-enabling-istio-mutual-tls">mTLS</a> enabled in the Istio mesh through the operator with the following command:</p><p>Enable mTLS if it is not set to <code>STRICT</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl patch istio -n istio-system mesh --type<span style="color:#ce5c00;font-weight:700">=</span>json -p<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#39;[{&#34;op&#34;: &#34;replace&#34;, &#34;path&#34;: &#34;/spec/meshPolicy/mtlsMode&#34;, &#34;value&#34;:STRICT}]&#39;</span>
</span></span></code></pre></div></li><li>
<p>Check that mesh is configured with <code>mTLS</code> turned on which applies to all applications in the cluster in Istio-enabled namespaces. You can change this if you would like to use another policy.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get meshpolicy default -o yaml
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">authentication.istio.io/v1alpha1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MeshPolicy</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">app</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">security</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">peers</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">mtls</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li></ol><p>Now your cluster is properly running on Istio with mTLS enabled globally.</p><h2 id="install-the-bank-vaults-components">Install the Bank-Vaults components</h2><ol>
<li>
<p>You are recommended to create a separate namespace for <a href="https://banzaicloud.com/docs/overview/">Bank-Vaults</a> called <code>vault-system</code>. You can enable Istio sidecar injection here as well, but Kubernetes won&rsquo;t be able to call back the webhook properly since mTLS is enabled (and Kubernetes is outside of the Istio mesh). To overcome this, apply a <code>PERMISSIVE</code> Istio authentication policy to the <code>vault-secrets-webhook</code> Service itself, so Kubernetes can call it back without Istio mutual TLS authentication.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl create namespace vault-system
</span></span><span style="display:flex"><span>kubectl label namespace vault-system <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:700">=</span>vault-system istio-injection<span style="color:#ce5c00;font-weight:700">=</span>enabled
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f - <span style="color:#4e9a06">&lt;&lt;EOF
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">apiVersion: authentication.istio.io/v1alpha1
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">kind: Policy
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  name: vault-secrets-webhook
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  namespace: vault-system
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  labels:
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">    app: security
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">spec:
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  targets:
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  - name: vault-secrets-webhook
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  peers:
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  - mtls:
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">      mode: PERMISSIVE
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div></li><li>
<p>Now you can install the operator and the webhook to the prepared namespace:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm repo add banzaicloud-stable https://kubernetes-charts.banzaicloud.com
</span></span><span style="display:flex"><span>helm upgrade --install vault-secrets-webhook banzaicloud-stable/vault-secrets-webhook --namespace vault-system
</span></span><span style="display:flex"><span>helm upgrade --install vault-operator banzaicloud-stable/vault-operator --namespace vault-system
</span></span></code></pre></div></li></ol><p>Soon the webhook and the operator become up and running. Check that the <code>istio-proxy</code> got injected into all Pods in <code>vault-system</code>.</p><p>Proceed to the description of your scenario:</p><ul>
<li><a href="/docs/istio/vault-outside-the-mesh/">Scenario 1: Vault runs outside an Istio mesh</a>, whereas the namespace where the application runs and the webhook injects secrets has Istio sidecar injection enabled</li><li><a href="/docs/istio/vault-inside-the-mesh/">Scenario 2</a>: The namespace where Vault is running has Istio sidecar injection enabled</li><li><a href="/docs/istio/vault-and-app-inside-the-mesh/">Scenario 3: Both namespaces have Istio sidecar injection enabled</a></li></ul></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-94914e31e06eb46fb176a25ca68509d1">10.1 - Scenario 1 - Vault runs outside, the application inside the mesh</h1><p>In this scenario, Vault runs outside an Istio mesh, whereas the namespace where the application runs and the webhook injects secrets has Istio sidecar injection enabled.</p><p align="center"><img src="/img/istio_vault1.png"></p><p>First, complete the <a href="/docs/istio/#prerequisites">Prerequisites</a>, then <a href="#install-vault-outside-mesh">install Vault outside the mesh</a>, and finally <a href="#install-application-inside-mesh">install an application within the mesh</a>.</p><h2 id="install-vault-outside-mesh">Install Vault outside the mesh</h2><ol>
<li>
<p>Provision a Vault instance with the Bank-Vaults operator in a separate namespace:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl create namespace vault
</span></span></code></pre></div></li><li>
<p>Apply the <a href="/docs/istio/rbac.yaml">RBAC</a> and <a href="/docs/istio/cr-istio.yaml">CR</a> files to the cluster to create a Vault instance in the <code>vault</code> namespace with the operator:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f rbac.yaml -f cr-istio.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get pods -n vault
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>NAME                               READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex"><span>vault-0                            3/3     Running   <span style="color:#0000cf;font-weight:700">0</span>          22h
</span></span><span style="display:flex"><span>vault-configurer-6458cc4bf-6tpkz   1/1     Running   <span style="color:#0000cf;font-weight:700">0</span>          22h
</span></span></code></pre></div><p>If you are writing your own Vault CR make sure that <code>istioEnabled: true</code> is configured, this influences port naming so the Vault service port protocols are detected by Istio correctly.</p></li><li>
<p>The <code>vault-secrets-webhook</code> can&rsquo;t inject Vault secrets into <code>initContainers</code> in an Istio-enabled namespace when the <code>STRICT</code> authentication policy is applied to the Vault service, because Istio needs a sidecar container to do mTLS properly, and in the phase when <code>initContainers</code> are running the Pod doesn&rsquo;t have a sidecar yet.
If you wish to inject into <code>initContainers</code> as well, you need to apply a <code>PERMISSIVE</code> authentication policy in the <code>vault</code> namespace, since it has its own TLS certificate outside of Istio scope (so this is safe to do from networking security point of view).</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f - <span style="color:#4e9a06">&lt;&lt;EOF
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">apiVersion: authentication.istio.io/v1alpha1
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">kind: Policy
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">metadata:
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  name: default
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  namespace: vault
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  labels:
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">    app: security
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">spec:
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  peers:
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">  - mtls:
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">      mode: PERMISSIVE
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div></li></ol><h2 id="install-application-inside-mesh">Install the application inside a mesh</h2><p>In this scenario Vault is running outside the Istio mesh (as we have installed it in the <a href="#install-vault-outside-mesh">previous steps</a> and our demo application runs within the Istio mesh. To install the demo application inside the mesh, complete the following steps:</p><ol>
<li>
<p>Create a namespace first for the application and enable Istio sidecar injection:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl create namespace app
</span></span><span style="display:flex"><span>kubectl label namespace app istio-injection<span style="color:#ce5c00;font-weight:700">=</span>enabled
</span></span></code></pre></div></li><li>
<p>Install the application <a href="/docs/istio/app.yaml">manifest</a> to the cluster:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f app.yaml
</span></span></code></pre></div></li><li>
<p>Check that the application is up and running. It should have two containers, the <code>app</code> itself and the <code>istio-proxy</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get pods -n app
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>NAME                  READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex"><span>app-5df5686c4-sl6dz   2/2     Running   <span style="color:#0000cf;font-weight:700">0</span>          119s
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl logs -f -n app deployment/app app
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-02-18T14:26:01Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;Received new Vault token&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-02-18T14:26:01Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;Initial Vault token arrived&#34;</span>
</span></span><span style="display:flex"><span>s3cr3t
</span></span><span style="display:flex"><span>going to sleep...
</span></span></code></pre></div></li></ol></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-b903e9610a0524bda4a27e27b93ed164">10.2 - Scenario 2 - Running Vault inside the mesh</h1><p>To run Vault inside the mesh, complete the following steps.</p><p align="center"><img src="/img/istio_vault2.png"></p><blockquote>
<p>Note: These instructions assume that you have <a href="/docs/istio/vault-outside-the-mesh/">Scenario 1</a> up and running, and modifying it to run Vault inside the mesh.</p></blockquote><ol>
<li>
<p>Turn off Istio in the <code>app</code> namespace by removing the <code>istio-injection</code> label:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl label namespace app istio-injection-
</span></span><span style="display:flex"><span>kubectl label namespace vault istio-injection<span style="color:#ce5c00;font-weight:700">=</span>enabled
</span></span></code></pre></div></li><li>
<p>Delete the Vault pods in the <code>vault</code> namespace, so they will get recreated with the <code>istio-proxy</code> sidecar:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl delete pods --all -n vault
</span></span></code></pre></div></li><li>
<p>Check that they both come back with an extra container (4/4 and 2/2 now):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get pods -n vault
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>NAME                                READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex"><span>vault-0                             4/4     Running   <span style="color:#0000cf;font-weight:700">0</span>          1m
</span></span><span style="display:flex"><span>vault-configurer-6d9b98c856-l4flc   2/2     Running   <span style="color:#0000cf;font-weight:700">0</span>          1m
</span></span></code></pre></div></li><li>
<p>Delete the application pods in the <code>app</code> namespace, so they will get recreated without the <code>istio-proxy</code> sidecar:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl delete pods --all -n app
</span></span></code></pre></div></li></ol><p>The app pod got recreated with only the <code>app</code> container (1/1) and Vault access still works:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get pods -n app
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>NAME                  READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex"><span>app-5df5686c4-4n6r7   1/1     Running   <span style="color:#0000cf;font-weight:700">0</span>          71s
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl logs -f -n app deployment/app
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-02-18T14:41:20Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;Received new Vault token&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-02-18T14:41:20Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;Initial Vault token arrived&#34;</span>
</span></span><span style="display:flex"><span>s3cr3t
</span></span><span style="display:flex"><span>going to sleep...
</span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-3901a1aaad74c653def694b23cd5d371">10.3 - Scenario 3 - Both Vault and the app are running inside the mesh</h1><p>In this scenario, both Vault and the app are running inside the mesh.</p><p align="center"><img src="/img/istio_vault3.png"></p><ol>
<li>
<p>Complete the <a href="/docs/istio/#prerequisites">Prerequisites</a>.</p></li><li>
<p>Enable sidecar auto-injection for both namespaces:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl label namespace app   istio-injection<span style="color:#ce5c00;font-weight:700">=</span>enabled
</span></span><span style="display:flex"><span>kubectl label namespace vault istio-injection<span style="color:#ce5c00;font-weight:700">=</span>enabled
</span></span></code></pre></div></li><li>
<p>Delete all pods so they are getting injected with the proxy:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl delete pods --all -n app
</span></span><span style="display:flex"><span>kubectl delete pods --all -n vault
</span></span></code></pre></div></li><li>
<p>Check the logs in the app container. It should sill show success:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl logs -f -n app deployment/app
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-02-18T15:04:03Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;Initial Vault token arrived&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-02-18T15:04:03Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;Renewed Vault Token&#34;</span>
</span></span><span style="display:flex"><span>s3cr3t
</span></span><span style="display:flex"><span>going to sleep...
</span></span></code></pre></div></li></ol></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-69bc5d1aaecbcd0707873de44ca465ec">11 - HSM Support</h1><p>Bank-Vaults offers a lot of alternatives for encrypting and storing the <code>unseal-keys</code> and the <code>root-token</code> for Vault. One of the encryption technics is the HSM - Hardware Security Module. HSM offers an industry-standard way to encrypt your data in on-premise environments.</p><p>You can use a Hardware Security Module (HSM) to generate and store the private keys used by Bank-Vaults. Some articles still point out the speed of HSM devices as their main selling point, but an average PC can do more cryptographic operations. Actually, the main benefit is from the security point of view. An HSM protects your private keys and handles cryptographic operations, which allows the encryption of protected information without exposing the private keys (they are not extractable). Bank-Vaults currently supports the <a href="https://en.wikipedia.org/wiki/PKCS_11">PKCS11</a> software standard to communicate with an HSM. Fulfilling compliance requirements (for example, PCI DSS) is also a great benefit of HSMs, so from now on you can achieve that with Bank-Vaults.</p><iframe width="704" height="438" src="https://www.youtube.com/embed/4iUSoxPMVXY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<h2 id="implementation-in-bank-vaults">Implementation in Bank-Vaults</h2><p><img src="/img/hsm.png" alt="Vault HSM"></p><p>To support HSM devices for encrypting unseal-keys and root-tokens, Bank-Vaults:</p><ul>
<li>implements an encryption/decryption <code>Service</code> named <code>hsm</code> in the <code>bank-vaults</code> CLI,</li><li>the <code>bank-vaults</code> Docker image now includes the SoftHSM (for testing) and the OpenSC tooling,</li><li>the operator is aware of HSM and its nature.</li></ul><p>The HSM offers an encryption mechanism, but the unseal-keys and root-token have to be stored somewhere after they got encrypted. Currently there are two possible solutions for that:</p><ul>
<li>Some HSM devices can store a limited quantity of arbitrary data (like Nitrokey HSM), and Bank-Vaults can store the unseal-keys and root-token here.</li><li>If the HSM does not support that, Bank-Vaults uses the HSM to encrypt the unseal-keys and root-token, then stores them in <a href="https://kubernetes.io/docs/concepts/configuration/secret/">Kubernetes Secrets</a>. We believe that it is safe to store these keys in Kubernetes Secrets in encrypted format.</li></ul><p>Bank-Vaults offers the ability to use the pre-created the cryptographic encryption keys on the HSM device, or generate a key pair on the fly if there isn&rsquo;t any with the specified label in the specified slot.</p><p>Since Bank-Vaults is written in Go, it uses the <a href="https://github.com/miekg/pkcs11">github.com/miekg/pkcs11</a> wrapper to pull in the PKCS11 library, to be more precise the <code>p11</code> high-level wrapper .</p><h2 id="supported-hsm-solutions">Supported HSM solutions</h2><p>Bank-Vaults currently supports the following HSM solutions:</p><ul>
<li><a href="/docs/hsm/softhsm/">SoftHSM</a>, recommended for testing</li><li><a href="/docs/hsm/nitrokey-opensc/">NitroKey HSM</a>.</li><li>AWS CloudHSM supports the PKCS11 API as well, so it probably works, though it needs a custom Docker image.</li></ul></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-dc66273caf9253f55709a2b96999fe12">11.1 - NitroKey HSM support (OpenSC)</h1><p><a href="https://www.nitrokey.com/">Nitrokey HSM</a> is a USB HSM device based on the <a href="https://github.com/OpenSC/OpenSC">OpenSC project</a>. We are using NitroKey to develop real hardware-based HSM support for Bank-Vaults. This device is not a cryptographic accelerator, only key generation and the private key operations (sign and decrypt) are supported. Public key operations should be done by extracting the public key and working on the computer, and this is how it is implemented in Bank-Vaults. It is not possible to extract private keys from NitroKey HSM, the device is tamper-resistant.</p><p>This device supports only RSA based encryption/decryption, and thus this is implemented in Bank-Vaults currently. It supports ECC keys as well, but only for sign/verification operations.</p><p>To start using a NitroKey HSM, complete the following steps.</p><ol>
<li>
<p>Install OpenSC and initialize the NitroKey HSM stick:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>brew install opensc
</span></span><span style="display:flex"><span>sc-hsm-tool --initialize --label bank-vaults --pin banzai --so-pin banzaicloud
</span></span><span style="display:flex"><span>pkcs11-tool --module /usr/local/lib/opensc-pkcs11.so --keypairgen --key-type rsa:2048 --pin banzai --token-label bank-vaults --label bank-vaults
</span></span></code></pre></div></li><li>
<p>Check that you got a keypair object in slot 0:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>pkcs11-tool --list-objects
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>Using slot <span style="color:#0000cf;font-weight:700">0</span> with a present token <span style="color:#ce5c00;font-weight:700">(</span>0x0<span style="color:#ce5c00;font-weight:700">)</span>
</span></span><span style="display:flex"><span>Public Key Object<span style="color:#000;font-weight:700">;</span> RSA <span style="color:#0000cf;font-weight:700">2048</span> bits
</span></span><span style="display:flex"><span>  label:      bank-vaults
</span></span><span style="display:flex"><span>  ID:         a9548075b20243627e971873826ead172e932359
</span></span><span style="display:flex"><span>  Usage:      encrypt, verify, wrap
</span></span><span style="display:flex"><span>  Access:     none
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>pkcs15-tool --list-keys
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>Using reader with a card: Nitrokey Nitrokey HSM
</span></span><span style="display:flex"><span>Private RSA Key <span style="color:#ce5c00;font-weight:700">[</span>bank-vaults<span style="color:#ce5c00;font-weight:700">]</span>
</span></span><span style="display:flex"><span>  Object Flags   : <span style="color:#ce5c00;font-weight:700">[</span>0x03<span style="color:#ce5c00;font-weight:700">]</span>, private, modifiable
</span></span><span style="display:flex"><span>  Usage          : <span style="color:#ce5c00;font-weight:700">[</span>0x0E<span style="color:#ce5c00;font-weight:700">]</span>, decrypt, sign, signRecover
</span></span><span style="display:flex"><span>  Access Flags   : <span style="color:#ce5c00;font-weight:700">[</span>0x1D<span style="color:#ce5c00;font-weight:700">]</span>, sensitive, alwaysSensitive, neverExtract, <span style="color:#204a87">local</span>
</span></span><span style="display:flex"><span>  ModLength      : <span style="color:#0000cf;font-weight:700">2048</span>
</span></span><span style="display:flex"><span>  Key ref        : <span style="color:#0000cf;font-weight:700">1</span> <span style="color:#ce5c00;font-weight:700">(</span>0x01<span style="color:#ce5c00;font-weight:700">)</span>
</span></span><span style="display:flex"><span>  Native         : yes
</span></span><span style="display:flex"><span>  Auth ID        : <span style="color:#0000cf;font-weight:700">01</span>
</span></span><span style="display:flex"><span>  ID             : a9548075b20243627e971873826ead172e932359
</span></span><span style="display:flex"><span>  MD:guid        : a6b2832c-1dc5-f4ef-bb0f-7b3504f67015
</span></span></code></pre></div></li><li>
<p>If you are testing the HSM on macOS, <a href="#nitrokey-minikube">setup minikube</a>. Otherwise, continue with the next step.</p></li><li>
<p>Configure the operator to use NitroKey HSM for unsealing.</p><p>You must adjust the <code>unsealConfig</code> section in the vault-operator configuration, so the operator can communicate with OpenSC HSM devices correctly. Adjust your configuration based on the following snippet:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># This example relies on an OpenSC HSM (NitroKey HSM) device initialized and plugged in to the Kubernetes Node.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">unsealConfig</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">hsm</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># OpenSC daemon is needed in this case to communicate with the device</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">daemon</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># The HSM SO module path (opensc is built into the bank-vaults image)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">modulePath</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/usr/lib/opensc-pkcs11.so</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># For OpenSC slotId is the preferred way instead of tokenLabel</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># (OpenSC appends/prepends some extra stuff to labels)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">slotId</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">pin</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">banzai</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># This can be specified in the BANK_VAULTS_HSM_PIN environment variable as well, from a Secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">keyLabel</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bank-vaults</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li><li>
<p><a href="#node-setup">Configure your Kubernetes node</a> that has the HSM attached so Bank-Vaults can access it.</p></li></ol><h2 id="nitrokey-minikube">Setup on Minikube for testing (optional)</h2><p>On macOS where you run Docker in VMs you need to do some extra steps before mounting your HSM device to Kubernetes.
Complete the following steps to mount NitroKey into the <code>minikube</code> Kubernetes cluster:</p><ol>
<li>
<p>Make sure that the Oracle VM VirtualBox Extension Pack for USB 2.0 support is installed.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>VBoxManage list extpacks
</span></span></code></pre></div></li><li>
<p>Remove the HSM device from your computer if it is already plugged in.</p></li><li>
<p>Specify VirtualBox as the VM backend for Minikube.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>minikube config <span style="color:#204a87">set</span> vm-driver virtualbox
</span></span></code></pre></div></li><li>
<p>Create a minikube cluster with the virtualbox driver and stop it, so you can modify the VM.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>minikube start
</span></span><span style="display:flex"><span>minikube stop
</span></span></code></pre></div></li><li>
<p>Enable USB 2.0 support for the minikube VM.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>VBoxManage modifyvm minikube --usbehci on
</span></span></code></pre></div></li><li>
<p>Find the vendorid and productid for your Nitrokey HSM device.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>VBoxManage list usbhost
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#000">VENDORID</span><span style="color:#ce5c00;font-weight:700">=</span>0x20a0
</span></span><span style="display:flex"><span><span style="color:#000">PRODUCTID</span><span style="color:#ce5c00;font-weight:700">=</span>0x4230
</span></span></code></pre></div></li><li>
<p>Create a filter for it.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>VBoxManage usbfilter add <span style="color:#0000cf;font-weight:700">1</span> --target minikube --name <span style="color:#4e9a06">&#34;Nitrokey HSM&#34;</span> --vendorid <span style="color:#4e9a06">${</span><span style="color:#000">VENDORID</span><span style="color:#4e9a06">}</span> --productid <span style="color:#4e9a06">${</span><span style="color:#000">PRODUCTID</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div></li><li>
<p>Restart the minikube VM.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>minikube start
</span></span></code></pre></div></li><li>
<p>Plug in the USB device.</p></li><li>
<p>Check that minikube captured your NitorKey HSM.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>minikube ssh lsusb <span style="color:#000;font-weight:700">|</span> grep <span style="color:#4e9a06">${</span><span style="color:#000">VENDORID</span><span style="color:#000;font-weight:700">:</span><span style="color:#000">2</span><span style="color:#4e9a06">}</span>:<span style="color:#4e9a06">${</span><span style="color:#000">PRODUCTID</span><span style="color:#000;font-weight:700">:</span><span style="color:#000">2</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div></li></ol><p>Now your <code>minikube</code> Kubernetes cluster has access to the HSM device through USB.</p><h2 id="node-setup">Kubernetes node setup</h2><p>Some HSM vendors offer network daemons to enhance the reach of their HSM equipment to different servers. Unfortunately, there is no networking standard defined for PKCS11 access and thus currently Bank-Vaults has to be scheduled to the same node where the HSM device is attached directly (if not using a Cloud HSM).</p><p>Since the HSM is a hardware device connected to a physical node, Bank-Vaults has to find its way to that node. To make this work, create an HSM <a href="https://kubernetes.io/docs/tasks/administer-cluster/extended-resource-node/">extended resource</a> on the Kubernetes nodes for which the HSM device is plugged in. Extended resources must be advertised in integer amounts, for example, a Node can advertise four HSM devices, but not 4.5.</p><ol>
<li>
<p>You need to patch the node to specify that it has an HSM device as a resource.
Because of the integer constraint and because all Bank-Vaults related Pods has to land on a Node where an HSM resource is available we need to advertise two units for 1 device, one will be allocated by each Vault Pod and one by the Configurer. If you would like to run Vault in HA mode - multiple Vault instances in different nodes - you will need multiple HSM devices plugged into those nodes, having the same key and slot setup.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl proxy <span style="color:#000;font-weight:700">&amp;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#000">NODE</span><span style="color:#ce5c00;font-weight:700">=</span>minikube
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>curl --header <span style="color:#4e9a06">&#34;Content-Type: application/json-patch+json&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    --request PATCH <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    --data <span style="color:#4e9a06">&#39;[{&#34;op&#34;: &#34;add&#34;, &#34;path&#34;: &#34;/status/capacity/nitrokey.com~1hsm&#34;, &#34;value&#34;: &#34;2&#34;}]&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    http://localhost:8001/api/v1/nodes/<span style="color:#4e9a06">${</span><span style="color:#000">NODE</span><span style="color:#4e9a06">}</span>/status
</span></span></code></pre></div><p>From now on, you can request the <code>nitrokey.com/hsm</code> resource <a href="https://kubernetes.io/docs/tasks/configure-pod-container/extended-resource/">in the PodSpec</a></p></li><li>
<p>Include the <code>nitrokey.com/hsm</code> resource in your PodSpec:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># If using the NitroKey HSM example, that resource has to be part of the resource scheduling request.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">resources</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">hsmDaemon</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">requests</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">cpu</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">100m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">memory</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">64Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">nitrokey.com/hsm</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">limits</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">cpu</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">200m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">memory</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">128Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">nitrokey.com/hsm</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li><li>
<p>Apply the modified setup from scratch:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl delete vault vault
</span></span><span style="display:flex"><span>kubectl delete pvc vault-file-vault-0
</span></span><span style="display:flex"><span>kubectl delete secret vault-unseal-keys
</span></span><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/banzaicloud/bank-vaults/master/operator/deploy/cr-hsm-nitrokey.yaml
</span></span></code></pre></div></li><li>
<p>Check the logs that unsealing uses the NitroKey HSM device. Run the following command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl logs -f vault-0 bank-vaults
</span></span></code></pre></div><p>The output should be something like:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:29Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;HSM Information {CryptokiVersion:{Major:2 Minor:20} ManufacturerID:OpenSC Project Flags:0 LibraryDescription:OpenSC smartcard framework LibraryVersion:{Major:0 Minor:20}}&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:29Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;HSM Searching for slot in HSM slots [{ctx:0xc0000c0318 id:0}]&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:29Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;found HSM slot 0 in HSM by slot ID&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:29Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;HSM TokenInfo {Label:bank-vaults (UserPIN)\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00 ManufacturerID:www.CardContact.de Model:PKCS#15 emulated SerialNumber:DENK0200074 Flags:1037 MaxSessionCount:0 SessionCount:0 MaxRwSessionCount:0 RwSessionCount:0 MaxPinLen:15 MinPinLen:6 TotalPublicMemory:18446744073709551615 FreePublicMemory:18446744073709551615 TotalPrivateMemory:18446744073709551615 FreePrivateMemory:18446744073709551615 HardwareVersion:{Major:24 Minor:13} FirmwareVersion:{Major:3 Minor:3} UTCTime:\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00}&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:29Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;HSM SlotInfo for slot 0: {SlotDescription:Nitrokey Nitrokey HSM (DENK02000740000         ) 00 00 ManufacturerID:Nitrokey Flags:7 HardwareVersion:{Major:0 Minor:0} FirmwareVersion:{Major:0 Minor:0}}&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:29Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;found objects with label \&#34;bank-vaults\&#34; in HSM&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:29Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;this HSM device doesn&#39;t support encryption, extracting public key and doing encrytion on the computer&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:29Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;no storage backend specified for HSM, using on device storage&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:29Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;joining leader vault...&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:29Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;vault metrics exporter enabled: :9091/metrics&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#ce5c00;font-weight:700">[</span>GIN-debug<span style="color:#ce5c00;font-weight:700">]</span> <span style="color:#ce5c00;font-weight:700">[</span>WARNING<span style="color:#ce5c00;font-weight:700">]</span> Running in <span style="color:#4e9a06">&#34;debug&#34;</span> mode. Switch to <span style="color:#4e9a06">&#34;release&#34;</span> mode in production.
</span></span><span style="display:flex"><span>- using env:	<span style="color:#204a87">export</span> <span style="color:#000">GIN_MODE</span><span style="color:#ce5c00;font-weight:700">=</span>release
</span></span><span style="display:flex"><span>- using code:	gin.SetMode<span style="color:#ce5c00;font-weight:700">(</span>gin.ReleaseMode<span style="color:#ce5c00;font-weight:700">)</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#ce5c00;font-weight:700">[</span>GIN-debug<span style="color:#ce5c00;font-weight:700">]</span> GET    /metrics                  --&gt; github.com/gin-gonic/gin.WrapH.func1 <span style="color:#ce5c00;font-weight:700">(</span><span style="color:#0000cf;font-weight:700">3</span> handlers<span style="color:#ce5c00;font-weight:700">)</span>
</span></span><span style="display:flex"><span><span style="color:#ce5c00;font-weight:700">[</span>GIN-debug<span style="color:#ce5c00;font-weight:700">]</span> Listening and serving HTTP on :9091
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:30Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;initializing vault...&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:30Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;initializing vault&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:31Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;unseal key stored in key store&#34;</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:700">=</span>vault-unseal-0
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:31Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;unseal key stored in key store&#34;</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:700">=</span>vault-unseal-1
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:32Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;unseal key stored in key store&#34;</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:700">=</span>vault-unseal-2
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:32Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;unseal key stored in key store&#34;</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:700">=</span>vault-unseal-3
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:33Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;unseal key stored in key store&#34;</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:700">=</span>vault-unseal-4
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:33Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;root token stored in key store&#34;</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:700">=</span>vault-root
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:33Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;vault is sealed, unsealing&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;2020-03-04T13:32:39Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:700">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;successfully unsealed vault&#34;</span>
</span></span></code></pre></div></li><li>
<p>Find the unseal keys and the root token on the HSM:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>pkcs11-tool --list-objects
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>Using slot <span style="color:#0000cf;font-weight:700">0</span> with a present token <span style="color:#ce5c00;font-weight:700">(</span>0x0<span style="color:#ce5c00;font-weight:700">)</span>
</span></span><span style="display:flex"><span>Public Key Object<span style="color:#000;font-weight:700">;</span> RSA <span style="color:#0000cf;font-weight:700">2048</span> bits
</span></span><span style="display:flex"><span>  label:      bank-vaults
</span></span><span style="display:flex"><span>  ID:         a9548075b20243627e971873826ead172e932359
</span></span><span style="display:flex"><span>  Usage:      encrypt, verify, wrap
</span></span><span style="display:flex"><span>  Access:     none
</span></span><span style="display:flex"><span>Data object <span style="color:#0000cf;font-weight:700">2168561792</span>
</span></span><span style="display:flex"><span>  label:          <span style="color:#4e9a06">&#39;vault-test&#39;</span>
</span></span><span style="display:flex"><span>  application:    <span style="color:#4e9a06">&#39;vault-test&#39;</span>
</span></span><span style="display:flex"><span>  app_id:         &lt;empty&gt;
</span></span><span style="display:flex"><span>  flags:           modifiable
</span></span><span style="display:flex"><span>Data object <span style="color:#0000cf;font-weight:700">2168561168</span>
</span></span><span style="display:flex"><span>  label:          <span style="color:#4e9a06">&#39;vault-unseal-0&#39;</span>
</span></span><span style="display:flex"><span>  application:    <span style="color:#4e9a06">&#39;vault-unseal-0&#39;</span>
</span></span><span style="display:flex"><span>  app_id:         &lt;empty&gt;
</span></span><span style="display:flex"><span>  flags:           modifiable
</span></span><span style="display:flex"><span>Data object <span style="color:#0000cf;font-weight:700">2168561264</span>
</span></span><span style="display:flex"><span>  label:          <span style="color:#4e9a06">&#39;vault-unseal-1&#39;</span>
</span></span><span style="display:flex"><span>  application:    <span style="color:#4e9a06">&#39;vault-unseal-1&#39;</span>
</span></span><span style="display:flex"><span>  app_id:         &lt;empty&gt;
</span></span><span style="display:flex"><span>  flags:           modifiable
</span></span><span style="display:flex"><span>Data object <span style="color:#0000cf;font-weight:700">2168561360</span>
</span></span><span style="display:flex"><span>  label:          <span style="color:#4e9a06">&#39;vault-unseal-2&#39;</span>
</span></span><span style="display:flex"><span>  application:    <span style="color:#4e9a06">&#39;vault-unseal-2&#39;</span>
</span></span><span style="display:flex"><span>  app_id:         &lt;empty&gt;
</span></span><span style="display:flex"><span>  flags:           modifiable
</span></span><span style="display:flex"><span>Data object <span style="color:#0000cf;font-weight:700">2168562304</span>
</span></span><span style="display:flex"><span>  label:          <span style="color:#4e9a06">&#39;vault-unseal-3&#39;</span>
</span></span><span style="display:flex"><span>  application:    <span style="color:#4e9a06">&#39;vault-unseal-3&#39;</span>
</span></span><span style="display:flex"><span>  app_id:         &lt;empty&gt;
</span></span><span style="display:flex"><span>  flags:           modifiable
</span></span><span style="display:flex"><span>Data object <span style="color:#0000cf;font-weight:700">2168562400</span>
</span></span><span style="display:flex"><span>  label:          <span style="color:#4e9a06">&#39;vault-unseal-4&#39;</span>
</span></span><span style="display:flex"><span>  application:    <span style="color:#4e9a06">&#39;vault-unseal-4&#39;</span>
</span></span><span style="display:flex"><span>  app_id:         &lt;empty&gt;
</span></span><span style="display:flex"><span>  flags:           modifiable
</span></span><span style="display:flex"><span>Data object <span style="color:#0000cf;font-weight:700">2168562496</span>
</span></span><span style="display:flex"><span>  label:          <span style="color:#4e9a06">&#39;vault-root&#39;</span>
</span></span><span style="display:flex"><span>  application:    <span style="color:#4e9a06">&#39;vault-root&#39;</span>
</span></span><span style="display:flex"><span>  app_id:         &lt;empty&gt;
</span></span><span style="display:flex"><span>  flags:           modifiable
</span></span></code></pre></div></li><li>
<p>If you don&rsquo;t need the encryption keys or the unseal keys on the HSM anymore, you can delete them with the following commands:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#000">PIN</span><span style="color:#ce5c00;font-weight:700">=</span>banzai
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Delete the unseal keys and the root token</span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">for</span> label in <span style="color:#4e9a06">&#34;vault-test&#34;</span> <span style="color:#4e9a06">&#34;vault-root&#34;</span> <span style="color:#4e9a06">&#34;vault-unseal-0&#34;</span> <span style="color:#4e9a06">&#34;vault-unseal-1&#34;</span> <span style="color:#4e9a06">&#34;vault-unseal-2&#34;</span> <span style="color:#4e9a06">&#34;vault-unseal-3&#34;</span> <span style="color:#4e9a06">&#34;vault-unseal-4&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">do</span>
</span></span><span style="display:flex"><span>  pkcs11-tool --delete-object --type data --label <span style="color:#4e9a06">${</span><span style="color:#000">label</span><span style="color:#4e9a06">}</span> --pin <span style="color:#4e9a06">${</span><span style="color:#000">PIN</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">done</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Delete the encryption key</span>
</span></span><span style="display:flex"><span>pkcs11-tool --delete-object --type privkey --label bank-vaults --pin <span style="color:#4e9a06">${</span><span style="color:#000">PIN</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div></li></ol></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-6aa446bed53e7dbb32f03693a7de4464">11.2 - SoftHSM support for testing</h1><p>You can use <a href="https://github.com/opendnssec/SoftHSMv2">SoftHSMv2</a> to implement and test software interacting with PKCS11 implementations. You can install it on macOS by running the following commands:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Initializing SoftHSM to be able to create a working example (only for dev),</span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># sharing the HSM device is emulated with a pre-created keypair in the image.</span>
</span></span><span style="display:flex"><span>brew install softhsm
</span></span><span style="display:flex"><span>softhsm2-util --init-token --free --label bank-vaults --so-pin banzai --pin banzai
</span></span><span style="display:flex"><span>pkcs11-tool --module /usr/local/lib/softhsm/libsofthsm2.so --keypairgen --key-type rsa:2048 --pin banzai --token-label bank-vaults --label bank-vaults
</span></span></code></pre></div><p>To interact with SoftHSM when using the <code>vault-operator</code>, include the following <code>unsealConfig</code> snippet in the Vault CR:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># This example relies on the SoftHSM device initialized in the Docker image.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">unsealConfig</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">hsm</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># The HSM SO module path (softhsm is built into the bank-vaults image)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">modulePath</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/usr/lib/softhsm/libsofthsm2.so </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">tokenLabel</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bank-vaults</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">pin</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">banzai</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">keyLabel</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bank-vaults</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>To run the whole SoftHSM based example in Kubernetes, run the following commands:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl create namespace vault-infra
</span></span><span style="display:flex"><span>helm upgrade --install vault-operator banzaicloud-stable/vault-operator --namespace vault-infra
</span></span><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/banzaicloud/bank-vaults/master/operator/deploy/cr-hsm-softhsm.yaml
</span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-d1d67302dbc57a8fb46426ac0075ee73">12 - The CLI tool</h1><p>The <code>bank-vaults</code> CLI tool is to help automate the setup and management of HashiCorp Vault.</p><p>Features:</p><ul>
<li>Initializes Vault and stores the root token and unseal keys in one of the followings:
<ul>
<li>AWS KMS keyring (backed by S3)</li><li>Azure Key Vault</li><li>Google Cloud KMS keyring (backed by GCS)</li><li>Alibaba Cloud KMS (backed by OSS)</li><li>Kubernetes Secrets (should be used only for development purposes)</li><li>Dev Mode (useful for <code>vault server -dev</code> dev mode Vault servers)</li><li>Files (backed by files, should be used only for development purposes)</li></ul></li><li>Automatically unseals Vault with these keys</li><li>In addition to the <a href="https://www.vaultproject.io/docs/configuration/index.html">standard Vault configuration</a>, the operator and CLI can continuously configure Vault using an <a href="/docs/external-configuration/">external YAML/JSON configuration</a>
<ul>
<li>If the configuration is updated Vault will be reconfigured</li><li>It supports configuring Vault secret engines, plugins, auth methods, and policies</li></ul></li></ul><p>The <code>bank-vaults</code> CLI command needs certain <a href="/docs/cloud-permissions/">cloud permissions</a> to function properly (init, unseal, configuration).</p></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-64ae4cd33575303212292e924408942f">13 - The Go library</h1><p>The <a href="https://github.com/bank-vaults/bank-vaults/">Bank-Vaults repository</a> contains several Go packages for interacting with Vault, these packages are organized into the <code>sdk</code> Go module, which can be pulled in with <code>go get github.com/bank-vaults/bank-vaults/pkg/sdk</code> and is versioned by the <code>pkg/sdk/vX.Y.Z</code> Git tags:</p><ul>
<li>
<p><a href="https://github.com/bank-vaults/bank-vaults/tree/master/pkg/sdk/auth">pkg/sdk/auth</a></p><p>Stores JWT bearer tokens in Vault.</p><p>(<em>NOTE: The Gin handler has been moved out to <a href="https://github.com/banzaicloud/gin-utilz/tree/master/auth">gin-utilz</a></em> )</p><p><img src="authn-vault-flow.png" alt="authn"></p></li><li>
<p><a href="https://github.com/bank-vaults/bank-vaults/tree/master/pkg/sdk/vault">pkg/sdk/vault</a></p><p>A wrapper for the official Vault client with automatic token renewal, and Kubernetes support.</p><p><img src="token-request-vault-flow.png" alt="token"></p></li><li>
<p><a href="https://github.com/bank-vaults/bank-vaults/tree/master/pkg/sdk/db">pkg/sdk/db</a></p><p>A helper for creating database source strings (MySQL/PostgreSQL) with database credentials dynamically based on configured Vault roles (instead of <code>username:password</code>).</p><p><img src="vault-mySQL.gif" alt="token"></p></li><li>
<p><a href="https://github.com/bank-vaults/bank-vaults/tree/master/pkg/sdk/tls">pkg/sdk/tls</a></p><p>A simple package to generate self-signed TLS certificates. Useful for bootstrapping situations, when you can&rsquo;t use Vault&rsquo;s <a href="https://www.vaultproject.io/docs/secrets/pki/index.html">PKI secret engine</a>.</p></li></ul><h2 id="examples-for-using-the-library-part">Examples for using the library part</h2><p>Some examples are in <code>cmd/examples/main.go</code></p><ul>
<li><a href="https://github.com/bank-vaults/bank-vaults/blob/master/cmd/examples/main.go#L17">Vault client example</a></li><li><a href="https://github.com/bank-vaults/bank-vaults/blob/master/cmd/examples/main.go#L45">Dynamic secrets for MySQL example with Gorm</a></li><li><a href="https://github.com/bank-vaults/bank-vaults/blob/master/cmd/examples/main.go#L53">JWTAuth tokens example with a Gin middleware</a></li></ul></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-e92236d181fd38f552e14b0770227143">14 - Monitoring</h1><p>At Banzai Cloud we prefer Prometheus for monitoring and use it also for Vault. If you configure, Vault can expose metrics through <a href="https://www.vaultproject.io/docs/configuration/telemetry.html#statsd">statsd</a>. Both the <a href="https://github.com/bank-vaults/bank-vaults/tree/master/charts/vault">Helm chart</a> and the Vault Operator installs the <a href="https://github.com/prometheus/statsd_exporter">Prometheus StatsD exporter</a> and annotates the pods correctly with Prometheus annotations so Prometheus can discover and scrape them. All you have to do is to put the telemetry stanza into your Vault configuration:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">telemetry</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">statsd_address</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">localhost:9125</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>You may find the <a href="https://grafana.com/grafana/dashboards/240">generic Prometheus kubernetes client Go Process runtime monitoring dashboard</a> useful for monitoring the webhook or any other Go process.</p><p>To monitor the <a href="/docs/mutating-webhook/">mutating webhook</a>, see <a href="/docs/mutating-webhook/monitoring/">Monitoring the Webhook with Grafana and Prometheus</a>.</p></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-da3a81be596bb98f259c9afae940c6b4">15 - Annotations and labels</h1><h2 id="annotations">Annotations</h2><p>The Vault Operator supports annotating most of the resources it creates using a set of fields in the Vault Specs:</p><h3 id="common-vault-resources-annotations">Common Vault Resources annotations</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault.banzaicloud.com/v1alpha1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">annotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">example.com/test</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;something&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>These annotations are common to all Vault Created resources</p><ul>
<li>Vault Statefulset</li><li>Vault Pods</li><li>Vault Configurer Deployment</li><li>Vault Configurer Pod</li><li>Vault Services</li><li>Vault Configurer Service</li><li>Vault TLS Secret</li></ul><h3 id="vault-statefulset-resources-annotations">Vault Statefulset Resources annotations</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault.banzaicloud.com/v1alpha1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">vaultAnnotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">example.com/vault</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>These annotations are common to all Vault Statefulset Created resources</p><ul>
<li>Vault Statefulset</li><li>Vault Pods</li><li>Vault Services</li><li>Vault TLS Secret</li></ul><p>These annotations will override any annotation defined in the common set</p><h3 id="vault-configurer-deployment-resources-annotations">Vault Configurer deployment Resources annotations</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault.banzaicloud.com/v1alpha1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">vaultConfigurerAnnotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">example.com/vaultConfigurer</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>These annotations are common to all Vault Configurer Deployment Created resources</p><ul>
<li>Vault Configurer Deployment</li><li>Vault Configurer Pod</li><li>Vault Configurer Service</li></ul><p>These annotations will override any annotation defined in the common set</p><h3 id="etcd-crd-annotations">ETCD CRD Annotations</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault.banzaicloud.com/v1alpha1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">etcdAnnotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">etcd.database.coreos.com/scope</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clusterwide</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>These annotations are set <em>only</em> on the etcdcluster resource</p><h3 id="etcd-pods-annotations">ETCD PODs Annotations</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault.banzaicloud.com/v1alpha1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">etcdPodAnnotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">backup.velero.io/backup-volumes</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;YOUR_VOLUME_NAME&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>These annotations are set <em>only</em> on the etcd pods created by the etcd-operator</p><h2 id="labels">Labels</h2><p>The Vault Operator support labelling most of the resources it creates using a set of fields in the Vault Specs:</p><h3 id="vault-statefulset-resources-labels">Vault Statefulset Resources labels</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault.banzaicloud.com/v1alpha1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">vaultLabels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">example.com/log-format</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;json&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>These Labels are common to all Vault Statefulset Created resources</p><ul>
<li>Vault Statefulset</li><li>Vault Pods</li><li>Vault Services</li><li>Vault TLS Secret</li></ul><h3 id="vault-configurer-deployment-resources-labels">Vault Configurer deployment Resources labels</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault.banzaicloud.com/v1alpha1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">vaultConfigurerLabels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">example.com/log-format</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>These labels are common to all Vault Configurer Deployment Created resources</p><ul>
<li>Vault Configurer Deployment</li><li>Vault Configurer Pod</li><li>Vault Configurer Service</li></ul></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-3309e9b896978010784680d5d7c7c406">16 - Watching External Secrets</h1><p>In some cases, you might have to restart the Vault Statefulset when secrets that are not managed by the operator control are changed. For example:</p><ul>
<li>Cert-Manager managing a public Certificate for vault using Let&rsquo;s Encrypt.</li><li>Cloud IAM Credentials created with an external tool (like terraform) to allow vault to interact with the cloud services.</li></ul><p>The operator can watch a set of secrets in the namespace of the Vault resource using either a list of label selectors or an annotations selector. When the content of any of those secrets changes, the operator updates the statefulset and triggers a rolling restart.</p><h2 id="configure-label-selectors">Configure label selectors</h2><p>Set the secrets to watch using the <strong>watchedSecretsAnnotations</strong> and <strong>watchedSecretsLabels</strong> fields in your Vault custom resource.</p><blockquote>
<p>Note: For cert-manager 0.11 or newer, use the <code>watchedSecretsAnnotations</code> field.</p></blockquote><p>In the following example, the Vault StatefulSet is restarted when:</p><ul>
<li>A secret with label <em>certmanager.k8s.io/certificate-name: vault-letsencrypt-cert</em> changes its contents (cert-manager 0.10 and earlier).</li><li>A secret with label <em>test.com/scope: gcp</em> AND <em>test.com/credentials: vault</em> changes its contents.</li><li>A secret with annotation <em>cert-manager.io/certificate-name: vault-letsencrypt-cert</em> changes its contents (cert-manager 0.11 and newer).</li></ul><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">watchedSecretsLabels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">certmanager.k8s.io/certificate-name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-letsencrypt-cert</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">test.com/scope</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcp</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">test.com/credentials</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">watchedSecretsAnnotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">cert-manager.io/certificate-name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-letsencrypt-cert</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>The operator controls the restart of the statefulset by adding an <em>annotation</em> to the <em>spec.template</em> of the vault resource</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get -n vault statefulset vault -o json <span style="color:#000;font-weight:700">|</span> jq .spec.template.metadata.annotations
</span></span><span style="display:flex"><span><span style="color:#ce5c00;font-weight:700">{</span>
</span></span><span style="display:flex"><span>  <span style="color:#4e9a06">&#34;prometheus.io/path&#34;</span>: <span style="color:#4e9a06">&#34;/metrics&#34;</span>,
</span></span><span style="display:flex"><span>  <span style="color:#4e9a06">&#34;prometheus.io/port&#34;</span>: <span style="color:#4e9a06">&#34;9102&#34;</span>,
</span></span><span style="display:flex"><span>  <span style="color:#4e9a06">&#34;prometheus.io/scrape&#34;</span>: <span style="color:#4e9a06">&#34;true&#34;</span>,
</span></span><span style="display:flex"><span>  <span style="color:#4e9a06">&#34;vault.banzaicloud.io/watched-secrets-sum&#34;</span>: <span style="color:#4e9a06">&#34;ff1f1c79a31f76c68097975977746be9b85878f4737b8ee5a9d6ee3c5169b0ba&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#ce5c00;font-weight:700">}</span>
</span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-06363047ee9e9f418fb8351eb60a4059">17 - Tips and tricks</h1><p>The following section lists some questions, problems, and tips that came up on the <a href="https://pages.banzaicloud.com/invite-slack">Bank-Vaults Slack channel</a>.</p><h2 id="login-to-the-vault-web-ui">Login to the Vault web UI</h2><p>To login to the Vault web UI, you can use the root token, or any configured authentication backend.</p><h2 id="can-changing-the-vault-cr-delete-the-vault-instance-and-data">Can changing the vault CR delete the Vault instance and data?</h2><p>Bank-Vaults never ever deletes the Vault instance from the cluster. However, if you delete the Vault CR, then the Kubernetes garbage controller deletes the vault pods. You are recommended to <a href="/docs/backup/">keep backups</a>.</p><h2 id="set-default-for-vaultsecuritybanzaicloudiovault-addr">Set default for vault.security.banzaicloud.io/vault-addr</h2><p>You can set the default settings for <code>vault.security.banzaicloud.io/vault-addr</code> so you don&rsquo;t have to specify it in every PodSpec. Just set the VAULT_ADDR in the env section: <a href="https://github.com/bank-vaults/bank-vaults/blob/3c89e831bdb21b2733680f13ceec7ac4b6e3f892/charts/vault-secrets-webhook/values.yaml#L37">https://github.com/bank-vaults/bank-vaults/blob/3c89e831bdb21b2733680f13ceec7ac4b6e3f892/charts/vault-secrets-webhook/values.yaml#L37</a></p></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-3ade8a7754000f0595f59f570b1f9a85">18 - Support</h1><p>Bank-Vaults is a <strong>Vault</strong> swiss-army knife: a K8s operator, Go client with automatic token renewal, automatic configuration, multiple unseal options and more. A CLI tool to init, unseal and configure Vault (auth methods, secret engines). Direct secret injection into Pods.</p><h2 id="community-support">Community support</h2><p>If you encounter problems while using Bank-Vaults that the documentation does not address, <a href="https://github.com/bank-vaults/bank-vaults/issues">open an issue</a> or talk to us on the Emerging Tech Community Slack channel <a href="https://emergingtechcommunity.slack.com/">#bank-vaults</a>.</p></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-1bf07101845de6da98f1c948b82c5ce0">19 - Development</h1><p>This guide explains the steps and requirements for developing Bank-Vaults projects.</p><h2 id="quickstart">Quickstart</h2><p>Install <a href="https://nixos.org/download.html">Nix</a>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>sh &lt;<span style="color:#ce5c00;font-weight:700">(</span>curl -L https://nixos.org/nix/install<span style="color:#ce5c00;font-weight:700">)</span> --daemon
</span></span></code></pre></div><p>Install <a href="https://direnv.net/docs/installation.html">direnv</a>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>curl -sfL https://direnv.net/install.sh <span style="color:#000;font-weight:700">|</span> bash
</span></span></code></pre></div><p>Load direnv to your shell:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#204a87">eval</span> <span style="color:#4e9a06">&#34;\$(direnv hook bash)&#34;</span>
</span></span></code></pre></div><p><em>Don&rsquo;t forget to add the above line to your shell rc file.</em></p><p>Clone a project and enter its directory, then run:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>direnv allow
</span></span></code></pre></div><p><strong>You are ready to go!</strong></p><h2 id="development-environment">Development environment</h2><p>Bank-Vaults uses <a href="https://nixos.org/">Nix</a> to create a portable development environment across developer machines and CI,
ensuring a certain level of reproducibility and minimizing environmental issues during development.</p><p>Follow the <a href="https://nixos.org/download.html">official installation instructions</a> to download and install Nix.</p><p><em>Alternatively, you can use <a href="https://github.com/DeterminateSystems/nix-installer">this</a> installer by <a href="https://github.com/DeterminateSystems">Determinate Systems</a>.</em></p><p>In addition to Nix, you also need to install <a href="https://direnv.net/">direnv</a> by following the <a href="https://direnv.net/docs/installation.html">installation instructions</a>.</p><p><em>Follow the onscreen instructions to add direnv&rsquo;s hook to your shell. You may also need to restart your shell.</em></p><p>After installing both Nix and direnv, you will be ready to develop Bank-Vaults projects.</p><p>Check out one of the repositories and run <code>direnv allow</code> upon entering the directory.
(You only need to do this the first time, and then every time the <code>.envrc</code> file in the project changes.)</p><p>Each project should have additional development information in its README, but generally,
you will find a <code>Makefile</code> in each project with the necessary targets for development.</p><p>Finally, each project contains instructions on how to develop the project <em>without</em> using Nix.
However, these instructions are offered as a best-effort basis and may not always work, as maintainers do not test them regularly.</p></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-99612595f9f698dd585c96dcc8298d9a">20 - Contributing</h1><p>If you find this project useful here&rsquo;s how you can help:</p><ul>
<li>If you use Bank-Vaults in a production environment, add yourself to the <a href="https://github.com/bank-vaults/bank-vaults/blob/master/ADOPTERS.md">list of production adopters</a>.</li><li>Help new users with issues they may encounter on our <a href="https://github.com/bank-vaults/bank-vaults/issues">GitHub issues page</a> or in the <a href="https://pages.banzaicloud.com/invite-slack">#bank-vaults community Slack channel</a></li><li>Support the development of this project and <a href="https://github.com/bank-vaults/bank-vaults/stargazers">star our GitHub repo</a>!</li><li>Send a pull request with your new features and bug fixes.</li></ul><h2 id="development-environment">Development environment</h2><p>In your development environment you can use file mode for testing <code>bank-vaults</code> cli-tool:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>vault server -config vault.hcl
</span></span></code></pre></div><p><strong>example vault.hcl:</strong></p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#000">api_addr</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#4e9a06">&#34;http://localhost:8200&#34;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>storage <span style="color:#4e9a06">&#34;file&#34;</span> <span style="color:#ce5c00;font-weight:700">{</span>
</span></span><span style="display:flex"><span>  <span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#4e9a06">&#34;/tmp/vault&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#ce5c00;font-weight:700">}</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>listener <span style="color:#4e9a06">&#34;tcp&#34;</span> <span style="color:#ce5c00;font-weight:700">{</span>
</span></span><span style="display:flex"><span>  <span style="color:#000">address</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#4e9a06">&#34;0.0.0.0:8200&#34;</span>
</span></span><span style="display:flex"><span>  <span style="color:#000">tls_disable</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#204a87">true</span>
</span></span><span style="display:flex"><span><span style="color:#ce5c00;font-weight:700">}</span>
</span></span></code></pre></div><p>Now you have a running vault server which is uninitialized and unsealed you can init and unseal it with <code>bank-vaults</code> cli-tool and unseal keys will be stored to a local file:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span><span style="color:#000">VAULT_ADDR</span><span style="color:#ce5c00;font-weight:700">=</span>http://127.0.0.1:8200 bank-vaults unseal --init --mode file
</span></span></code></pre></div><p>The unseal keys and root token are stored your working directory:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="display:flex"><span>vault-root
</span></span><span style="display:flex"><span>vault-unseal-0
</span></span><span style="display:flex"><span>vault-unseal-1
</span></span><span style="display:flex"><span>vault-unseal-2
</span></span><span style="display:flex"><span>vault-unseal-3
</span></span><span style="display:flex"><span>vault-unseal-4
</span></span></code></pre></div><h2 id="operator">Operator</h2><p>Developing the operator requires a <em>working Kubernetes cluster</em>, minikube and Docker for Mac Kubernetes will suffice.</p><p>The operator consists of two parts, the <em>bank-vaults sidecar</em> running inside a container and the <em>operator itself</em>.</p><p>You can fire up the operator on your machine, so you can debug it locally (yes you don&rsquo;t have to build a container from it), if your kube context points to the development cluster:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>make operator-up
</span></span></code></pre></div><p>This installs all the necessary RBAC rules and other CRDs that you need to create a Vault instance. If you change the code of the operator you have to <code>CTRL + C</code> this <code>make</code> command and rerun it again.</p><p>Now it is time create a Vault instance for yourself, which you can work on:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f operator/deploy/cr.yaml
</span></span></code></pre></div><p>If you change the <em>bank-vaults sidecar</em> code you have to build a new Docker image from it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#000">DOCKER_LATEST</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#0000cf;font-weight:700">1</span> make docker
</span></span></code></pre></div><p>There are at least four ways to distribute this image in your Kubernetes cluster, by default <code>IfNotPresent</code> image pull policy is used:</p><ul>
<li>If you are using Docker for Mac, you don&rsquo;t have to anything, the Kubernetes cluster and your host shares the same Docker daemon.</li><li>If you are using Minikube with <code>--vm-driver=none</code> (you are probably using Linux) the same applies as for Docker for Mac</li><li>If you are using Minikube with some real <code>vm-driver</code> you have to run <code>eval $(minikube docker-env)</code> before building the Docker image with the <code>make</code> command so you build it with the minikube Docker daemon and the image will be stored there</li><li>Build and re-tag the image and push it to the Docker registry of your choice, dont forget to change the <code>bankVaultsImage</code> attribute in the the Vault Custom Resource YAML file (<code>cr.yaml</code> in this case).</li></ul><p>Restart the containers using the <code>bank-vaults</code> image: Vault instances and the configurer.</p><h2 id="webhook">WebHook</h2><p>This will deploy the webhook via the Helm chart, scale it to 0, start it locally and proxy it into the cluster (somehow similar to <code>operator-up</code> but a bit more complex).</p><p>You will need Helm and <code>kurun</code> <a href="https://github.com/banzaicloud/kurun#installation">installed</a> to run this:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>make webhook-up -j
</span></span></code></pre></div><p>Now you can try out with mutating a Deployment:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f deploy/test-deployment.yaml
</span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-580feadace0eda0383d7052c8aba3630">21 - Maintainer guide</h1><p>This guide explains the tasks and responsibilities of maintainers.</p><h2 id="useful-links">Useful links</h2><ul>
<li>Projects
<ul>
<li><a href="https://github.com/orgs/bank-vaults/projects/4">Dependency upgrades</a></li><li><a href="https://github.com/orgs/bank-vaults/projects/3">Community contributions</a></li><li><a href="https://github.com/orgs/bank-vaults/projects/2">Backlog</a></li></ul></li></ul><h2 id="development">Development</h2><p>Please read the <a href="development.md">Development</a> guide.</p><h2 id="keeping-dependencies-up-to-date">Keeping dependencies up-to-date</h2><p>Bank-Vaults uses <a href="https://github.com/dependabot">Dependabot</a> to automate dependency upgrades.
Dependabot opens pull requests in each repository for every dependency upgrade.</p><p>Maintainers should regularly review and merge these pull requests as a measurement to secure the software supply chain.</p><p>Dependency upgrades are automatically added to <a href="https://github.com/orgs/bank-vaults/projects/4">this</a> project board.</p><p>In addition to keeping project dependencies up-to-date, the development environment needs to be updated from time to time.</p><p>This is currently a manual process:</p><ol>
<li>Run <code>nix flake update</code> in the project repo</li><li>Run <code>versions</code> to see current versions of relevant dependencies</li><li>Update versions in the <code>Makefile</code> to reflect the output of the previous command</li><li>Commit and push changes</li></ol><h2 id="reviewing-community-contributions">Reviewing community contributions</h2><p>As an Open Source project, Bank-Vaults often gets contributions from the community.
Community contributions do not have to go through our normal development process since we basically only need to review and accept/reject the changes.</p><p>Therefore, community contributions are added to a <a href="https://github.com/orgs/bank-vaults/projects/3">separate project board</a>.
Whenever someone outside of the maintainers submits a pull request, add that PR to the project board and adjust its status as appropriate.</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class="row">
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
<a class="text-white" target="_blank" rel="noopener" href="https://github.com/banzaicloud/bank-vaults" aria-label="GitHub">
<i class="fab fa-github"></i>
</a>
</li><li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
<a class="text-white" target="_blank" rel="noopener" href="https://eti.cisco.com/slack" aria-label="Slack">
<i class="fab fa-slack"></i>
</a>
</li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class="text-white">&copy; 2023 Bank-Vaults maintainers All Rights Reserved</small>
</div></div></div></footer></div><script src="/js/main.min.2aff983e9d0d8ecff9ed53e14b657216e2d8d2aff059bf4a5651283020995f1b.js" integrity="sha256-Kv+YPp0Njs/57VPhS2VyFuLY0q/wWb9KVlEoMCCZXxs=" crossorigin="anonymous"></script>
<script src='/js/prism.js'></script>
<script src='/js/tabpane-persist.js'></script>
<script src="/js/tocbot.min.js"></script>
<script type="text/javascript">tocbot.init({tocSelector:".td-toc",contentSelector:".td-content",headingSelector:"h2, h3, h4",ignoreHiddenElements:!0})</script>
</body></html>