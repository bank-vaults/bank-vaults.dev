<!doctype html><html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name="generator" content="Hugo 0.110.0">
<link rel="canonical" type="text/html" href="https://bank-vaults.dev/docs/mutating-webhook/">
<link rel="alternate" type="text/releases" href="https://bank-vaults.dev/docs/mutating-webhook/releases.releases">
<meta name="robots" content="noindex, nofollow">
<link rel="shortcut icon" href="/favicons/favicon.ico">
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">
<title>Mutating Webhook | Bank-Vaults</title><meta name="description" content="Documentation for the Bank-Vaults">
<meta property="og:title" content="Mutating Webhook">
<meta property="og:description" content="Documentation for the Bank-Vaults">
<meta property="og:type" content="website">
<meta property="og:url" content="https://bank-vaults.dev/docs/mutating-webhook/"><meta property="og:site_name" content="Bank-Vaults">
<meta itemprop="name" content="Mutating Webhook">
<meta itemprop="description" content="Documentation for the Bank-Vaults"><meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Mutating Webhook">
<meta name="twitter:description" content="Documentation for the Bank-Vaults">
<meta name="twitter:site" content="@calisti12">
<link rel="preload" href="/scss/main.min.676617caf057b12362ecf7673d65047c5fe898a6461e02d928249cbc94b1bdab.css" as="style">
<link href="/scss/main.min.676617caf057b12362ecf7673d65047c5fe898a6461e02d928249cbc94b1bdab.css" rel="stylesheet" integrity>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK" crossorigin="anonymous"></script>
<script defer src="https://unpkg.com/lunr@2.3.9/lunr.min.js" integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli" crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css">
<script src="/js/w3.js" type="application/x-javascript"></script>
</head><body class="td-section">
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg width="144.26347" height="144.26346" viewBox="0 0 144.26348 144.26346" id="svg70" sodipodi:docname="logo.svg" inkscape:version="1.2.1 (9c6d41e4, 2022-07-14)" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/"><sodipodi:namedview pagecolor="#ffffff" bordercolor="#666666" borderopacity="1" objecttolerance="10" gridtolerance="10" guidetolerance="10" inkscape:pageopacity="0" inkscape:pageshadow="2" inkscape:window-width="1309" inkscape:window-height="456" id="namedview72" showgrid="false" inkscape:zoom="1.4142136" inkscape:cx="252.79067" inkscape:cy="89.095452" inkscape:window-x="0" inkscape:window-y="25" inkscape:window-maximized="0" inkscape:current-layer="g89" showguides="true" inkscape:guide-bbox="true" fit-margin-top="0" fit-margin-left="0" fit-margin-right="0" fit-margin-bottom="0" inkscape:showpageshadow="0" inkscape:pagecheckerboard="1" inkscape:deskcolor="#d1d1d1"/><defs id="defs4"><style id="style2">.cls-1{fill:#36a8e1}</style><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="276.63062" x2="-493.32941" y1="231.5972" x1="-498.4776" gradientUnits="userSpaceOnUse" id="SVGID_1_"><stop id="stop1134" style="stop-color:#3C8ECD" offset=".4032"/><stop id="stop1136" style="stop-color:#82CEF2" offset=".9943"/></linearGradient><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="271.8768" x2="-515.39728" y1="233.5062" x1="-511.01059" gradientUnits="userSpaceOnUse" id="SVGID_2_"><stop id="stop1141" style="stop-color:#C18DBE" offset=".4032"/><stop id="stop1143" style="stop-color:#9DB4DD" offset="1"/></linearGradient><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="282.21011" x2="-499.84381" y1="229.3567" x1="-493.8013" gradientUnits="userSpaceOnUse" id="SVGID_3_"><stop id="stop1148" style="stop-color:#454494" offset=".4032"/><stop id="stop1150" style="stop-color:#76A1D6" offset="1"/></linearGradient><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="267.82639" x2="-470.24661" y1="235.1331" x1="-473.98431" gradientUnits="userSpaceOnUse" id="SVGID_4_"><stop id="stop1155" style="stop-color:#56BDC1" offset=".4032"/><stop id="stop1157" style="stop-color:#82CEF2" offset=".9943"/></linearGradient><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="260.12711" x2="-494.45529" y1="229.73219" x1="-492.93121" gradientUnits="userSpaceOnUse" id="SVGID_5_"><stop id="stop1162" style="stop-color:#13287A" offset=".0057"/><stop id="stop1164" style="stop-color:#1A3D8E" offset="1"/></linearGradient><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="235.2251" x2="-507.06671" y1="273.6745" x1="-512.83838" gradientUnits="userSpaceOnUse" id="SVGID_6_"><stop id="stop1169" style="stop-color:#466BB3" offset="0"/><stop id="stop1171" style="stop-color:#3C3079" offset=".7268"/></linearGradient><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="266.69089" x2="-476.4068" y1="238.7536" x1="-482.8345" gradientUnits="userSpaceOnUse" id="SVGID_7_"><stop id="stop1176" style="stop-color:#1972A0" offset=".1924"/><stop id="stop1178" style="stop-color:#3B9FD9" offset="1"/></linearGradient></defs><g id="g2191-6" transform="matrix(1.0391419,0,0,1.0391419,-785.98152,-409.33734)"/><g id="g378" transform="matrix(0.21956619,0,0,0.21956619,-62.665715,99.533341)"><g id="g89" transform="matrix(0.96603773,0,0,0.96603773,0,19.798907)"><rect transform="matrix(4.5544353,0,0,4.5544353,0,-623.95763)" inkscape:export-ydpi="83.459999" inkscape:export-xdpi="83.459999" y="0" x="0" height="265" width="279.07285" id="rect1490-6" style="opacity:1;vector-effect:none;fill:none;fill-opacity:1;stroke:none;stroke-width:.540616;stroke-linecap:butt;stroke-linejoin:bevel;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;paint-order:stroke fill markers"/><g transform="matrix(2.2671253,0,0,2.2671253,-1470.9633,-791.56917)" id="g465-0"><path inkscape:connector-curvature="0" id="path218-5-3" d="m1079.1383 283.12854a150 150 0 01-150.00003 150 150 150 0 01-150-150 150 150 0 01150-150 150 150 0 01150.00003 150z" style="opacity:1;vector-effect:none;fill:#36a8e1;fill-opacity:1;stroke:none;stroke-width:1.59412;stroke-linecap:butt;stroke-linejoin:bevel;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;paint-order:stroke fill markers"/><g transform="matrix(2.0690654,0,0,2.0690654,739.12048,-2709.7574)" id="g1372-0-6"><path id="Path_1631-8-3-1" d="m140.98383 1464.3453c-.23051-1e-4-.46029-.026-.68499-.077l-25.05227-5.7194.12354-.2651c1.52748-3.2666 2.35115-6.818 2.41755-10.4236l.006-.2901 25.014 5.7107c.79405.1802 1.48298.6706 1.91325 1.362.43597.6876.57876 1.5212.39658 2.3148l-1.14156 5.0004c-.18024.794-.67067 1.483-1.36196 1.9133-.48769.3088-1.05281.4733-1.63004.4745z" class="cls-1" data-name="Path 1631" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="ccccccccccccc"/><path id="Path_1632-4-6-0" d="m42.692762 1464.3453c-1.431928.0-2.67294-.9922-2.993412-2.3878l-1.141574-5.0004c-.182495-.7936-.03976-1.6272.396351-2.3149.43031-.6912 1.11923-1.1816 1.913251-1.3619l25.027696-5.7136.0056.2898c.06623 3.6055.889568 7.1567 2.416603 10.4235l.123771.265-25.064544 5.7224c-.224287.051-.453658.078-.683811.078z" class="cls-1" data-name="Path 1632" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="cccccccccccc"/><path id="Path_1633-8-1-6" d="m86.203652 1421.9854v-25.527c.0018-1.6952 1.375526-3.0689 3.070652-3.0707h5.128931c1.695126.0 3.068839 1.3755 3.070651 3.0707v25.5244l-.284625-.06c-3.528917-.734-7.171122-.734-10.700038.0z" class="cls-1" data-name="Path 1633" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="ccccccccc"/><path id="Path_1634-1-0-3" d="m68.4782 1436.0192-20.013323-15.9593c-.637548-.507-1.045807-1.2479-1.133778-2.0576-.09463-.8087.138439-1.6218.647198-2.2577l3.197729-4.0099c.506674-.6378 1.24758-1.0461 2.057336-1.1339.808868-.095 1.622095.138 2.257874.647l19.982853 15.9355-.222741.1854c-2.774754 2.3028-5.037618 5.1601-6.643471 8.3886z" class="cls-1" data-name="Path 1634" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="ccccccccccc"/><path id="Path_1635-0-6-20" d="m111.69006 1497.5553c-1.18101 8e-4-2.25818-.6747-2.77162-1.7383l-11.17906-23.2188.283444-.069c3.503736-.8523 6.788826-2.4326 9.641606-4.6381l.23078-.1776 11.1774 23.2146c.35415.7333.40034 1.5777.12826 2.3453-.26575.7699-.8286 1.4012-1.56296 1.7533l-4.6211 2.2253c-.41379.1996-.8673.3034-1.32675.3035z" class="cls-1" data-name="Path 1635" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="cccccccccccc"/><path id="Path_1636-3-3-61" d="m71.986066 1497.5553c-.459533.0-.913133-.1036-1.326994-.3035l-4.621331-2.2253c-.734212-.3523-1.297005-.9837-1.56296-1.7533-.272113-.7676-.225844-1.612.128494-2.3453l11.180949-23.2221.230772.1778c2.851924 2.2071 6.136543 3.7892 9.64019 4.6431l.283445.069-11.180476 23.2209c-.513556 1.0637-1.590928 1.7393-2.772089 1.7383z" class="cls-1" data-name="Path 1636" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="cccccccccccc"/><path id="Path_1637-0-2-5" d="m115.20736 1436.0117-.13061-.2615c-1.60686-3.2281-3.87061-6.0848-6.64607-8.3867l-.22298-.1853 19.97672-15.9299c1.32641-1.0555 3.25699-.8379 4.3152.4864l3.19773 4.0099c1.05536 1.3265.8379 3.2569-.48611 4.3153z" class="cls-1" data-name="Path 1637" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="ccccccccc"/></g><path sodipodi:nodetypes="ccccccccccccccccc" style="fill:#fff;stroke-width:.488708" inkscape:connector-curvature="0" data-name="Path 1611" class="cls-1" d="m953.64449 351.25645v0l-49.11506-.0269c-4.61319.0-8.97664-2.09451-11.8425-5.70793l-30.605-38.41323c-2.88324-3.59976-3.95895-8.32323-2.91945-12.81745l10.95094-47.87714c1.01715-4.50022 4.03882-8.28619 8.20095-10.27663l44.26-21.28965c4.15116-2.00969 8.99505-2.00969 13.14622.0l44.24138 21.33123c4.16027 1.9952 7.17883 5.77994 8.19205 10.28285l10.9077 47.88769c1.03498 4.49504-.0455 9.2183-2.93249 12.81517l-30.64182 38.38551c-2.8669 3.60969-7.22725 5.70937-11.83609 5.69717z" id="path1253-3-0-5"/><path sodipodi:nodetypes="ccccccccccccccccc" style="fill:#36a8e1;fill-opacity:1;stroke-width:.37402" inkscape:connector-curvature="0" data-name="Path 1611" class="cls-1" d="m947.8838 335.07491v0l-37.58892-.0228c-3.53065.0-6.86992-1.60353-9.06334-4.36945L877.8089 301.28397c-2.20666-2.75352-3.02994-6.36941-2.23439-9.80903l8.38096-36.64087c.77838-3.44417 3.09098-6.34189 6.27651-7.86493l33.8735-16.29513c3.17684-1.53773 6.88419-1.53773 10.06103.0l33.85902 16.32575c3.18408 1.52676 5.49399 4.42366 6.26968 7.86969l8.34785 36.64936c.79204 3.43961-.0331 7.0553-2.24431 9.80881l-23.451 29.37577c-2.19404 2.76323-5.53102 4.37048-9.05837 4.36117z" id="path1253-6-4"/><g transform="matrix(0.48872138,0,0,0.48872138,1906.5441,113.88789)" id="Group_365-8-1-7" data-name="Group 365" style="fill:#fff"><path sodipodi:nodetypes="cccccc" id="Path_1612-1-5-6" d="m-2036.06 314.053h-.06c-7.1763-.008-12.9917-5.82372-13-13-.018-7.19712 5.8029-13.04555 13-13.061 7.1967-.0177 13.0446 5.80326 13.06 13 .018 7.19712-5.8029 13.04555-13 13.061z" class="cls-1" data-name="Path 1612" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccccc" id="Path_1613-2-5-5" d="m-1963.88 314.053h-.06c-7.1763-.008-12.9917-5.82372-13-13-.018-7.19712 5.8029-13.04555 13-13.061 7.197-.0183 13.0451 5.80303 13.06 13 .018 7.19712-5.8029 13.04555-13 13.061zm0-24.061c-6.0926-.0188 6.0933.0138.0.0z" class="cls-1" data-name="Path 1613" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1614-9-4-69" d="m-2036.06 350.143h-.06c-7.1763-.008-12.9917-5.82372-13-13-.018-7.19696 5.803-13.04511 13-13.06 7.1967-.0177 13.0446 5.80326 13.06 13 .018 7.19673-5.8033 13.04455-13 13.06z" class="cls-1" data-name="Path 1614" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1615-3-7-3" d="m-1963.88 350.143h-.06c-7.1763-.008-12.9917-5.82372-13-13-.018-7.19673 5.8033-13.04455 13-13.06 7.197-.0183 13.0451 5.80303 13.06 13 .018 7.19696-5.803 13.04511-13 13.06z" class="cls-1" data-name="Path 1615" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1616-9-6-7" d="m-2036.06 386.233h-.06c-7.1763-.008-12.9917-5.82372-13-13-.018-7.19696 5.803-13.04511 13-13.06 7.1967-.0177 13.0446 5.80326 13.06 13 .018 7.19673-5.8033 13.04455-13 13.06z" class="cls-1" data-name="Path 1616" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1617-0-5-4" d="m-1999.97 314.053h-.06c-7.1765-.008-12.9923-5.8235-13-13-.018-7.19712 5.8029-13.04555 13-13.061 7.197-.0183 13.0451 5.80303 13.06 13 .018 7.19712-5.8029 13.04555-13 13.061z" class="cls-1" data-name="Path 1617" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1618-8-6-5" d="m-1999.97 350.143h-.06c-7.1765-.008-12.9923-5.8235-13-13-.018-7.19696 5.803-13.04511 13-13.06 7.197-.0183 13.0451 5.80303 13.06 13 .018 7.19696-5.803 13.04511-13 13.06z" class="cls-1" data-name="Path 1618" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1619-8-9-2" d="m-1999.97 386.233h-.06c-7.1765-.008-12.9923-5.8235-13-13-.018-7.19696 5.803-13.04511 13-13.06 7.197-.0183 13.0451 5.80303 13.06 13 .018 7.19696-5.803 13.04511-13 13.06z" class="cls-1" data-name="Path 1619" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1620-5-3-5" d="m-1999.97 422.323h-.06c-7.1765-.008-12.9923-5.8235-13-13-.018-7.19696 5.803-13.04511 13-13.06 7.197-.0182 13.0451 5.80303 13.06 13 .018 7.19696-5.803 13.04511-13 13.06z" class="cls-1" data-name="Path 1620" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1621-0-7-4" d="m-1963.88 386.233h-.06c-7.1763-.008-12.9917-5.82372-13-13-.018-7.19673 5.8033-13.04455 13-13.06 7.197-.0183 13.0451 5.80303 13.06 13 .018 7.19696-5.803 13.04511-13 13.06z" class="cls-1" data-name="Path 1621" inkscape:connector-curvature="0" style="fill:#fff"/></g></g></g></g></svg></span><span class="navbar-brand__name">Bank-Vaults</span>
<span class="font-weight-bold navbar-logo navbar-version">1.19.0</span></a>
<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link" href="https://github.com/banzaicloud/bank-vaults" target="_blank"><span>Project page</span></a>
</li><li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link" href="/docs/"><span>Documentation</span></a>
</li></ul></div><div class="navbar-nav d-none d-lg-block">
<div class="td-search td-search--offline">
<div class="td-search__icon"></div><input type="search" class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete="off" data-offline-search-index-json-src="/offline-search-index.38c7a8b02048636206bb76469273850a.json" data-offline-search-base-href="/" data-offline-search-max-results="10">
</div></div></nav></header><div class="container-fluid td-outer">
<div class="td-main">
<div class="row flex-xl-nowrap">
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="return print(),!1">Click here to print</a>.
</p><p>
<a href="/docs/mutating-webhook/">Return to the regular view of this page</a>.
</p></div><h1 class="title">Mutating Webhook</h1><ul>
<li>1: <a href="#pg-ca011539082e4a0e051bd02ace83c3e5">Deploy the webhook</a></li><li>2: <a href="#pg-2d9a764f72223def1f5372077db5d9d3">Configuration examples and scenarios</a></li><li>3: <a href="#pg-3114defb3d9cb8776803617067a58907">Annotations</a></li><li>4: <a href="#pg-b05dd7ba49df3a955b7908ff777f3a2b">Using Vault Agent Templating in the mutating webhook</a></li><li>5: <a href="#pg-9ad4aac418ac0e1def9bf0c4bfe6b5f4">Using consul-template in the mutating webhook</a></li><li>6: <a href="#pg-4fdd9c4aa5b4e731487b9967ac5afd93">Transit Encryption</a></li><li>7: <a href="#pg-789c03a017d516c224edcadf80386609">Monitoring the Webhook with Grafana and Prometheus</a></li><li>8: <a href="#pg-d01053a982de9bc8c5063273f84aa47f">Injecting consul-template into the Prometheus operator for Vault metrics</a></li><li>9: <a href="#pg-40ade858fb140e470d28b5c4d75ad0ef">Comparison of Banzai Cloud and HashiCorp mutating webhook for Vault</a></li><li>10: <a href="#pg-06a0154e4fe026f4982258ce9841854f">Running the webhook and Vault on different clusters</a></li></ul><div class="content">
<h2 id="how-the-webhook-works---overview">How the webhook works - overview</h2><p>Kubernetes secrets are the standard way in which applications consume secrets and credentials on Kubernetes. Any secret that is securely stored in Vault and then unsealed for consumption eventually ends up as a Kubernetes secret. However, despite their name, Kubernetes secrets are not exactly secure, since they are only base64 encoded.</p><p>The mutating webhook of Bank-Vaults is a solution that bypasses the Kubernetes secrets mechanism and injects the secrets retrieved from Vault directly into the Pods. Specifically, the mutating admission webhook injects (in a very non-intrusive way) an executable into containers of Deployments and StatefulSets. This executable can request secrets from Vault through special environment variable definitions.</p><p><img src="/img/vault-mutating-webhook-revisited.gif" alt="Kubernetes API requests"></p><p>An important and unique aspect of the webhook is that it is a <em>daemonless</em> solution (although if you need it, you can <a href="/docs/mutating-webhook/deploy/#daemon-mode">deploy the webhook in daemon mode</a> as well).</p><h2 id="why-is-this-more-secure-than-using-kubernetes-secrets-or-any-other-custom-sidecar-container">Why is this more secure than using Kubernetes secrets or any other custom sidecar container?</h2><p>Our solution is particularly lightweight and uses only existing Kubernetes constructs like annotations and environment variables. No confidential data ever persists on the disk or in etcd - not even temporarily. All secrets are stored in memory, and are only visible to the process that requested them. Additionally, there is no persistent connection with Vault, and any Vault token used to read environment variables is flushed from memory before the application starts, in order to minimize attack surface.</p><p>If you want to make this solution even more robust, you can disable <em>kubectl exec</em>-ing in running containers. If you do so, no one will be able to hijack injected environment variables from a process.</p><p>The webhook checks if a container has environment variables defined in the following formats, and reads the values for those variables directly from Vault during startup time.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault:secret/data/accounts/aws#AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># or</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">valueFrom</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">secretKeyRef</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">key</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># or</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">valueFrom</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">configMapKeyRef</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-configmap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:700">key</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>The webhook checks if a container has <em>envFrom</em> and parses the defined ConfigMaps and Secrets:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">envFrom</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">secretRef</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># or</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">configMapRef</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-configmap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="secret-and-configmap-examples">Secret and ConfigMap examples</h2><p>Secrets require their payload to be base64 encoded, the API rejects manifests with plaintext in them.
The secret value should contain a base64 encoded template string referencing the vault path you want to insert.
Run <code>echo -n "vault:secret/data/accounts/aws#AWS_SECRET_ACCESS_KEY" | base64</code> to get the correct string.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">AWS_SECRET_ACCESS_KEY</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dmF1bHQ6c2VjcmV0L2RhdGEvYWNjb3VudHMvYXdzI0FXU19TRUNSRVRfQUNDRVNTX0tFWQ==</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Opaque</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ConfigMap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-configmap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">AWS_SECRET_ACCESSKEY</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault:secret/data/accounts/aws#AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>For further examples and use cases, see <a href="/docs/mutating-webhook/configuration/">Configuration examples and scenarios</a>.</p></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-ca011539082e4a0e051bd02ace83c3e5">1 - Deploy the webhook</h1><h2 id="deploy-the-mutating-webhook">Deploy the mutating webhook</h2><p>You can deploy the Vault Secrets Webhook using Helm. Note that:</p><ul>
<li>The Helm chart of the vault-secrets-webhook contains the templates of the required permissions as well.</li><li>The deployed RBAC objects contain the necessary permissions fo running the webhook.</li></ul><h3 id="prerequisites">Prerequisites</h3><ul>
<li>The user you use for deploying the chart to the Kubernetes cluster must have cluster-admin privileges.</li><li>The chart requires Helm 3.</li><li>To interact with Vault (for example, for testing), the <em>vault</em> command line client must be installed on your computer.</li><li>You have deployed Vault with the operator and configured your Vault client to access it, as described in <a href="/docs/installing/#deploy-operator">Deploy a local Vault operator</a>.</li></ul><h3 id="deploy-the-webhook">Deploy the webhook</h3><ol>
<li>
<p>Create a namespace for the webhook and add a label to the namespace, for example, <em>vault-infra</em>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl create namespace vault-infra
</span></span><span style="display:flex"><span>kubectl label namespace vault-infra <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:700">=</span>vault-infra
</span></span></code></pre></div></li><li>
<p>Deploy the vault-secrets-webhook chart:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm repo add banzaicloud-stable https://kubernetes-charts.banzaicloud.com
</span></span><span style="display:flex"><span>helm upgrade --namespace vault-infra --install vault-secrets-webhook banzaicloud-stable/vault-secrets-webhook
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>Release <span style="color:#4e9a06">&#34;vault-secrets-webhook&#34;</span> does not exist. Installing it now.
</span></span><span style="display:flex"><span>NAME: vault-secrets-webhook
</span></span><span style="display:flex"><span>LAST DEPLOYED: Fri Jul <span style="color:#0000cf;font-weight:700">14</span> 15:42:36 <span style="color:#0000cf;font-weight:700">2023</span>
</span></span><span style="display:flex"><span>NAMESPACE: vault-infra
</span></span><span style="display:flex"><span>STATUS: deployed
</span></span><span style="display:flex"><span>REVISION: <span style="color:#0000cf;font-weight:700">1</span>
</span></span><span style="display:flex"><span>TEST SUITE: None
</span></span></code></pre></div><p>For further details, see the <a href="https://github.com/bank-vaults/vault-secrets-webhook/">webhook&rsquo;s Helm chart repository</a>.</p></li><li>
<p>Check that the pods are running:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get pods --namespace vault-infra
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>NAME                                     READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex"><span>vault-secrets-webhook-58b97c8d6d-qfx8c   1/1     Running   <span style="color:#0000cf;font-weight:700">0</span>          22s
</span></span><span style="display:flex"><span>vault-secrets-webhook-58b97c8d6d-rthgd   1/1     Running   <span style="color:#0000cf;font-weight:700">0</span>          22s
</span></span></code></pre></div></li><li>
<p>If you already have the <a href="https://developer.hashicorp.com/vault/downloads">Vault CLI installed</a>, write a secret into Vault:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>vault kv put secret/demosecret/aws <span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#ce5c00;font-weight:700">=</span>s3cr3t
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>Key              Value
</span></span><span style="display:flex"><span>---              -----
</span></span><span style="display:flex"><span>created_time     2020-11-04T11:39:01.863988395Z
</span></span><span style="display:flex"><span>deletion_time    n/a
</span></span><span style="display:flex"><span>destroyed        <span style="color:#204a87">false</span>
</span></span><span style="display:flex"><span>version          <span style="color:#0000cf;font-weight:700">1</span>
</span></span></code></pre></div></li><li>
<p>Apply the following deployment to your cluster. The webhook will mutate this deployment because it has an environment variable having a value which is a reference to a path in Vault:</p><pre>
    <code class="language-yaml">kubectl create -f - &lt;&lt;EOF
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: vault-test
    spec:
      replicas: 1
      selector:
        matchLabels:
          app.kubernetes.io/name: vault
      template:
        metadata:
          labels:
            app.kubernetes.io/name: vault
          annotations:
            vault.security.banzaicloud.io/vault-addr: &#34;https://vault:8200&#34; # optional, the address of the Vault service, default values is https://vault:8200
            vault.security.banzaicloud.io/vault-role: &#34;default&#34; # optional, the default value is the name of the ServiceAccount the Pod runs in, in case of Secrets and ConfigMaps it is &#34;default&#34;
            vault.security.banzaicloud.io/vault-skip-verify: &#34;false&#34; # optional, skip TLS verification of the Vault server certificate
            vault.security.banzaicloud.io/vault-tls-secret: &#34;vault-tls&#34; # optional, the name of the Secret where the Vault CA cert is, if not defined it is not mounted
            vault.security.banzaicloud.io/vault-agent: &#34;false&#34; # optional, if true, a Vault Agent will be started to do Vault authentication, by default not needed and vault-env will do Kubernetes Service Account based Vault authentication
            vault.security.banzaicloud.io/vault-path: &#34;kubernetes&#34; # optional, the Kubernetes Auth mount path in Vault the default value is &#34;kubernetes&#34;
        spec:
          serviceAccountName: default
          containers:
          - name: alpine
            image: alpine
            command: [&#34;sh&#34;, &#34;-c&#34;, &#34;echo $AWS_SECRET_ACCESS_KEY &amp;&amp; echo going to sleep... &amp;&amp; sleep 10000&#34;]
            env:
            - name: AWS_SECRET_ACCESS_KEY
              value: vault:secret/data/demosecret/aws#AWS_SECRET_ACCESS_KEY
    EOF</code>
    </pre><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>deployment.apps/vault-test created
</span></span></code></pre></div></li><li>
<p>Check the mutated deployment.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl describe deployment vault-test
</span></span></code></pre></div><p>The output should look similar to the following:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">Name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#000">vault-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Namespace</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">CreationTimestamp</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">Wed, 04 Nov 2020 12:44:18 +0100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#000">&lt;none&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Annotations:            deployment.kubernetes.io/revision</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Selector</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#000">app.kubernetes.io/name=vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Replicas</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#0000cf;font-weight:700">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">desired | 1 updated | 1 total | 1 available | 0 unavailable</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">StrategyType</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#000">RollingUpdate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">MinReadySeconds</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#0000cf;font-weight:700">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">RollingUpdateStrategy</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#0000cf;font-weight:700">25</span><span style="color:#000">% max unavailable, 25% max surge</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Pod Template</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">Labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#000">app.kubernetes.io/name=vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">Annotations:      vault.security.banzaicloud.io/vault-addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://vault:8200</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-agent</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-role</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-skip-verify</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-tls-secret</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-tls</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">Service Account</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">Containers</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:700">alpine</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">Image</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">alpine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">Port</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#000">&lt;none&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">Host Port</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">&lt;none&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">Command</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">sh</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>-<span style="color:#000">c</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">echo $AWS_SECRET_ACCESS_KEY &amp;&amp; echo going to sleep... &amp;&amp; sleep 10000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">Environment</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">AWS_SECRET_ACCESS_KEY</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">vault:secret/data/demosecret/aws#AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">Mounts</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">                   </span><span style="color:#000">&lt;none&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">Volumes</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#000">&lt;none&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Conditions</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Type           Status  Reason</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>---- <span style="color:#f8f8f8;text-decoration:underline">          </span>------ <span style="color:#f8f8f8;text-decoration:underline"> </span>------<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Available      True    MinimumReplicasAvailable</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Progressing    True    NewReplicaSetAvailable</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">OldReplicaSets</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">&lt;none&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">NewReplicaSet</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#000">vault-test-55c569f9 (1/1 replicas created)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">Events</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Type    Reason             Age   From                   Message</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>---- <span style="color:#f8f8f8;text-decoration:underline">   </span>------ <span style="color:#f8f8f8;text-decoration:underline">            </span>---- <span style="color:#f8f8f8;text-decoration:underline"> </span>---- <span style="color:#f8f8f8;text-decoration:underline">                  </span>-------<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">Normal  ScalingReplicaSet  29s   deployment-controller  Scaled up replica set vault-test-55c569f9 to 1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>As you can see, the original environment variables in the definition are unchanged, and the sensitive value of the AWS_SECRET_ACCESS_KEY variable is only visible within the alpine container.</p></li></ol><h2 id="deploy-the-webhook-from-a-private-registry">Deploy the webhook from a private registry</h2><p>If you are getting the <strong>x509: certificate signed by unknown authority app=vault-secrets-webhook</strong> error when the webhook is trying to download the manifest from a private image registry, you can:</p><ul>
<li>Build a docker image where the CA store of the OS layer of the image contains the CA certificate of the registry.</li><li>Alternatively, you can disable certificate verification for the registry by using the <strong>REGISTRY_SKIP_VERIFY=&ldquo;true&rdquo;</strong> environment variable in the deployment of the webhook.</li></ul><h2 id="daemon-mode">Deploy in daemon mode</h2><p><code>vault-env</code> by default replaces itself with the original process of the Pod after reading the secrets from Vault, but with the <code>vault.security.banzaicloud.io/vault-env-daemon: "true"</code> annotation this behavior can be changed. So <code>vault-env</code> can change to <code>daemon mode</code>, so <code>vault-env</code> starts the original process as a child process and remains in memory, and renews the lease of the requested Vault token and of the dynamic secrets (if requested any) until their final expiration time.</p><p>You can find a full example using MySQL dynamic secrets in the <a href="https://raw.githubusercontent.com/bank-vaults/vault-operator/main/test/deploy/test-dynamic-env-vars.yaml">Bank-Vaults project&rsquo;s Vault Operator repository</a>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Deploy MySQL first as the Vault storage backend and our application will request dynamic secrets for this database as well:</span>
</span></span><span style="display:flex"><span>helm upgrade --install mysql stable/mysql --set <span style="color:#000">mysqlRootPassword</span><span style="color:#ce5c00;font-weight:700">=</span>your-root-password --set <span style="color:#000">mysqlDatabase</span><span style="color:#ce5c00;font-weight:700">=</span>vault --set <span style="color:#000">mysqlUser</span><span style="color:#ce5c00;font-weight:700">=</span>vault --set <span style="color:#000">mysqlPassword</span><span style="color:#ce5c00;font-weight:700">=</span>secret --set <span style="color:#4e9a06">&#39;initializationFiles.app-db\.sql=CREATE DATABASE IF NOT EXISTS app;&#39;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Deploy the vault-operator and the vault-secerts-webhook</span>
</span></span><span style="display:flex"><span>kubectl create namespace vault-infra
</span></span><span style="display:flex"><span>kubectl label namespace vault-infra <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:700">=</span>vault-infra
</span></span><span style="display:flex"><span>helm upgrade --namespace vault-infra --install vault-operator banzaicloud-stable/vault-operator
</span></span><span style="display:flex"><span>helm upgrade --namespace vault-infra --install vault-secrets-webhook banzaicloud-stable/vault-secrets-webhook
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Create a Vault instance with MySQL storage and a configured dynamic database secrets backend</span>
</span></span><span style="display:flex"><span>kubectl apply -f operator/deploy/rbac.yaml
</span></span><span style="display:flex"><span>kubectl apply -f operator/deploy/cr-mysql-ha.yaml
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Deploy the example application requesting dynamic database credentials from the above Vault instance</span>
</span></span><span style="display:flex"><span>kubectl apply -f deploy/test-dynamic-env-vars.yaml
</span></span><span style="display:flex"><span>kubectl logs -f deployment/hello-secrets
</span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-2d9a764f72223def1f5372077db5d9d3">2 - Configuration examples and scenarios</h1><p>The following examples show you how to configure the mutating webhook to best suit your environment.</p><p>The webhook checks if a container has environment variables defined in the following formats, and reads the values for those variables directly from Vault during startup time.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault:secret/data/accounts/aws#AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># or</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">valueFrom</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">secretKeyRef</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">key</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># or</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">valueFrom</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">configMapKeyRef</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-configmap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:700">key</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>The webhook checks if a container has <em>envFrom</em> and parses the defined ConfigMaps and Secrets:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">envFrom</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">secretRef</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># or</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">configMapRef</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-configmap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="secret-and-configmap-examples">Secret and ConfigMap examples</h2><p>Secrets require their payload to be base64 encoded, the API rejects manifests with plaintext in them.
The secret value should contain a base64 encoded template string referencing the vault path you want to insert.
Run <code>echo -n "vault:secret/data/accounts/aws#AWS_SECRET_ACCESS_KEY" | base64</code> to get the correct string.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">AWS_SECRET_ACCESS_KEY</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dmF1bHQ6c2VjcmV0L2RhdGEvYWNjb3VudHMvYXdzI0FXU19TRUNSRVRfQUNDRVNTX0tFWQ==</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Opaque</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ConfigMap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-configmap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">AWS_SECRET_ACCESSKEY</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault:secret/data/accounts/aws#AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="prerequisites-for-inline-injection-to-work">Prerequisites for inline injection to work</h2><p>Vault needs to be properly configured for mutation to function; namely
<code>externalConfig.auth</code> and <code>externConfig.roles</code> (from the perspective of the
vault operator CR) need to be properly configured. If you&rsquo;re not using the vault
operator then you must make sure that your Vault configuration for <code>Kubernetes</code>
auth methods <a href="https://developer.hashicorp.com/vault/docs/auth/kubernetes">are properly configured</a>. This configuration is outside the scope
of this document. If you use the operator for managing Vault in your cluster, see the <a href="/docs/operator/">Vault operator documentation</a>.</p><h2 id="inject-secret-into-resources">Inject secret into resources</h2><p>The webhook can inject into any kind of resources, even into CRDs, for example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mysql.example.github.com/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MySQLCluster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;my-cluster&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">caBundle</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault:pki/cert/43138323834372136778363829719919055910246657114#ca&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="inline">Inline mutation</h2><p>The webhook also supports inline mutation when your secret needs to be replaced somewhere inside a string.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-key-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">config.yaml</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">foo</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bar</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">secret</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${vault:secret/data/mysecret#supersecret}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Opaque</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>This works also for ConfigMap resources when <code>configMapMutation: true</code> is set in the webhook&rsquo;s Helm chart.</p><p>You can specify the version of the injected Vault secret as well in the special reference, the format is: <code>vault:PATH#KEY_OR_TEMPLATE#VERSION</code></p><p>Example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault:secret/data/accounts/aws#AWS_SECRET_ACCESS_KEY#2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="define-multiple-inline-secrets-in-resources">Define multiple inline-secrets in resources</h2><p>You can also inject multiple secrets under the same key in a Secret/ConfigMap/Object. This means that you can use multiple Vault paths in a value, for example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ConfigMap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sample-configmap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">annotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;https://vault.default:8200&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-role</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-tls-secret</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-tls</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;kubernetes&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">aws-access-key-id</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault:secret/data/accounts/aws#AWS_ACCESS_KEY_ID&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">aws-access-template</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault:secret/data/accounts/aws#AWS key in base64: ${.AWS_ACCESS_KEY_ID | b64enc}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">aws-access-inline</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;AWS_ACCESS_KEY_ID: ${vault:secret/data/accounts/aws#AWS_ACCESS_KEY_ID} AWS_SECRET_ACCESS_KEY: ${vault:secret/data/accounts/aws#AWS_SECRET_ACCESS_KEY}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>This example also shows how a CA certificate (created by the operator) can be used with the <code>vault.security.banzaicloud.io/vault-tls-secret: vault-tls</code> annotation to validate the TLS connection in case of a non-Pod resource.</p><h2 id="request-a-vault-token">Request a Vault token</h2><p>There is a special <code>vault:login</code> reference format to request a working Vault token into an environment variable to be later consumed by your application:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">VAULT_TOKEN</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault:login</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="read-a-value-from-vault">Read a value from Vault</h2><p>Values starting with <code>"vault:"</code> issue a <code>read</code> (HTTP GET) request towards the Vault API, this can be also used to request a <a href="https://developer.hashicorp.com/vault/docs/secrets/databases/mysql-maria#usage">dynamic database username/password pair for MySQL</a>:</p><p><em><strong>NOTE</strong>: This feature takes advantage of secret caching since we need to access the <code>my-role</code> endpoint twice, but in the background, it is written only once in Vault:</em></p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MYSQL_USERNAME</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault:database/creds/my-role#username&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MYSQL_PASSWORD</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault:database/creds/my-role#password&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REDIS_URI</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;redis://${vault:database/creds/my-role#username}:${vault:database/creds/my-role#password}@127.0.0.1:6739&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="write-a-value-into-vault">Write a value into Vault</h2><p>Values starting with <code>">>vault:"</code> issue a <code>write</code> (HTTP POST/PUT) request towards the Vault API, some secret engine APIs should be <code>written</code> instead of <code>reading from</code> like the <a href="https://github.com/sethvargo/vault-secrets-gen">Password Generator for HashiCorp Vault</a>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MY_SECRET_PASSWORD</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&gt;&gt;vault:gen/password#value&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Or with <a href="https://developer.hashicorp.com/vault/api-docs/secret/transit#decrypt-data">Transit Secret Engine</a> which is a fairly complex example since we are using templates when rendering the response and send data in the write request as well, the format is: <code>vault:PATH#KEY_OR_TEMPLATE#DATA</code></p><p>Example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MY_SECRET_PASSWORD</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&gt;&gt;vault:transit/decrypt/mykey#${.plaintext | b64dec}#{&#34;</span><span style="color:#000">ciphertext&#34;:&#34;vault:v1:/DupSiSbX/ATkGmKAmhqD0tvukByrx6gmps7dVI=&#34;}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="templating-in-values">Templating in values</h2><p><a href="https://golang.org/pkg/text/template/">Templating</a> is also supported on the secret sourced from Vault (in the key part, after the first <code>#</code>), in the very same fashion as in the Vault configuration and external configuration with all <a href="http://masterminds.github.io/sprig/">the Sprig functions</a> (this is supported only for Pods right now):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DOCKER_USERNAME</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault:secret/data/accounts/dockerhub#My username on DockerHub is: ${title .DOCKER_USERNAME}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>In this case, an init-container will be injected into the given Pod. This container copies the <code>vault-env</code> binary into an in-memory volume and mounts that Volume to every container which has an environment variable definition like that. It also changes the <code>command</code> of the container to run <code>vault-env</code> instead of your application directly. When <code>vault-env</code> starts up, it connects to Vault to checks the environment variables. (By default, <code>vault-env</code> uses the <a href="https://developer.hashicorp.com/vault/docs/auth/kubernetes.html">Kubernetes Auth method</a>, but you can also <a href="#webhook-auth">configure other authentication methods for the webhook</a>.) The variables that have a reference to a value stored in Vault (<code>vault:secret/....</code>) are replaced with that value read from the Secret backend. After this, <code>vault-env</code> immediately executes (with <code>syscall.Exec()</code>) your process with the given arguments, replacing itself with that process (in non-daemon mode).</p><p><strong>With this solution none of your Secrets stored in Vault will ever land in Kubernetes Secrets, thus in etcd.</strong></p><p><code>vault-env</code> was designed to work in Kubernetes in the first place, but nothing stops you to use it outside Kubernetes as well. It can be configured with the standard Vault client&rsquo;s <a href="https://developer.hashicorp.com/vault/docs/commands#environment-variables">environment variables</a> (because there is a standard Go Vault client underneath).</p><p>Currently, the Kubernetes Service Account-based Vault authentication mechanism is used by <code>vault-env</code>, so it requests a Vault token based on the Service Account of the container it is injected into.</p><ul>
<li><a href="https://developer.hashicorp.com/vault/docs/auth/gcp">GCP</a> and general <a href="https://developer.hashicorp.com/vault/docs/auth/jwt">OIDC/JWT</a> authentication methods are supported as well, see the <a href="https://github.com/bank-vaults/vault-operator/blob/main/test/deploy/test-deployment-gcp.yaml">example manifest</a>.</li><li>Kubernetes <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection">Projected Service Account Tokens</a> work too, as shown in <a href="https://github.com/bank-vaults/vault-operator/tree/main/test/oidc-pod.yaml">this example</a>.</li></ul><p>Kubernetes 1.12 introduced a feature called <a href="https://kubernetes.io/blog/2019/01/14/apiserver-dry-run-and-kubectl-diff/">APIServer dry-run</a> which became beta as of 1.13. This feature requires some changes in webhooks with side effects. Vault mutating admission webhook is <code>dry-run aware</code>.</p><h2 id="mutate-data-from-vault-and-replace-it-in-kubernetes-secret">Mutate data from Vault and replace it in Kubernetes Secret</h2><p>You can mutate Secrets (and ConfigMaps) as well if you set annotations and define proper Vault path in the <code>data</code> section:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">sample-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">annotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;https://vault.default.svc.cluster.local:8200&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-role</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-skip-verify</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;kubernetes&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes.io/dockerconfigjson</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">.dockerconfigjson</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">eyJhdXRocyI6eyJodHRwczovL2RvY2tlci5pbyI6eyJ1c2VybmFtZSI6InZhdWx0OnNlY3JldC9kYXRhL2RvY2tlcnJlcG8vI0RPQ0tFUl9SRVBPX1VTRVIiLCJwYXNzd29yZCI6InZhdWx0OnNlY3JldC9kYXRhL2RvY2tlcnJlcG8vI0RPQ0tFUl9SRVBPX1BBU1NXT1JEIiwiYXV0aCI6ImRtRjFiSFE2YzJWamNtVjBMMlJoZEdFdlpHOWphMlZ5Y21Wd2J5OGpSRTlEUzBWU1gxSkZVRTlmVlZORlVqcDJZWFZzZERwelpXTnlaWFF2WkdGMFlTOWtiMk5yWlhKeVpYQnZMeU5FVDBOTFJWSmZVa1ZRVDE5UVFWTlRWMDlTUkE9PSJ9fX0=</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>In the example above the secret type is <code>kubernetes.io/dockerconfigjson</code> and the webhook can get credentials from Vault.
The base64 encoded data contain vault path in case of username and password for docker repository and you can create it with commands:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl create secret docker-registry dockerhub --docker-username<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;vault:secret/data/dockerrepo#DOCKER_REPO_USER&#34;</span> --docker-password<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;vault:secret/data/dockerrepo#DOCKER_REPO_PASSWORD&#34;</span>
</span></span><span style="display:flex"><span>kubectl annotate secret dockerhub vault.security.banzaicloud.io/vault-addr<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;https://vault.default.svc.cluster.local:8200&#34;</span>
</span></span><span style="display:flex"><span>kubectl annotate secret dockerhub vault.security.banzaicloud.io/vault-role<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;default&#34;</span>
</span></span><span style="display:flex"><span>kubectl annotate secret dockerhub vault.security.banzaicloud.io/vault-skip-verify<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;true&#34;</span>
</span></span><span style="display:flex"><span>kubectl annotate secret dockerhub vault.security.banzaicloud.io/vault-path<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;kubernetes&#34;</span>
</span></span></code></pre></div><h2 id="use-charts-without-explicit-containercommand-and-containerargs">Use charts without explicit container.command and container.args</h2><p>The Webhook can determine the container&rsquo;s <code>ENTRYPOINT</code> and <code>CMD</code> with the help of image metadata queried from the image registry. This data is cached until the webhook Pod is restarted. If the registry is publicly accessible (without authentication) you don&rsquo;t need to do anything, but if the registry requires authentication the credentials have to be available in the Pod&rsquo;s <code>imagePullSecrets</code> section.</p><p>Some examples (apply <code>cr.yaml</code> from the operator samples first):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm upgrade --install mysql stable/mysql <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>  --set <span style="color:#000">mysqlRootPassword</span><span style="color:#ce5c00;font-weight:700">=</span>vault:secret/data/mysql#MYSQL_ROOT_PASSWORD <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>  --set <span style="color:#000">mysqlPassword</span><span style="color:#ce5c00;font-weight:700">=</span>vault:secret/data/mysql#MYSQL_PASSWORD <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>  --set <span style="color:#4e9a06">&#34;podAnnotations.vault\.security\.banzaicloud\.io/vault-addr&#34;</span><span style="color:#ce5c00;font-weight:700">=</span>https://vault:8200 <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>  --set <span style="color:#4e9a06">&#34;podAnnotations.vault\.security\.banzaicloud\.io/vault-tls-secret&#34;</span><span style="color:#ce5c00;font-weight:700">=</span>vault-tls
</span></span></code></pre></div><h2 id="registry-access">Registry access</h2><p>You can also specify a default secret being used by the webhook for cases where a pod has no <code>imagePullSecrets</code> specified. To make this work you have to set the environment variables <code>DEFAULT_IMAGE_PULL_SECRET</code> and <code>DEFAULT_IMAGE_PULL_SECRET_NAMESPACE</code> when deploying the vault-secrets-webhook. Have a look at the <a href="https://github.com/bank-vaults/vault-secrets-webhook/blob/main/deploy/charts/vault-secrets-webhook/values.yaml">values.yaml of the
vault-secrets-webhook</a> helm chart to see how this is done.</p><blockquote>
<p>Note:</p><ul>
<li>If your EC2 nodes have the ECR instance role, the webhook can request an ECR access token through that role automatically, instead of an explicit <code>imagePullSecret</code></li><li>If your workload is running on GCP nodes, the webhook automatically authenticates to GCR.</li></ul></blockquote><p>Future improvements:</p><ul>
<li>on Azure/Alibaba get a credential dynamically with the specific SDK (for AWS ECR and GCP GCR this is already done)</li></ul><h3 id="using-a-private-image-repository">Using a private image repository</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Docker Hub</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>kubectl create secret docker-registry dockerhub --docker-username<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">${</span><span style="color:#000">DOCKER_USERNAME</span><span style="color:#4e9a06">}</span> --docker-password<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#000">$DOCKER_PASSWORD</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>helm upgrade --install mysql stable/mysql --set <span style="color:#000">mysqlRootPassword</span><span style="color:#ce5c00;font-weight:700">=</span>vault:secret/data/mysql#MYSQL_ROOT_PASSWORD --set <span style="color:#4e9a06">&#34;imagePullSecrets[0].name=dockerhub&#34;</span> --set-string <span style="color:#4e9a06">&#34;podAnnotations.vault\.security\.banzaicloud\.io/vault-skip-verify=true&#34;</span> --set <span style="color:#000">image</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;private-repo/mysql&#34;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># GCR</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>kubectl create secret docker-registry gcr <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>--docker-server<span style="color:#ce5c00;font-weight:700">=</span>gcr.io <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>--docker-username<span style="color:#ce5c00;font-weight:700">=</span>_json_key <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>--docker-password<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:700">$(</span>cat ~/json-key-file.json<span style="color:#204a87;font-weight:700">)</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>helm upgrade --install mysql stable/mysql --set <span style="color:#000">mysqlRootPassword</span><span style="color:#ce5c00;font-weight:700">=</span>vault:secret/data/mysql#MYSQL_ROOT_PASSWORD --set <span style="color:#4e9a06">&#34;imagePullSecrets[0].name=gcr&#34;</span> --set-string <span style="color:#4e9a06">&#34;podAnnotations.vault\.security\.banzaicloud\.io/vault-skip-verify=true&#34;</span> --set <span style="color:#000">image</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;gcr.io/your-repo/mysql&#34;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># ECR</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#000">TOKEN</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">`</span>aws ecr --region<span style="color:#ce5c00;font-weight:700">=</span>eu-west-1 get-authorization-token --output text --query authorizationData<span style="color:#ce5c00;font-weight:700">[]</span>.authorizationToken <span style="color:#000;font-weight:700">|</span> base64 --decode <span style="color:#000;font-weight:700">|</span> cut -d: -f2<span style="color:#4e9a06">`</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>kubectl create secret docker-registry ecr <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span> --docker-server<span style="color:#ce5c00;font-weight:700">=</span>https://171832738826.dkr.ecr.eu-west-1.amazonaws.com <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span> --docker-username<span style="color:#ce5c00;font-weight:700">=</span>AWS <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span> --docker-password<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">TOKEN</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span> helm upgrade --install mysql stable/mysql --set <span style="color:#000">mysqlRootPassword</span><span style="color:#ce5c00;font-weight:700">=</span>vault:secret/data/mysql#MYSQL_ROOT_PASSWORD --set <span style="color:#4e9a06">&#34;imagePullSecrets[0].name=ecr&#34;</span> --set-string <span style="color:#4e9a06">&#34;podAnnotations.vault\.security\.banzaicloud\.io/vault-skip-verify=true&#34;</span> --set <span style="color:#000">image</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;171832738826.dkr.ecr.eu-west-1.amazonaws.com/mysql&#34;</span> --set-string <span style="color:#000">imageTag</span><span style="color:#ce5c00;font-weight:700">=</span>5.7
</span></span></code></pre></div><h2 id="mount-all-keys-from-vault-secret-to-env">Mount all keys from Vault secret to env</h2><p>This feature is very similar to Kubernetes&rsquo; standard <code>envFrom:</code> <a href="https://kubernetes.io/docs/concepts/configuration/secret/#use-case-as-container-environment-variables">construct</a>, but instead of a Kubernetes Secret/ConfigMap, all its keys are mounted from a Vault secret using the webhook and vault-env.</p><p>You can set the Vault secret to mount using the <code>vault.security.banzaicloud.io/vault-env-from-path</code> annotation.</p><p>Compared to the original environment variable definition in the Pod <code>env</code> construct, the only difference is that you won&rsquo;t see the actual environment variables in the definition, because they are dynamic, and are based on the contents of the Vault secret&rsquo;s, just like <code>envFrom:</code>.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hello-secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">selector</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">matchLabels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hello-secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">template</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hello-secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">annotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;https://vault:8200&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-tls-secret</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-tls</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-env-from-path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;secret/data/accounts/aws&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">initContainers</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">init-ubuntu</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">image</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ubuntu</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">command</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">[</span><span style="color:#4e9a06">&#34;sh&#34;</span><span style="color:#000;font-weight:700">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;-c&#34;</span><span style="color:#000;font-weight:700">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;echo AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID &amp;&amp; echo initContainers ready&#34;</span><span style="color:#000;font-weight:700">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">containers</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">alpine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">image</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">alpine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">command</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">[</span><span style="color:#4e9a06">&#34;sh&#34;</span><span style="color:#000;font-weight:700">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;-c&#34;</span><span style="color:#000;font-weight:700">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;echo AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY &amp;&amp; echo going to sleep... &amp;&amp; sleep 10000&#34;</span><span style="color:#000;font-weight:700">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="webhook-auth">Authenticate the webhook to Vault</h2><p>By default, the webhook uses Kubernetes <a href="https://developer.hashicorp.com/vault/docs/auth/kubernetes">ServiceAccount-based authentication</a> in Vault. Use the <code>vault.security.banzaicloud.io/vault-auth-method</code> annotation to request different authentication types from the following supported types: <strong>&ldquo;kubernetes&rdquo;, &ldquo;aws-ec2&rdquo;, &ldquo;gcp-gce&rdquo;, &ldquo;gcp-iam&rdquo;, &ldquo;jwt&rdquo;, &ldquo;azure&rdquo;</strong>.</p><blockquote>
<p>Note: GCP IAM authentication (<strong>gcp-iam</strong>) only allows for authentication with the &lsquo;default&rsquo; service account of the caller, and a new token is generated at every request.
Note: Azure MSI authentication (<strong>azure</strong>) a new token is generated at every request.</p></blockquote><p>The following deployment - if running on a GCP instance - will automatically receive a signed JWT token from the metadata server of the cloud provider, and use it to authenticate against Vault. The same goes for <code>vault-auth-method: "aws-ec2"</code>, when running on an EC2 node with the right instance-role.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-env-gcp-auth</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">selector</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">matchLabels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-env-gcp-auth</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">template</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-env-gcp-auth</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">annotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># These annotations enable Vault GCP GCE auth, see:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># https://developer.hashicorp.com/vault/docs/auth/gcp#gce-login</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;https://vault:8200&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-tls-secret</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-tls</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-role</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;my-role&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;gcp&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-auth-method</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;gcp-gce&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">containers</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">alpine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">image</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">alpine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">command</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#4e9a06">&#34;sh&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#4e9a06">&#34;-c&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#4e9a06">&#34;echo $MYSQL_PASSWORD &amp;&amp; echo going to sleep... &amp;&amp; sleep 10000&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MYSQL_PASSWORD</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault:secret/data/mysql#MYSQL_PASSWORD</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-3114defb3d9cb8776803617067a58907">3 - Annotations</h1><p>The mutating webhook adds the following PodSpec, Secret, ConfigMap, and CRD annotations.</p><table>
<thead>
<tr>
<th>Annotation</th><th>default</th><th>Explanation</th></tr></thead><tbody>
<tr>
<td><code>vault.security.banzaicloud.io/vault-addr</code></td><td><code>"https://vault:8200"</code></td><td>Same as VAULT_ADDR</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-image</code></td><td><code>"hashicorp/vault:latest"</code></td><td>Vault agent image</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-image-pull-policy</code></td><td><code>IfNotPresent</code></td><td>the Pull policy for the vault agent container</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-role</code></td><td><code>""</code></td><td>The Vault role for Vault agent to use, for Pods it is the name of the ServiceAccount if not specified</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-path</code></td><td><code>"kubernetes"</code></td><td>The mount path of the auth method</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-skip-verify</code></td><td><code>"false"</code></td><td>Same as VAULT_SKIP_VERIFY</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-tls-secret</code></td><td><code>""</code></td><td>Name of the Kubernetes Secret holding the CA certificate for Vault</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-ignore-missing-secrets</code></td><td><code>"false"</code></td><td>When enabled will only log warnings when Vault secrets are missing</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-env-passthrough</code></td><td><code>""</code></td><td>Comma separated list of <code>VAULT_*</code> related environment variables to pass through to <code>vault-env</code> to the main process. E.g. <code>VAULT_ADDR,VAULT_ROLE</code>.</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-env-daemon</code></td><td><code>"false"</code></td><td>Run <code>vault-env</code> as a daemon instead of replacing itself with the main process. For details, see /docs/mutating-webhook/deploy/#daemon-mode.</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-env-image</code></td><td><code>"banzaicloud/vault-env:latest"</code></td><td>vault-env image</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-env-image-pull-policy</code></td><td><code>IfNotPresent</code></td><td>the Pull policy for the vault-env container</td></tr><tr>
<td><code>vault.security.banzaicloud.io/enable-json-log</code></td><td><code>"false"</code></td><td>Log in JSON format in <code>vault-env</code></td></tr><tr>
<td><code>vault.security.banzaicloud.io/mutate</code></td><td><code>""</code></td><td>Defines the mutation of the given resource, possible values: <code>"skip"</code> which prevents it.</td></tr><tr>
<td><code>vault.security.banzaicloud.io/mutate-probes</code></td><td><code>"false"</code></td><td>Mutate the ENV passed to a liveness or readiness probe.</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-env-from-path</code></td><td><code>""</code></td><td>Comma-delimited list of vault paths to pull in all secrets as environment variables</td></tr><tr>
<td><code>vault.security.banzaicloud.io/token-auth-mount</code></td><td><code>""</code></td><td><code>{volume:file}</code> to be injected as <code>.vault-token</code>.</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-auth-method</code></td><td><code>"jwt"</code></td><td>The <a href="https://www.vaultproject.io/docs/auth">Vault authentication method</a> to be used, one of <code>["kubernetes", "aws-ec2", "aws-iam", "gcp-gce", "gcp-iam", "jwt", "azure", "namespaced"]</code></td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-serviceaccount</code></td><td><code>""</code></td><td>The ServiceAccount in the objects namespace to use, useful for non-pod resources</td></tr><tr>
<td><code>vault.security.banzaicloud.io/vault-namespace</code></td><td><code>""</code></td><td>The <a href="https://www.vaultproject.io/docs/enterprise/namespaces">Vault Namespace</a> secrets will be pulled from. This annotation sets the <code>VAULT_NAMESPACE</code> environment variable. More information on <code>namespaces</code> within Vault can be found <a href="https://learn.hashicorp.com/tutorials/vault/namespaces">here</a></td></tr><tr>
<td><code>vault.security.banzaicloud.io/run-as-non-root</code></td><td><code>"false"</code></td><td>When enabled will add <code>runAsNonRoot: true</code> to the <code>securityContext</code> of all injected containers</td></tr><tr>
<td><code>vault.security.banzaicloud.io/run-as-user</code></td><td><code>"0"</code></td><td>Set the UID (<code>runAsUser</code>) for all injected containers. The default value of <code>"0"</code> means that no modifications will be made to the <code>securityContext</code> of injected containers.</td></tr><tr>
<td><code>vault.security.banzaicloud.io/run-as-group</code></td><td><code>"0"</code></td><td>Set the GID (<code>runAsGroup</code>) for all injected containers. The default value of <code>"0"</code> means that no modifications will be made to the <code>securityContext</code> of injected containers.</td></tr><tr>
<td><code>vault.security.banzaicloud.io/readonly-root-fs</code></td><td><code>"false"</code></td><td>When enabled will add <code>readOnlyRootFilesystem: true</code> to the <code>securityContext</code> of all injected containers</td></tr></tbody></table></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-b05dd7ba49df3a955b7908ff777f3a2b">4 - Using Vault Agent Templating in the mutating webhook</h1><p>With Bank-Vaults you can use <a href="https://www.vaultproject.io/docs/agent/">Vault Agent</a> to handle secrets that expire, and supply them to applications that read their configurations from a file.</p><h2 id="when-to-use-vault-agent">When to use vault-agent</h2><ul>
<li>You have an application or tool that requires to read its configuration from a file.</li><li>You wish to have secrets that have a TTL and expire.</li><li>You have no issues with running your application with a sidecar.</li></ul><blockquote>
<p>Note: If you need to revoke tokens, or use additional secret backends, see <a href="/docs/mutating-webhook/consul-template/">Using consul-template in the mutating webhook</a>.</p></blockquote><h2 id="workflow">Workflow</h2><ul>
<li>Your pod starts up, the webhook will inject one container into the pods lifecycle.</li><li>The sidecar container is running Vault, using the <a href="https://www.vaultproject.io/docs/agent/">vault agent</a> that accesses Vault using the configuration specified inside a configmap and writes a configuration file based on a pre configured template (written inside the same configmap) onto a temporary file system which your application can use.</li></ul><h2 id="prerequisites">Prerequisites</h2><p>This document assumes the following.</p><ul>
<li>
<p>You have a working Kubernetes cluster which has:</p><ul>
<li>a working Vault installation</li><li>a working installation of the <a href="/docs/mutating-webhook/">mutating webhook</a>.</li></ul></li><li>
<p>You have a working knowledge of Kubernetes.</p></li><li>
<p>You can apply Deployments or PodSpec&rsquo;s to the cluster.</p></li><li>
<p>You can change the configuration of the <a href="/docs/mutating-webhook/configuration/">mutating webhook</a>.</p></li></ul><h2 id="use-vault-ttls">Use Vault TTLs</h2><p>If you wish to use Vault TTLs, you need a way to HUP your application on configuration file change. You can <a href="https://www.vaultproject.io/docs/agent/template/index.html">configure the Vault Agent to execute a command</a> when it writes a new configuration file using the <code>command</code> attribute. The following is a basic example which uses the Kubernetes authentication method.</p><pre data-src="https://bank-vaults.dev/docs/mutating-webhook/vault-agent-templating-example.yaml" data-download-link data-download-link-label="Download this file">
</pre><h2 id="configuration">Configuration</h2><p>To configure the webhook, you can either:</p><ul>
<li>set some sane defaults in the <a href="#defaults">environment of the mutating webhook</a>, or</li><li>configure it via annotations in your <a href="#podspec">PodSpec</a>.</li></ul><h3 id="enable-vault-agent-in-the-webhook">Enable vault agent in the webhook</h3><p>For the webhook to detect that it will need to mutate or change a PodSpec, add the <code>vault.security.banzaicloud.io/vault-agent-configmap</code> annotation to the Deployment or PodSpec you want to mutate, otherwise it will be ignored for configuration with Vault Agent.</p><h3 id="defaults">Defaults via environment variables</h3><table>
<thead>
<tr>
<th>Variable</th><th>default</th><th>Explanation</th></tr></thead><tbody>
<tr>
<td>VAULT_IMAGE</td><td>hashicorp/vault:latest</td><td>the vault image to use for the sidecar container</td></tr><tr>
<td>VAULT_IMAGE_PULL_POLICY</td><td>IfNotPresent</td><td>The pull policy for the vault agent container</td></tr><tr>
<td>VAULT_ADDR</td><td>https://127.0.0.1:8200</td><td>Kubernetes service Vault endpoint URL</td></tr><tr>
<td>VAULT_TLS_SECRET</td><td>""</td><td>supply a secret with the vault TLS CA so TLS can be verified</td></tr><tr>
<td>VAULT_AGENT_SHARE_PROCESS_NAMESPACE</td><td>Kubernetes version &lt;1.12 default off, 1.12 or higher default on</td><td>ShareProcessNamespace override</td></tr></tbody></table><h3 id="podspec">PodSpec annotations</h3><table>
<thead>
<tr>
<th>Annotation</th><th>default</th><th>Explanation</th></tr></thead><tbody>
<tr>
<td>vault.security.banzaicloud.io/vault-addr</td><td>Same as VAULT_ADDR above</td><td></td></tr><tr>
<td>vault.security.banzaicloud.io/vault-tls-secret</td><td>Same as VAULT_TLS_SECRET above</td><td></td></tr><tr>
<td>vault.security.banzaicloud.io/vault-agent-configmap</td><td>""</td><td>A configmap name which holds the vault agent configuration</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-agent-once</td><td>false</td><td>do not run vault-agent in daemon mode, useful for kubernetes jobs</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-agent-share-process-namespace</td><td>Same as VAULT_AGENT_SHARE_PROCESS_NAMESPACE above</td><td></td></tr><tr>
<td>vault.security.banzaicloud.io/vault-agent-cpu</td><td>&ldquo;100m&rdquo;</td><td>Specify the vault-agent container CPU resource limit</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-agent-memory</td><td>&ldquo;128Mi&rdquo;</td><td>Specify the vault-agent container memory resource limit</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-configfile-path</td><td>&ldquo;/vault/secrets&rdquo;</td><td>Mount path of Vault Agent rendered files</td></tr></tbody></table></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-9ad4aac418ac0e1def9bf0c4bfe6b5f4">5 - Using consul-template in the mutating webhook</h1><p>With Bank-Vaults you can use <a href="https://github.com/hashicorp/consul-template">Consul Template</a> as an addition to vault-env to handle secrets that expire, and supply them to applications that read their configurations from a file.</p><h2 id="when-to-use-consul-template">When to use consul-template</h2><ul>
<li>You have an application or tool that must read its configuration from a file.</li><li>You wish to have secrets that have a TTL and expire.</li><li>You do not wish to be limited on which vault secrets backend you use.</li><li>You can also expire tokens/revoke tokens (to do this you need to have a ready/live probe that can send a HUP to consul-template when the current details fail).</li></ul><h2 id="workflow">Workflow</h2><p>The following shows the general workflow for using Consul Template:</p><ol>
<li>Your pod starts up. The webhook injects an init container (running vault agent) and a sidecar container (running consul-template) into the pods lifecycle.</li><li>The <a href="https://www.vaultproject.io/docs/agent/">vault agent</a> in the init container logs in to Vault and retrieves a Vault token based on the configured VAULT_ROLE and Kubernetes Service Account.</li><li>The consul-template running in the sidecar container logs in to Vault using the Vault token and writes a configuration file based on a pre-configured template in a configmap onto a temporary file system which your application can use.</li></ol><h2 id="prerequisites">Prerequisites</h2><p>This document assumes the following.</p><ul>
<li>
<p>You have a working Kubernetes cluster which has:</p><ul>
<li>a working Vault installation</li><li>a working installation of the <a href="/docs/mutating-webhook/">mutating webhook</a>.</li></ul></li><li>
<p>You have a working knowledge of Kubernetes.</p></li><li>
<p>You can apply Deployments or PodSpec&rsquo;s to the cluster.</p></li><li>
<p>You can change the configuration of the <a href="/docs/mutating-webhook/configuration/">mutating webhook</a>.</p></li></ul><h2 id="use-vault-ttls">Use Vault TTLs</h2><p>If you wish to use Vault TTLs, you need a way to HUP your application on configuration file change. You can <a href="https://github.com/hashicorp/consul-template#configuration-file-format">configure the Consul Template to execute a command</a> when it writes a new configuration file using the <code>command</code> attribute. The following is a basic example (adapted from <a href="https://github.com/sethvargo/vault-kubernetes-workshop/blob/master/k8s/db-sidecar.yaml#L79-L100">here</a>).</p><pre data-src="https://bank-vaults.dev/docs/mutating-webhook/consul-template-example.yaml" data-download-link data-download-link-label="Download this file">
</pre><h2 id="configuration">Configuration</h2><p>To configure the webhook, you can either:</p><ul>
<li>set some sane defaults in the <a href="#defaults">environment of the mutating webhook</a>, or</li><li>configure it via annotations in your <a href="#podspec">PodSpec</a>.</li></ul><h3 id="enable-consul-template-in-the-webhook">Enable Consul Template in the webhook</h3><p>For the webhook to detect that it will need to mutate or change a PodSpec, add the <code>vault.security.banzaicloud.io/vault-ct-configmap</code> annotation to the Deployment or PodSpec you want to mutate, otherwise it will be ignored for configuration with Consul Template.</p><h3 id="defaults">Defaults via environment variables</h3><table>
<thead>
<tr>
<th>Variable</th><th>default</th><th>Explanation</th></tr></thead><tbody>
<tr>
<td>VAULT_IMAGE</td><td>hashicorp/vault:latest</td><td>the vault image to use for the init container</td></tr><tr>
<td>VAULT_ENV_IMAGE</td><td>ghcr.io/bank-vaults/vault-env:latest</td><td>the vault-env image to use</td></tr><tr>
<td>VAULT_CT_IMAGE</td><td>hashicorp/consul-template:0.32.0</td><td>the consul template image to use</td></tr><tr>
<td>VAULT_ADDR</td><td>https://127.0.0.1:8200</td><td>Kubernetes service Vault endpoint URL</td></tr><tr>
<td>VAULT_SKIP_VERIFY</td><td>&ldquo;false&rdquo;</td><td>should vault agent and consul template skip verifying TLS</td></tr><tr>
<td>VAULT_TLS_SECRET</td><td>""</td><td>supply a secret with the vault TLS CA so TLS can be verified</td></tr><tr>
<td>VAULT_AGENT</td><td>&ldquo;true&rdquo;</td><td>enable the vault agent</td></tr><tr>
<td>VAULT_CT_SHARE_PROCESS_NAMESPACE</td><td>Kubernetes version &lt;1.12 default off, 1.12 or higher default on</td><td>ShareProcessNamespace override</td></tr></tbody></table><h3 id="podspec">PodSpec annotations</h3><table>
<thead>
<tr>
<th>Annotation</th><th>default</th><th>Explanation</th></tr></thead><tbody>
<tr>
<td>vault.security.banzaicloud.io/vault-addr</td><td>Same as VAULT_ADDR above</td><td></td></tr><tr>
<td>vault.security.banzaicloud.io/vault-role</td><td>default</td><td>The Vault role for Vault agent to use</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-path</td><td>auth/&lt;method type></td><td>The mount path of the method</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-skip-verify</td><td>Same as VAULT_SKIP_VERIFY above</td><td></td></tr><tr>
<td>vault.security.banzaicloud.io/vault-tls-secret</td><td>Same as VAULT_TLS_SECRET above</td><td></td></tr><tr>
<td>vault.security.banzaicloud.io/vault-agent</td><td>Same as VAULT_AGENT above</td><td></td></tr><tr>
<td>vault.security.banzaicloud.io/vault-ct-configmap</td><td>""</td><td>A configmap name which holds the consul template configuration</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-ct-image</td><td>""</td><td>Specify a custom image for consul template</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-ct-once</td><td>false</td><td>do not run consul-template in daemon mode, useful for kubernetes jobs</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-ct-pull-policy</td><td>IfNotPresent</td><td>the Pull policy for the consul template container</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-ct-share-process-namespace</td><td>Same as VAULT_CT_SHARE_PROCESS_NAMESPACE above</td><td></td></tr><tr>
<td>vault.security.banzaicloud.io/vault-ct-cpu</td><td>&ldquo;100m&rdquo;</td><td>Specify the consul-template container CPU resource limit</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-ct-memory</td><td>&ldquo;128Mi&rdquo;</td><td>Specify the consul-template container memory resource limit</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-ignore-missing-secrets</td><td>&ldquo;false&rdquo;</td><td>When enabled will only log warnings when Vault secrets are missing</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-env-passthrough</td><td>""</td><td>Comma seprated list of <code>VAULT_*</code> related environment variables to pass through to main process. E.g.<code>VAULT_ADDR,VAULT_ROLE</code>.</td></tr><tr>
<td>vault.security.banzaicloud.io/vault-ct-secrets-mount-path</td><td>&ldquo;/vault/secret&rdquo;</td><td>Mount path of Consul template rendered files</td></tr></tbody></table></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-4fdd9c4aa5b4e731487b9967ac5afd93">6 - Transit Encryption</h1><p>The transit secrets engine handles cryptographic functions on data in-transit, mainly to encrypt data from applications while still storing that encrypted data in some primary data store. Vault doesn&rsquo;t store the data sent to the secrets engine, it can also be viewed as &ldquo;cryptography as a service&rdquo; or &ldquo;encryption as a service&rdquo;. For details about transit encryption, see the <a href="https://www.vaultproject.io/docs/secrets/transit/index.html">official documentation</a>.</p><blockquote>
<p>Note:</p><ul>
<li>Transit encryption supports only POD mutations.</li><li>You can also <a href="/docs/istio/">use Bank-Vaults with Istio</a>.</li></ul></blockquote><h2 id="enable-transit-secrets-engine">Enable Transit secrets engine</h2><p>To enable and test the Transit secrets engine, complete the following steps.</p><ol>
<li>
<p>Enable the Transit secrets engine:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>vault secrets <span style="color:#204a87">enable</span> transit
</span></span></code></pre></div></li><li>
<p>Create a named encryption key:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>vault write -f transit/keys/my-key
</span></span></code></pre></div></li><li>
<p>Encrypt data with encryption key:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>vault write transit/encrypt/my-key <span style="color:#000">plaintext</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#204a87;font-weight:700">$(</span>base64 <span style="color:#ce5c00;font-weight:700">&lt;&lt;&lt;</span> <span style="color:#4e9a06">&#34;my secret data&#34;</span><span style="color:#204a87;font-weight:700">)</span>
</span></span></code></pre></div></li><li>
<p>After completing the previous steps, the webhook will mutate pods that have at least one environment variable with a value which is encrypted by Vault. For example (in the last line of the example):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">replicas</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">selector</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">matchLabels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">template</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">annotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;https://vault:8200&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, the address of the Vault service, default values is https://vault:8200</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-role</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, the default value is the name of the ServiceAccount the Pod runs in, in case of Secrets and ConfigMaps it is &#34;default&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-skip-verify</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;false&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, skip TLS verification of the Vault server certificate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-tls-secret</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault-tls&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optinal, the name of the Secret where the Vault CA cert is, if not defined it is not mounted</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-agent</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;false&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, if true, a Vault Agent will be started to do Vault authentication, by default not needed and vault-env will do Kubernetes Service Account based Vault authentication</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;kubernetes&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># optional, the Kubernetes Auth mount path in Vault the default value is &#34;kubernetes&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/transit-key-id</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;my-key&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># required if encrypted data was found; transit key id that created before</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">serviceAccountName</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">containers</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">alpine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">image</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">alpine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">command</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">[</span><span style="color:#4e9a06">&#34;sh&#34;</span><span style="color:#000;font-weight:700">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;-c&#34;</span><span style="color:#000;font-weight:700">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;echo $AWS_SECRET_ACCESS_KEY &amp;&amp; echo going to sleep... &amp;&amp; sleep 10000&#34;</span><span style="color:#000;font-weight:700">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># Value based on encrypted key that stored in Vault, so value from this example</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># not the same as you can get after `encrypt`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">value</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault:v1:8SDd3WHDOjf7mq69CyCqYjBXAiQQAVZRkFM13ok481zoCmHnSeDX9vyf7w==</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li></ol></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-789c03a017d516c224edcadf80386609">7 - Monitoring the Webhook with Grafana and Prometheus</h1><p>To monitor the webhook with Prometheus and Grafana, complete the following steps.</p><h2 id="prerequisites">Prerequisites</h2><ul>
<li>An already deployed and configured mutating webhook. For details, see <a href="/docs/mutating-webhook/">Mutating Webhook</a>.</li></ul><h2 id="steps">Steps</h2><ol>
<li>
<p>Install the Prometheus Operator Bundle:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/bundle.yaml
</span></span></code></pre></div></li><li>
<p>Install the webhook with monitoring and Prometheus Operator ServiceMonitor enabled:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm upgrade --wait --install vault-secrets-webhook <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    banzaicloud-stable/vault-secrets-webhook <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    --namespace vault-infra <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    --set metrics.enabled<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#204a87">true</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    --set metrics.serviceMonitor.enabled<span style="color:#ce5c00;font-weight:700">={}</span>
</span></span></code></pre></div></li><li>
<p>Create a Prometheus instance which monitors the components of Bank-Vaults:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/bank-vaults/vault-operator/main/test/prometheus.yaml
</span></span></code></pre></div></li><li>
<p>Create a Grafana instance and expose it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl create deployment grafana --image grafana/grafana
</span></span><span style="display:flex"><span>kubectl expose deployment grafana --port <span style="color:#0000cf;font-weight:700">3000</span> --type LoadBalancer
</span></span></code></pre></div></li><li>
<p>Fetch the external IP address of the Grafana instance, and open it in your browser on port 3000.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get service grafana
</span></span></code></pre></div></li><li>
<p><a href="https://prometheus.io/docs/visualization/grafana/#creating-a-prometheus-data-source">Create a Prometheus Data Source</a> in this Grafana instance which grabs data from http://prometheus-operated:9090/.</p></li><li>
<p><a href="https://prometheus.io/docs/visualization/grafana/#importing-pre-built-dashboards-from-grafana-com">Import</a> the <a href="https://grafana.com/grafana/dashboards/7088">Kubewebhook admission webhook dashboard</a> to Grafana (created by Xabier Larrakoetxea).</p></li><li>
<p>Select the previously created Data Source to feed this dashboard.</p></li></ol></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-d01053a982de9bc8c5063273f84aa47f">8 - Injecting consul-template into the Prometheus operator for Vault metrics</h1><p>To get vault metrics into Prometheus you need to log in to Vault to get access to a native Vault endpoint that provides the metrics.</p><h2 id="workflow">Workflow</h2><ol>
<li>The webhook injects <code>vault-agent</code> as an init container, based on the Kubernetes Auth role configuration <code>prometheus-operator-prometheus</code>.</li><li>The vault-agent grabs a token with the policy of <code>prometheus-operator-prometheus</code>.</li><li><code>consul-template</code> runs as a sidecar, and uses the token from the previous step to retrieve a new token using the Token Auth role <code>prometheus-metrics</code> which has the policy <code>prometheus-metrics</code> applied to it.</li><li>Prometheus can now use this second token to read the Vault Prometheus endpoint.</li></ol><p>The trick here is that Prometheus runs with the SecurityContext UID of 1000 but the default <code>consul-template</code> image is running under the UID of 100. This is because of a Dockerfile Volume that is configured which dockerd mounts as 100 (/consul-template/data).</p><p>Subsequently using this <code>consul-template</code> means it will never start, so we need to ensure we do not use this declared volume and change the UID using a custom Dockerfile and entrypoint.</p><h2 id="prerequisites">Prerequisites</h2><p>This document assumes you have a working Kubernetes cluster which has a:</p><ul>
<li>
<p>You have a working Kubernetes cluster which has:</p><ul>
<li>a working Vault installation</li><li>a working installation of the <a href="/docs/mutating-webhook/">mutating webhook</a>.</li></ul></li><li>
<p>You have the <a href="https://github.com/coreos/prometheus-operator">CoreOS Prometheus Operator</a> installed and working.</p></li><li>
<p>You have a working knowledge of Kubernetes.</p></li><li>
<p>You can apply Deployments or PodSpec&rsquo;s to the cluster.</p></li><li>
<p>You can change the configuration of the mutating webhook.</p></li></ul><h2 id="configuration">Configuration</h2><h3 id="custom-consul-template-image-docker-entrypointsh">Custom consul-template image; docker-entrypoint.sh</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">#!/bin/dumb-init /bin/sh
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">set</span> -ex
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Note above that we run dumb-init as PID 1 in order to reap zombie processes</span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># as well as forward signals to all processes in its session. Normally, sh</span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># wouldn&#39;t do either of these functions so we&#39;d leak zombies as well as do</span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># unclean termination of all our sub-processes.</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># CONSUL_DATA_DIR is exposed as a volume for possible persistent storage.</span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># CT_CONFIG_DIR isn&#39;t exposed as a volume but you can compose additional config</span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># files in there if you use this image as a base, or use CT_LOCAL_CONFIG below.</span>
</span></span><span style="display:flex"><span><span style="color:#000">CT_DATA_DIR</span><span style="color:#ce5c00;font-weight:700">=</span>/consul-template/config
</span></span><span style="display:flex"><span><span style="color:#000">CT_CONFIG_DIR</span><span style="color:#ce5c00;font-weight:700">=</span>/consul-template/config
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># You can also set the CT_LOCAL_CONFIG environment variable to pass some</span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># Consul Template configuration JSON without having to bind any volumes.</span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">if</span> <span style="color:#ce5c00;font-weight:700">[</span> -n <span style="color:#4e9a06">&#34;</span><span style="color:#000">$CT_LOCAL_CONFIG</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:700">]</span><span style="color:#000;font-weight:700">;</span> <span style="color:#204a87;font-weight:700">then</span>
</span></span><span style="display:flex"><span>  <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$CT_LOCAL_CONFIG</span><span style="color:#4e9a06">&#34;</span> &gt; <span style="color:#4e9a06">&#34;</span><span style="color:#000">$CT_CONFIG_DIR</span><span style="color:#4e9a06">/local-config.hcl&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">fi</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># If the user is trying to run consul-template directly with some arguments, then</span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># pass them to consul-template.</span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">if</span> <span style="color:#ce5c00;font-weight:700">[</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">1</span><span style="color:#000;font-weight:700">:</span><span style="color:#000">0</span><span style="color:#000;font-weight:700">:</span><span style="color:#000">1</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#4e9a06">&#39;-&#39;</span> <span style="color:#ce5c00;font-weight:700">]</span><span style="color:#000;font-weight:700">;</span> <span style="color:#204a87;font-weight:700">then</span>
</span></span><span style="display:flex"><span>  <span style="color:#204a87">set</span> -- /bin/consul-template <span style="color:#4e9a06">&#34;</span><span style="color:#000">$@</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">fi</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic"># If we are running Consul, make sure it executes as the proper user.</span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">if</span> <span style="color:#ce5c00;font-weight:700">[</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$1</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:700">=</span> <span style="color:#4e9a06">&#39;/bin/consul-template&#39;</span> <span style="color:#ce5c00;font-weight:700">]</span><span style="color:#000;font-weight:700">;</span> <span style="color:#204a87;font-weight:700">then</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>  <span style="color:#8f5902;font-style:italic"># Set the configuration directory</span>
</span></span><span style="display:flex"><span>  <span style="color:#204a87">shift</span>
</span></span><span style="display:flex"><span>  <span style="color:#204a87">set</span> -- /bin/consul-template <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    -config<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#000">$CT_CONFIG_DIR</span><span style="color:#4e9a06">&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    <span style="color:#4e9a06">&#34;</span><span style="color:#000">$@</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span>  <span style="color:#8f5902;font-style:italic"># Check the user we are running as</span>
</span></span><span style="display:flex"><span>  <span style="color:#000">current_user</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:700">$(</span>id -un<span style="color:#204a87;font-weight:700">)</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex"><span>  <span style="color:#204a87;font-weight:700">if</span> <span style="color:#ce5c00;font-weight:700">[</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">current_user</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:700">==</span> <span style="color:#4e9a06">&#34;root&#34;</span> <span style="color:#ce5c00;font-weight:700">]</span><span style="color:#000;font-weight:700">;</span> <span style="color:#204a87;font-weight:700">then</span>
</span></span><span style="display:flex"><span>    <span style="color:#8f5902;font-style:italic"># Run under the right user</span>
</span></span><span style="display:flex"><span>    <span style="color:#204a87">set</span> -- gosu consul-template <span style="color:#4e9a06">&#34;</span><span style="color:#000">$@</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex"><span>  <span style="color:#204a87;font-weight:700">fi</span>
</span></span><span style="display:flex"><span><span style="color:#204a87;font-weight:700">fi</span>
</span></span><span style="display:flex"><span>
</span></span><span style="display:flex"><span><span style="color:#204a87">exec</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$@</span><span style="color:#4e9a06">&#34;</span>
</span></span></code></pre></div><h3 id="dockerfile">Dockerfile</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">FROM</span><span style="color:#4e9a06"> hashicorp/consul-template:0.32.0</span><span style="color:#a40000">
</span></span></span><span style="display:flex"><span><span style="color:#a40000">
</span></span></span><span style="display:flex"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:700">ADD</span> build/docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh<span style="color:#a40000">
</span></span></span><span style="display:flex"><span><span style="color:#a40000">
</span></span></span><span style="display:flex"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:700">RUN</span> apk --no-cache add shadow <span style="color:#ce5c00;font-weight:700">&amp;&amp;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    usermod -u <span style="color:#0000cf;font-weight:700">1000</span> consul-template <span style="color:#ce5c00;font-weight:700">&amp;&amp;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex"><span><span style="color:#4e9a06"></span>    chown -Rc consul-template:consul-template /consul-template/<span style="color:#a40000">
</span></span></span><span style="display:flex"><span><span style="color:#a40000">
</span></span></span><span style="display:flex"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:700">USER</span><span style="color:#4e9a06"> consul-template:consul-template</span><span style="color:#a40000">
</span></span></span></code></pre></div><h3 id="configmap">ConfigMap</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ConfigMap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">prometheus</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">consul-template</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-consul-template</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">config.hcl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">    vault {
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      ssl {
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">        ca_cert = &#34;/vault/tls/ca.crt&#34;
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      }
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      grace = &#34;5m&#34;
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      retry {
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">        backoff = &#34;1s&#34;
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      }
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">    }
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">    template {
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      destination = &#34;/vault/secrets/vault-token&#34;
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      command     = &#34;/bin/sh -c &#39;/usr/bin/curl -s http://127.0.0.1:9090/-/reload&#39;&#34;
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      contents = &lt;&lt;-EOH
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      {{with secret &#34;/auth/token/create/prometheus-metrics&#34; &#34;policy=prometheus-metrics&#34; }}{{.Auth.ClientToken}}{{ end }}
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      EOH
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      wait {
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">        min = &#34;2s&#34;
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">        max = &#34;60s&#34;
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">      }
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">    }</span><span style="color:#f8f8f8;text-decoration:underline">    
</span></span></span></code></pre></div><h2 id="vault-cr-snippets">Vault CR snippets</h2><p>Set the vault image to use:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault.banzaicloud.com/v1alpha1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">size</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">image</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hashicorp/vault:1.14.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Our Vault config for telemetry:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># A YAML representation of a final vault config file.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># See https://www.vaultproject.io/docs/configuration/ for more information.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">telemetry</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">prometheus_retention_time</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">30s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">disable_hostname</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Disable statsd:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># since we are running Vault 1.1.0 with the native Prometheus support, we do not need the statsD exporter</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">statsdDisabled</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Vault externalConfig policies:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">externalConfig</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-operator-prometheus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">rules</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">          path &#34;auth/token/create/prometheus-metrics&#34; {
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">            capabilities = [&#34;read&#34;, &#34;update&#34;]
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">          }</span><span style="color:#f8f8f8;text-decoration:underline">          
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-metrics</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">rules</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path &#34;sys/metrics&#34; {</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">capabilities = [&#34;list&#34;, &#34;read&#34;]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>auth:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">auth</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">token</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-metrics</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">allowed_policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">prometheus-metrics</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">orphan</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-operator-prometheus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">bound_service_account_names</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-operator-prometheus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">bound_service_account_namespaces</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mynamespace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-operator-prometheus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">ttl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">4h</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="prometheus-operator-snippets">Prometheus Operator Snippets</h2><h3 id="prometheusspec">prometheusSpec</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">prometheusSpec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#prometheusspec</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">podMetadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">annotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-ct-configmap</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;prometheus-consul-template&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-role</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-operator-prometheus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-ct-image</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;mycustomimage:latest&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">secrets</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">etcd-client-tls</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">vault-tls</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="prometheus-crd-servicemonitor">Prometheus CRD ServiceMonitor</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">monitoring.coreos.com/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceMonitor</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/instance</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-operator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">prometheus-operator-vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">endpoints</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">bearerTokenFile</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/vault/secrets/vault-token</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">interval</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">30s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">params</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">format</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">[</span><span style="color:#4e9a06">&#39;prometheus&#39;</span><span style="color:#000;font-weight:700">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/v1/sys/metrics</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">port</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">api-port</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">scheme</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">tlsConfig</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">caFile</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/prometheus/secrets/vault-tls/ca.crt</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">certFile</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/prometheus/secrets/vault-tls/server.crt</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">keyFile</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/prometheus/secrets/vault-tls/server.key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">insecureSkipVerify</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">selector</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">matchLabels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">vault_cr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-40ade858fb140e470d28b5c4d75ad0ef">9 - Comparison of Banzai Cloud and HashiCorp mutating webhook for Vault</h1><h4 id="legend">Legend</h4><ul>
<li>✅: Implemented</li><li>o: Planned/In-progress</li></ul><table>
<thead>
<tr>
<th>Feature</th><th>Banzai Cloud Webhook</th><th>HashiCorp Webhook</th></tr></thead><tbody>
<tr>
<td>Automated Vault and K8S setup</td><td>✅ (operator)</td><td></td></tr><tr>
<td>vault-agent/consul-template sidecar injection</td><td>✅</td><td>✅</td></tr><tr>
<td>Direct env var injection</td><td>✅</td><td></td></tr><tr>
<td>Injecting into K8S Secrets</td><td>✅</td><td></td></tr><tr>
<td>Injecting into K8S ConfigMaps</td><td>✅</td><td></td></tr><tr>
<td>Injecting into K8S CRDs</td><td>✅</td><td></td></tr><tr>
<td>Sidecar-less dynamic secrets</td><td>✅</td><td></td></tr><tr>
<td>CSI Driver</td><td>o</td><td></td></tr><tr>
<td>Native Kubernetes sidecar</td><td>o</td><td></td></tr></tbody></table></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-06a0154e4fe026f4982258ce9841854f">10 - Running the webhook and Vault on different clusters</h1><p>This section describes how to configure the webhook and Vault when the webhook runs on a different cluster from Vault, or if Vault runs outside Kubernetes.</p><p>Let&rsquo;s suppose you have two different K8S clusters:</p><ul>
<li><code>cluster1</code> contains <code>vault-operator</code></li><li><code>cluster2</code> contains <code>vault-secrets-webhook</code></li></ul><p>Basically, you have to grant <code>cluster2</code> access to the Vault running on <code>cluster1</code>. To achieve this, complete the following steps.</p><ol>
<li>
<p>Extract the <em>cluster.certificate-authority-data</em> and the <em>cluster.server</em> fields from your <code>cluster2</code> kubeconfig file. You will need them in the <code>externalConfig</code> section of the <code>cluster1</code> configuration. For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl config view -o yaml --minify<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#204a87">true</span> --raw<span style="color:#ce5c00;font-weight:700">=</span><span style="color:#204a87">true</span>
</span></span></code></pre></div></li><li>
<p>Decode the certificate from the <em>cluster.certificate-authority-data</em> field, for example::</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>grep <span style="color:#4e9a06">&#39;certificate-authority-data&#39;</span> <span style="color:#000">$HOME</span>/.kube/config <span style="color:#000;font-weight:700">|</span> awk <span style="color:#4e9a06">&#39;{print $2}&#39;</span> <span style="color:#000;font-weight:700">|</span> base64 --decode
</span></span></code></pre></div></li><li>
<p>On <code>cluster2</code>, create a <code>vault</code> ServiceAccount and the <code>vault-auth-delegator</code> ClusterRoleBinding:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/bank-vaults/vault-operator/main/test/rbac.yaml
</span></span></code></pre></div><p>You can use the <code>vault</code> ServiceAccount token as a <code>token_reviewer_jwt</code> in the auth configuration. To retrieve the token, run the following command:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get secret <span style="color:#204a87;font-weight:700">$(</span>kubectl get sa vault -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#39;{.secrets[0].name}&#39;</span><span style="color:#204a87;font-weight:700">)</span> -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#39;{.data.token}&#39;</span> <span style="color:#000;font-weight:700">|</span> base64 --decode
</span></span></code></pre></div></li><li>
<p>In the <code>vault.banzaicloud.com</code> custom resource (for example, <a href="https://github.com/bank-vaults/vault-operator/tree/main/deploy/examples/cr.yaml">https://github.com/bank-vaults/vault-operator/tree/main/deploy/examples/cr.yaml</a>) of <code>cluster1</code>, define an <code>externalConfig</code> section. Fill the values of the <code>kubernetes_ca_cert</code>, <code>kubernetes_host</code>, and <code>token_reviewer_jwt</code> using the data collected in the previous steps.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">externalConfig</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">rules</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path &#34;secret/*&#34; {</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">capabilities = [&#34;create&#34;, &#34;read&#34;, &#34;update&#34;, &#34;delete&#34;, &#34;list&#34;]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">auth</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">token_reviewer_jwt</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;token-for-cluster2-service-account&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">kubernetes_ca_cert</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">            -----BEGIN CERTIFICATE-----
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">            &lt;certificate-from-certificate-authority-data-on-cluster2&gt;
</span></span></span><span style="display:flex"><span><span style="color:#8f5902;font-style:italic">            -----END CERTIFICATE-----</span><span style="color:#f8f8f8;text-decoration:underline">            
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">kubernetes_host</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;cluster.server-field-on-cluster2&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># Allow every pod in the default namespace to use the secret kv store</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">bound_service_account_names</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">[</span><span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#000;font-weight:700">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault-secrets-webhook&#34;</span><span style="color:#000;font-weight:700">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">bound_service_account_namespaces</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">[</span><span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#000;font-weight:700">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vswh&#34;</span><span style="color:#000;font-weight:700">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">ttl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1h</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li><li>
<p>In a production environment, it is highly recommended to specify TLS config for your Vault ingress.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Request an Ingress controller with the default configuration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">ingress</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Specify Ingress object annotations here, if TLS is enabled (which is by default)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># the operator will add NGINX, Traefik and HAProxy Ingress compatible annotations</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># to support TLS backends</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">annotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Override the default Ingress specification here</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># This follows the same format as the standard Kubernetes Ingress</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># See: https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#ingressspec-v1beta1-extensions</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">tls</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">hosts</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">vault-dns-name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">secretName</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-ingress-tls-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li><li>
<p>Deploy the <code>Vault</code> custom resource containing the <code>externalConfig</code> section to <code>cluster1</code>:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f your-proper-vault-cr.yaml
</span></span></code></pre></div></li><li>
<p>After Vault started in <code>cluster1</code>, you can use the <code>vault-secrets-webhook</code> in <code>cluster2</code> with the proper annotations. For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">replicas</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">selector</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">matchLabels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hello-secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">template</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">app.kubernetes.io/name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hello-secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">annotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;https://vault-dns-name:443&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-role</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-skip-verify</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">vault.security.banzaicloud.io/vault-path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;kubernetes&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li></ol><hr>
<p>Also you can use directly cloud identity to auth the mutating-webhook against the external vault.</p><ol>
<li>
<p>Add your cloud auth method in your external vault <a href="https://www.vaultproject.io/docs/auth/azure">https://www.vaultproject.io/docs/auth/azure</a></p></li><li>
<p>Configure your <code>vault-secrets-webhook</code> to use the good method. For example:</p></li></ol><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">VAULT_ADDR</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://external-vault.example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">VAULT_AUTH_METHOD</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">azure</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">VAULT_PATH</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">azure</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">VAULT_ROLE</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>For <code>VAULT_AUTH_METHOD</code> env var, these types: <strong>&ldquo;kubernetes&rdquo;, &ldquo;aws-ec2&rdquo;, &ldquo;gcp-gce&rdquo;, &ldquo;gcp-iam&rdquo;, &ldquo;jwt&rdquo;, &ldquo;azure&rdquo;</strong> are supported.</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class="row">
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
<a class="text-white" target="_blank" rel="noopener" href="https://github.com/banzaicloud/bank-vaults" aria-label="GitHub">
<i class="fab fa-github"></i>
</a>
</li><li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
<a class="text-white" target="_blank" rel="noopener" href="https://eti.cisco.com/slack" aria-label="Slack">
<i class="fab fa-slack"></i>
</a>
</li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class="text-white">&copy; 2023 Bank-Vaults maintainers All Rights Reserved</small>
</div></div></div></footer></div><script src="/js/main.min.2aff983e9d0d8ecff9ed53e14b657216e2d8d2aff059bf4a5651283020995f1b.js" integrity="sha256-Kv+YPp0Njs/57VPhS2VyFuLY0q/wWb9KVlEoMCCZXxs=" crossorigin="anonymous"></script>
<script src='/js/prism.js'></script>
<script src='/js/tabpane-persist.js'></script>
<script src="/js/tocbot.min.js"></script>
<script type="text/javascript">tocbot.init({tocSelector:".td-toc",contentSelector:".td-content",headingSelector:"h2, h3, h4",ignoreHiddenElements:!0})</script>
</body></html>