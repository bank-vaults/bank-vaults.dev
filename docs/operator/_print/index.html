<!doctype html><html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name="generator" content="Hugo 0.110.0">
<link rel="canonical" type="text/html" href="https://bank-vaults.dev/docs/operator/">
<link rel="alternate" type="text/releases" href="https://bank-vaults.dev/docs/operator/releases.releases">
<meta name="robots" content="noindex, nofollow">
<link rel="shortcut icon" href="/favicons/favicon.ico">
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">
<title>Operator | Bank-Vaults</title><meta name="description" content="Documentation for the Bank-Vaults">
<meta property="og:title" content="Operator">
<meta property="og:description" content="Documentation for the Bank-Vaults">
<meta property="og:type" content="website">
<meta property="og:url" content="https://bank-vaults.dev/docs/operator/"><meta property="og:site_name" content="Bank-Vaults">
<meta itemprop="name" content="Operator">
<meta itemprop="description" content="Documentation for the Bank-Vaults"><meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Operator">
<meta name="twitter:description" content="Documentation for the Bank-Vaults">
<meta name="twitter:site" content="@calisti12">
<link rel="preload" href="/scss/main.min.676617caf057b12362ecf7673d65047c5fe898a6461e02d928249cbc94b1bdab.css" as="style">
<link href="/scss/main.min.676617caf057b12362ecf7673d65047c5fe898a6461e02d928249cbc94b1bdab.css" rel="stylesheet" integrity>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK" crossorigin="anonymous"></script>
<script defer src="https://unpkg.com/lunr@2.3.9/lunr.min.js" integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli" crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css">
<script src="/js/w3.js" type="application/x-javascript"></script>
</head><body class="td-section">
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg width="144.26347" height="144.26346" viewBox="0 0 144.26348 144.26346" id="svg70" sodipodi:docname="logo.svg" inkscape:version="1.2.1 (9c6d41e4, 2022-07-14)" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/"><sodipodi:namedview pagecolor="#ffffff" bordercolor="#666666" borderopacity="1" objecttolerance="10" gridtolerance="10" guidetolerance="10" inkscape:pageopacity="0" inkscape:pageshadow="2" inkscape:window-width="1309" inkscape:window-height="456" id="namedview72" showgrid="false" inkscape:zoom="1.4142136" inkscape:cx="252.79067" inkscape:cy="89.095452" inkscape:window-x="0" inkscape:window-y="25" inkscape:window-maximized="0" inkscape:current-layer="g89" showguides="true" inkscape:guide-bbox="true" fit-margin-top="0" fit-margin-left="0" fit-margin-right="0" fit-margin-bottom="0" inkscape:showpageshadow="0" inkscape:pagecheckerboard="1" inkscape:deskcolor="#d1d1d1"/><defs id="defs4"><style id="style2">.cls-1{fill:#36a8e1}</style><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="276.63062" x2="-493.32941" y1="231.5972" x1="-498.4776" gradientUnits="userSpaceOnUse" id="SVGID_1_"><stop id="stop1134" style="stop-color:#3C8ECD" offset=".4032"/><stop id="stop1136" style="stop-color:#82CEF2" offset=".9943"/></linearGradient><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="271.8768" x2="-515.39728" y1="233.5062" x1="-511.01059" gradientUnits="userSpaceOnUse" id="SVGID_2_"><stop id="stop1141" style="stop-color:#C18DBE" offset=".4032"/><stop id="stop1143" style="stop-color:#9DB4DD" offset="1"/></linearGradient><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="282.21011" x2="-499.84381" y1="229.3567" x1="-493.8013" gradientUnits="userSpaceOnUse" id="SVGID_3_"><stop id="stop1148" style="stop-color:#454494" offset=".4032"/><stop id="stop1150" style="stop-color:#76A1D6" offset="1"/></linearGradient><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="267.82639" x2="-470.24661" y1="235.1331" x1="-473.98431" gradientUnits="userSpaceOnUse" id="SVGID_4_"><stop id="stop1155" style="stop-color:#56BDC1" offset=".4032"/><stop id="stop1157" style="stop-color:#82CEF2" offset=".9943"/></linearGradient><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="260.12711" x2="-494.45529" y1="229.73219" x1="-492.93121" gradientUnits="userSpaceOnUse" id="SVGID_5_"><stop id="stop1162" style="stop-color:#13287A" offset=".0057"/><stop id="stop1164" style="stop-color:#1A3D8E" offset="1"/></linearGradient><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="235.2251" x2="-507.06671" y1="273.6745" x1="-512.83838" gradientUnits="userSpaceOnUse" id="SVGID_6_"><stop id="stop1169" style="stop-color:#466BB3" offset="0"/><stop id="stop1171" style="stop-color:#3C3079" offset=".7268"/></linearGradient><linearGradient gradientTransform="matrix(1,0,0,-1,539,276.5)" y2="266.69089" x2="-476.4068" y1="238.7536" x1="-482.8345" gradientUnits="userSpaceOnUse" id="SVGID_7_"><stop id="stop1176" style="stop-color:#1972A0" offset=".1924"/><stop id="stop1178" style="stop-color:#3B9FD9" offset="1"/></linearGradient></defs><g id="g2191-6" transform="matrix(1.0391419,0,0,1.0391419,-785.98152,-409.33734)"/><g id="g378" transform="matrix(0.21956619,0,0,0.21956619,-62.665715,99.533341)"><g id="g89" transform="matrix(0.96603773,0,0,0.96603773,0,19.798907)"><rect transform="matrix(4.5544353,0,0,4.5544353,0,-623.95763)" inkscape:export-ydpi="83.459999" inkscape:export-xdpi="83.459999" y="0" x="0" height="265" width="279.07285" id="rect1490-6" style="opacity:1;vector-effect:none;fill:none;fill-opacity:1;stroke:none;stroke-width:.540616;stroke-linecap:butt;stroke-linejoin:bevel;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;paint-order:stroke fill markers"/><g transform="matrix(2.2671253,0,0,2.2671253,-1470.9633,-791.56917)" id="g465-0"><path inkscape:connector-curvature="0" id="path218-5-3" d="m1079.1383 283.12854a150 150 0 01-150.00003 150 150 150 0 01-150-150 150 150 0 01150-150 150 150 0 01150.00003 150z" style="opacity:1;vector-effect:none;fill:#36a8e1;fill-opacity:1;stroke:none;stroke-width:1.59412;stroke-linecap:butt;stroke-linejoin:bevel;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;paint-order:stroke fill markers"/><g transform="matrix(2.0690654,0,0,2.0690654,739.12048,-2709.7574)" id="g1372-0-6"><path id="Path_1631-8-3-1" d="m140.98383 1464.3453c-.23051-1e-4-.46029-.026-.68499-.077l-25.05227-5.7194.12354-.2651c1.52748-3.2666 2.35115-6.818 2.41755-10.4236l.006-.2901 25.014 5.7107c.79405.1802 1.48298.6706 1.91325 1.362.43597.6876.57876 1.5212.39658 2.3148l-1.14156 5.0004c-.18024.794-.67067 1.483-1.36196 1.9133-.48769.3088-1.05281.4733-1.63004.4745z" class="cls-1" data-name="Path 1631" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="ccccccccccccc"/><path id="Path_1632-4-6-0" d="m42.692762 1464.3453c-1.431928.0-2.67294-.9922-2.993412-2.3878l-1.141574-5.0004c-.182495-.7936-.03976-1.6272.396351-2.3149.43031-.6912 1.11923-1.1816 1.913251-1.3619l25.027696-5.7136.0056.2898c.06623 3.6055.889568 7.1567 2.416603 10.4235l.123771.265-25.064544 5.7224c-.224287.051-.453658.078-.683811.078z" class="cls-1" data-name="Path 1632" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="cccccccccccc"/><path id="Path_1633-8-1-6" d="m86.203652 1421.9854v-25.527c.0018-1.6952 1.375526-3.0689 3.070652-3.0707h5.128931c1.695126.0 3.068839 1.3755 3.070651 3.0707v25.5244l-.284625-.06c-3.528917-.734-7.171122-.734-10.700038.0z" class="cls-1" data-name="Path 1633" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="ccccccccc"/><path id="Path_1634-1-0-3" d="m68.4782 1436.0192-20.013323-15.9593c-.637548-.507-1.045807-1.2479-1.133778-2.0576-.09463-.8087.138439-1.6218.647198-2.2577l3.197729-4.0099c.506674-.6378 1.24758-1.0461 2.057336-1.1339.808868-.095 1.622095.138 2.257874.647l19.982853 15.9355-.222741.1854c-2.774754 2.3028-5.037618 5.1601-6.643471 8.3886z" class="cls-1" data-name="Path 1634" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="ccccccccccc"/><path id="Path_1635-0-6-20" d="m111.69006 1497.5553c-1.18101 8e-4-2.25818-.6747-2.77162-1.7383l-11.17906-23.2188.283444-.069c3.503736-.8523 6.788826-2.4326 9.641606-4.6381l.23078-.1776 11.1774 23.2146c.35415.7333.40034 1.5777.12826 2.3453-.26575.7699-.8286 1.4012-1.56296 1.7533l-4.6211 2.2253c-.41379.1996-.8673.3034-1.32675.3035z" class="cls-1" data-name="Path 1635" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="cccccccccccc"/><path id="Path_1636-3-3-61" d="m71.986066 1497.5553c-.459533.0-.913133-.1036-1.326994-.3035l-4.621331-2.2253c-.734212-.3523-1.297005-.9837-1.56296-1.7533-.272113-.7676-.225844-1.612.128494-2.3453l11.180949-23.2221.230772.1778c2.851924 2.2071 6.136543 3.7892 9.64019 4.6431l.283445.069-11.180476 23.2209c-.513556 1.0637-1.590928 1.7393-2.772089 1.7383z" class="cls-1" data-name="Path 1636" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="cccccccccccc"/><path id="Path_1637-0-2-5" d="m115.20736 1436.0117-.13061-.2615c-1.60686-3.2281-3.87061-6.0848-6.64607-8.3867l-.22298-.1853 19.97672-15.9299c1.32641-1.0555 3.25699-.8379 4.3152.4864l3.19773 4.0099c1.05536 1.3265.8379 3.2569-.48611 4.3153z" class="cls-1" data-name="Path 1637" inkscape:connector-curvature="0" style="fill:#fff;stroke-width:.236204" sodipodi:nodetypes="ccccccccc"/></g><path sodipodi:nodetypes="ccccccccccccccccc" style="fill:#fff;stroke-width:.488708" inkscape:connector-curvature="0" data-name="Path 1611" class="cls-1" d="m953.64449 351.25645v0l-49.11506-.0269c-4.61319.0-8.97664-2.09451-11.8425-5.70793l-30.605-38.41323c-2.88324-3.59976-3.95895-8.32323-2.91945-12.81745l10.95094-47.87714c1.01715-4.50022 4.03882-8.28619 8.20095-10.27663l44.26-21.28965c4.15116-2.00969 8.99505-2.00969 13.14622.0l44.24138 21.33123c4.16027 1.9952 7.17883 5.77994 8.19205 10.28285l10.9077 47.88769c1.03498 4.49504-.0455 9.2183-2.93249 12.81517l-30.64182 38.38551c-2.8669 3.60969-7.22725 5.70937-11.83609 5.69717z" id="path1253-3-0-5"/><path sodipodi:nodetypes="ccccccccccccccccc" style="fill:#36a8e1;fill-opacity:1;stroke-width:.37402" inkscape:connector-curvature="0" data-name="Path 1611" class="cls-1" d="m947.8838 335.07491v0l-37.58892-.0228c-3.53065.0-6.86992-1.60353-9.06334-4.36945L877.8089 301.28397c-2.20666-2.75352-3.02994-6.36941-2.23439-9.80903l8.38096-36.64087c.77838-3.44417 3.09098-6.34189 6.27651-7.86493l33.8735-16.29513c3.17684-1.53773 6.88419-1.53773 10.06103.0l33.85902 16.32575c3.18408 1.52676 5.49399 4.42366 6.26968 7.86969l8.34785 36.64936c.79204 3.43961-.0331 7.0553-2.24431 9.80881l-23.451 29.37577c-2.19404 2.76323-5.53102 4.37048-9.05837 4.36117z" id="path1253-6-4"/><g transform="matrix(0.48872138,0,0,0.48872138,1906.5441,113.88789)" id="Group_365-8-1-7" data-name="Group 365" style="fill:#fff"><path sodipodi:nodetypes="cccccc" id="Path_1612-1-5-6" d="m-2036.06 314.053h-.06c-7.1763-.008-12.9917-5.82372-13-13-.018-7.19712 5.8029-13.04555 13-13.061 7.1967-.0177 13.0446 5.80326 13.06 13 .018 7.19712-5.8029 13.04555-13 13.061z" class="cls-1" data-name="Path 1612" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccccc" id="Path_1613-2-5-5" d="m-1963.88 314.053h-.06c-7.1763-.008-12.9917-5.82372-13-13-.018-7.19712 5.8029-13.04555 13-13.061 7.197-.0183 13.0451 5.80303 13.06 13 .018 7.19712-5.8029 13.04555-13 13.061zm0-24.061c-6.0926-.0188 6.0933.0138.0.0z" class="cls-1" data-name="Path 1613" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1614-9-4-69" d="m-2036.06 350.143h-.06c-7.1763-.008-12.9917-5.82372-13-13-.018-7.19696 5.803-13.04511 13-13.06 7.1967-.0177 13.0446 5.80326 13.06 13 .018 7.19673-5.8033 13.04455-13 13.06z" class="cls-1" data-name="Path 1614" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1615-3-7-3" d="m-1963.88 350.143h-.06c-7.1763-.008-12.9917-5.82372-13-13-.018-7.19673 5.8033-13.04455 13-13.06 7.197-.0183 13.0451 5.80303 13.06 13 .018 7.19696-5.803 13.04511-13 13.06z" class="cls-1" data-name="Path 1615" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1616-9-6-7" d="m-2036.06 386.233h-.06c-7.1763-.008-12.9917-5.82372-13-13-.018-7.19696 5.803-13.04511 13-13.06 7.1967-.0177 13.0446 5.80326 13.06 13 .018 7.19673-5.8033 13.04455-13 13.06z" class="cls-1" data-name="Path 1616" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1617-0-5-4" d="m-1999.97 314.053h-.06c-7.1765-.008-12.9923-5.8235-13-13-.018-7.19712 5.8029-13.04555 13-13.061 7.197-.0183 13.0451 5.80303 13.06 13 .018 7.19712-5.8029 13.04555-13 13.061z" class="cls-1" data-name="Path 1617" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1618-8-6-5" d="m-1999.97 350.143h-.06c-7.1765-.008-12.9923-5.8235-13-13-.018-7.19696 5.803-13.04511 13-13.06 7.197-.0183 13.0451 5.80303 13.06 13 .018 7.19696-5.803 13.04511-13 13.06z" class="cls-1" data-name="Path 1618" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1619-8-9-2" d="m-1999.97 386.233h-.06c-7.1765-.008-12.9923-5.8235-13-13-.018-7.19696 5.803-13.04511 13-13.06 7.197-.0183 13.0451 5.80303 13.06 13 .018 7.19696-5.803 13.04511-13 13.06z" class="cls-1" data-name="Path 1619" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1620-5-3-5" d="m-1999.97 422.323h-.06c-7.1765-.008-12.9923-5.8235-13-13-.018-7.19696 5.803-13.04511 13-13.06 7.197-.0182 13.0451 5.80303 13.06 13 .018 7.19696-5.803 13.04511-13 13.06z" class="cls-1" data-name="Path 1620" inkscape:connector-curvature="0" style="fill:#fff"/><path sodipodi:nodetypes="cccccc" id="Path_1621-0-7-4" d="m-1963.88 386.233h-.06c-7.1763-.008-12.9917-5.82372-13-13-.018-7.19673 5.8033-13.04455 13-13.06 7.197-.0183 13.0451 5.80303 13.06 13 .018 7.19696-5.803 13.04511-13 13.06z" class="cls-1" data-name="Path 1621" inkscape:connector-curvature="0" style="fill:#fff"/></g></g></g></g></svg></span><span class="navbar-brand__name">Bank-Vaults</span>
<span class="font-weight-bold navbar-logo navbar-version">1.19.0</span></a>
<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link" href="https://github.com/banzaicloud/bank-vaults" target="_blank"><span>Project page</span></a>
</li><li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link" href="/docs/"><span>Documentation</span></a>
</li></ul></div><div class="navbar-nav d-none d-lg-block">
<div class="td-search td-search--offline">
<div class="td-search__icon"></div><input type="search" class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete="off" data-offline-search-index-json-src="/offline-search-index.38c7a8b02048636206bb76469273850a.json" data-offline-search-base-href="/" data-offline-search-max-results="10">
</div></div></nav></header><div class="container-fluid td-outer">
<div class="td-main">
<div class="row flex-xl-nowrap">
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="return print(),!1">Click here to print</a>.
</p><p>
<a href="/docs/operator/">Return to the regular view of this page</a>.
</p></div><h1 class="title">Operator</h1><ul>
<li>1: <a href="#pg-c02fa8fe03d0456a434494ea53489be6">Running Vault with external end to end encryption</a></li><li>2: <a href="#pg-949e2eebfdc98439688db69b29ace521">Using templates for injecting dynamic configuration</a></li><li>3: <a href="#pg-2886c2109e2b4def2a9fca4884615cf6">Upgrade Vault with the Bank-Vaults operator</a></li><li>4: <a href="#pg-0bf9c9ceafec846263a56eeaff007d5f">Operator Configuration for Functioning Webhook Secrets Mutation</a></li></ul><div class="content">
<p>The Vault operator builds on Bank-Vaults features such as:</p><ul>
<li>external, API based configuration (secret engines, auth methods, policies) to automatically re/configure a Vault cluster</li><li>automatic unsealing (AWS, GCE, Azure, Alibaba, Kubernetes Secrets (for dev purposes), Oracle)</li><li>TLS support</li></ul><p>The operator flow is the following:</p><p><img src="vaultoperator.png" alt="operator"></p><p>The source code can be found in the <a href="https://github.com/bank-vaults/vault-operator/tree/main/deploy/charts/vault-operator">vault-operator</a> repository.</p><p>The operator requires the following <a href="/docs/cloud-permissions/">cloud permissions</a>.</p><h2 id="deploy-operator">Deploy a local Vault operator</h2><p>This is the simplest scenario: you install the Vault operator on a simple cluster. The following commands install a single-node Vault instance that stores unseal and root tokens in Kubernetes secrets.</p><ol>
<li>
<p>Install the Bank-Vaults operator:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm repo add banzaicloud-stable https://kubernetes-charts.banzaicloud.com
</span></span><span style="display:flex"><span>helm upgrade --install vault-operator banzaicloud-stable/vault-operator
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>Release <span style="color:#4e9a06">&#34;vault-operator&#34;</span> does not exist. Installing it now.
</span></span><span style="display:flex"><span>NAME: vault-operator
</span></span><span style="display:flex"><span>LAST DEPLOYED: Fri Jul <span style="color:#0000cf;font-weight:700">14</span> 14:41:18 <span style="color:#0000cf;font-weight:700">2023</span>
</span></span><span style="display:flex"><span>NAMESPACE: default
</span></span><span style="display:flex"><span>STATUS: deployed
</span></span><span style="display:flex"><span>REVISION: <span style="color:#0000cf;font-weight:700">1</span>
</span></span><span style="display:flex"><span>TEST SUITE: None
</span></span></code></pre></div></li><li>
<p>Create a Vault instance using the Vault custom resources. This will create a Kubernetes <code>CustomResource</code> called <code>vault</code> and a PersistentVolumeClaim for it:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/bank-vaults/vault-operator/main/test/rbac.yaml
</span></span><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/bank-vaults/vault-operator/main/deploy/examples/cr-raft.yaml
</span></span></code></pre></div></li><li>
<p>Wait a few seconds, then check the operator and the vault pods:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get pods
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>NAME                                                        READY     STATUS    RESTARTS   AGE
</span></span><span style="display:flex"><span>vault-0                                                     3/3       Running   <span style="color:#0000cf;font-weight:700">0</span>          10s
</span></span><span style="display:flex"><span>vault-configurer-6c545cb6b4-dmvb5                           1/1       Running   <span style="color:#0000cf;font-weight:700">0</span>          10s
</span></span><span style="display:flex"><span>vault-operator-788559bdc5-kgqkg                             1/1       Running   <span style="color:#0000cf;font-weight:700">0</span>          23s
</span></span></code></pre></div></li><li>
<p>Configure your Vault client to access the Vault instance running in the <em>vault-0</em> pod.</p><ol>
<li>
<p>Port-forward into the pod:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl port-forward vault-0 <span style="color:#0000cf;font-weight:700">8200</span> <span style="color:#000;font-weight:700">&amp;</span>
</span></span></code></pre></div></li><li>
<p>Set the address of the Vault instance.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#204a87">export</span> <span style="color:#000">VAULT_ADDR</span><span style="color:#ce5c00;font-weight:700">=</span>https://127.0.0.1:8200
</span></span></code></pre></div></li><li>
<p>Import the CA certificate of the Vault instance by running the following commands (otherwise, you&rsquo;ll get <em>x509: certificate signed by unknown authority</em> errors):</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl get secret vault-tls -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#4e9a06">&#34;{.data.ca\.crt}&#34;</span> <span style="color:#000;font-weight:700">|</span> base64 --decode &gt; <span style="color:#000">$PWD</span>/vault-ca.crt
</span></span><span style="display:flex"><span><span style="color:#204a87">export</span> <span style="color:#000">VAULT_CACERT</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#000">$PWD</span>/vault-ca.crt
</span></span></code></pre></div><p>Alternatively, you can instruct the Vault client to skip verifying the certificate of Vault by running: <code>export VAULT_SKIP_VERIFY=true</code></p></li><li>
<p>If you already have the <a href="https://developer.hashicorp.com/vault/downloads">Vault CLI installed</a>, check that you can access the Vault:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>vault status
</span></span></code></pre></div><p>Expected output:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>Key             Value
</span></span><span style="display:flex"><span>---             -----
</span></span><span style="display:flex"><span>Seal Type       shamir
</span></span><span style="display:flex"><span>Initialized     <span style="color:#204a87">true</span>
</span></span><span style="display:flex"><span>Sealed          <span style="color:#204a87">false</span>
</span></span><span style="display:flex"><span>Total Shares    <span style="color:#0000cf;font-weight:700">5</span>
</span></span><span style="display:flex"><span>Threshold       <span style="color:#0000cf;font-weight:700">3</span>
</span></span><span style="display:flex"><span>Version         1.5.4
</span></span><span style="display:flex"><span>Cluster Name    vault-cluster-27ecd0e6
</span></span><span style="display:flex"><span>Cluster ID      ed5492f3-7ef3-c600-aef3-bd77897fd1e7
</span></span><span style="display:flex"><span>HA Enabled      <span style="color:#204a87">false</span>
</span></span></code></pre></div></li><li>
<p>To authenticate to Vault, you can access its root token by running:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span><span style="color:#204a87">export</span> <span style="color:#000">VAULT_TOKEN</span><span style="color:#ce5c00;font-weight:700">=</span><span style="color:#204a87;font-weight:700">$(</span>kubectl get secrets vault-unseal-keys -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:700">={</span>.data.vault-root<span style="color:#ce5c00;font-weight:700">}</span> <span style="color:#000;font-weight:700">|</span> base64 --decode<span style="color:#204a87;font-weight:700">)</span>
</span></span></code></pre></div><blockquote>
<p>Note: Using the root token is recommended only in test environments. In production environment, create dedicated, time-limited tokens.</p></blockquote></li><li>
<p>Now you can interact with Vault. For example, add a secret by running <code>vault kv put secret/demosecret/aws AWS_SECRET_ACCESS_KEY=s3cr3t</code>
If you want to access the Vault web interface, open <em>https://127.0.0.1:8200</em> in your browser using the root token (to reveal the token, run <code>echo $VAULT_TOKEN</code>).</p></li></ol></li></ol><p>For other configuration examples of the Vault CustomResource, see the YAML files in the <a href="https://github.com/bank-vaults/vault-operator/tree/main/deploy/">operator/deploy directory of the vault-operator repository</a> (we use these for testing). After you are done experimenting with Bank-Vaults and you want to delete the operator, you can delete the related CRs:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl delete -f https://raw.githubusercontent.com/bank-vaults/vault-operator/main/test/rbac.yaml
</span></span><span style="display:flex"><span>kubectl delete -f https://raw.githubusercontent.com/bank-vaults/vault-operator/main/deploy/examples/cr-raft.yaml
</span></span></code></pre></div><h2 id="ha-setup-with-raft">HA setup with Raft</h2><p>In a production environment you want to run Vault as a cluster. The following CR creates a 3-node Vault instance that uses the Raft storage backend:</p><ol>
<li>
<p>Install the Bank-Vaults operator:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm repo add banzaicloud-stable https://kubernetes-charts.banzaicloud.com
</span></span><span style="display:flex"><span>helm upgrade --install vault-operator banzaicloud-stable/vault-operator
</span></span></code></pre></div></li><li>
<p>Create a Vault instance using the <code>cr-raft.yaml</code> custom resource. This will create a Kubernetes <code>CustomResource</code> called <code>vault</code> that uses the Raft backend:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/bank-vaults/vault-operator/main/test/rbac.yaml
</span></span><span style="display:flex"><span>kubectl apply -f https://raw.githubusercontent.com/bank-vaults/vault-operator/main/deploy/examples/cr-raft.yaml
</span></span></code></pre></div></li></ol><div class="warning-block">
<p><strong>CAUTION:</strong></p>Backing up the storage backend to prevent data loss, is not handled by the Vault operator. We recommend using <a href="/docs/backup/">Velero</a> for backups.
</div><h2 id="pod-anti-affinity">Pod anti-affinity</h2><p>If you want to setup pod anti-affinity, you can set <code>podAntiAffinity</code> vault with a topologyKey value.
For example, you can use <code>failure-domain.beta.kubernetes.io/zone</code> to force K8S deploy vault on multi AZ.</p><h2 id="delete-a-resource-created-by-the-operator">Delete a resource created by the operator</h2><p>If you manually delete a resource that the Bank-Vaults operator has created (for example, the Ingress resource), the operator automatically recreates it every 30 seconds. If it doesn&rsquo;t, then something went wrong, or the operator is not running. In this case, check the logs of the operator.</p></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-c02fa8fe03d0456a434494ea53489be6">1 - Running Vault with external end to end encryption</h1><p>This document assumes you have a working Kubernetes cluster which has a:</p><ul>
<li>Working install of Vault.</li><li>That you have a working knowledge of Kubernetes.</li><li>A working install of helm</li><li>A working knowledge of Kubernetes ingress</li><li>A valid external (<a href="https://www.example.com">www.example.com</a>) SSL certificate, verified by your provider as a Kubernetes secret.</li></ul><h2 id="background">Background</h2><p>The bank-vaults operator takes care of creating and maintaining internal cluster communications but if you wish to use your vault install
outside of your Kubernetes cluster what is the best way to maintain a secure state. Creating a standard Ingress object will reverse proxy
these requests to your vault instance but this is a hand off between the external SSL connection and the internal one. This might not be acceptable
under some circumstances, for example, if you have to adhere to strict security standards.</p><h2 id="workflow">Workflow</h2><p>Here we will create a separate TCP listener for vault using a custom SSL certificate on an external domain of your choosing. We will then
install a unique ingress-nginx controller allowing SSL pass through. SSL Pass through comes with a performance hit, so you would not use this
on a production website or ingress-controller that has a lot of traffic.</p><h2 id="install">Install</h2><h3 id="ingress-nginx">ingress-nginx</h3><p>values.yaml</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">controller</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">electionID</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault-ingress-controller-leader</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">ingressClass</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx-vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">extraArgs</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">enable-ssl-passthrough</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">publishService</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">enabled</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">scope</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">enabled</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">replicaCount</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">affinity</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">podAntiAffinity</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">labelSelector</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">matchExpressions</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">key</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">release</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">operator</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">In</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">values</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:700">[</span><span style="color:#4e9a06">&#34;vault-ingress&#34;</span><span style="color:#000;font-weight:700">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">topologyKey</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes.io/hostname</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="install-nginx-ingress-via-helm">Install nginx-ingress via helm</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>helm install nginx-stable/nginx-ingress --name my-release -f values.yaml
</span></span></code></pre></div><h2 id="configuration">Configuration</h2><h3 id="ssl-secret-example">SSL Secret example:</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">data</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">tls.crt</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LS0tLS1......=</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">tls.key</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LS0tLS.......==</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">labels</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">ssl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">tls</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wildcard.example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Opaque</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="cr-vault-config">CR Vault Config:</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">apiVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault.banzaicloud.com/v1alpha1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">kind</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">metadata</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">namespace</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">size</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">image</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hashicorp/vault:1.14.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">bankVaultsImage</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ghcr.io/bank-vaults/bank-vaults:latest</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># A YAML representation of a final vault config file.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># See https://www.vaultproject.io/docs/configuration/ for more information.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">listener</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">tcp</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">address</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;0.0.0.0:8200&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">tls_cert_file</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/vault/tls/server.crt</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">tls_key_file</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/vault/tls/server.key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">tcp</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">address</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;0.0.0.0:8300&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">tls_cert_file</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/ingress-tls/tls.crt</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">tls_key_file</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/ingress-tls/tls.key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">api_addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://vault:8200</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">cluster_addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://vault:8201</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">ui</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="cr-service">CR Service:</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Specify the Service&#39;s type where the Vault Service is exposed</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">serviceType</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterIP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">servicePorts</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">api-port</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">8200</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">cluster-port</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">8201</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">ext-api-port</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">8300</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">ext-clu-port</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">8301</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="mount-the-secret-into-your-vault-pod">Mount the secret into your vault pod</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">volumes</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wildcard-ssl</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">secret</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">defaultMode</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">420</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">secretName</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wildcard.example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">volumeMounts</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">wildcard-ssl</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">mountPath</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/ingress-tls</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="cr-ingress">CR Ingress:</h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Request an Ingress controller with the default configuration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">ingress</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">annotations</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">kubernetes.io/ingress.allow-http</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;false&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">kubernetes.io/ingress.class</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;nginx-vault&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">nginx.ingress.kubernetes.io/force-ssl-redirect</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">nginx.ingress.kubernetes.io/ssl-passthrough</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">nginx.ingress.kubernetes.io/backend-protocol</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;HTTPS&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">nginx.ingress.kubernetes.io/whitelist-source-range</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">spec</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">rules</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:700">host</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault.example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:700">http</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">paths</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#204a87;font-weight:700">path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:700">backend</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87;font-weight:700">serviceName</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87;font-weight:700">servicePort</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">8300</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-949e2eebfdc98439688db69b29ace521">2 - Using templates for injecting dynamic configuration</h1><h2 id="background">Background</h2><p>When configuring a <code>Vault</code> object via the <code>externalConfig</code> property, sometimes it&rsquo;s convenient (or necessary) to inject settings that are only known at runtime, for example:</p><ul>
<li>secrets that you don&rsquo;t want to store in source control</li><li>dynamic resources managed elsewhere</li><li>computations based on multiple values (string or arithmetic operations).</li></ul><p>For these cases, the operator supports parameterized templating. The <code>vault-configurer</code> component evaluates the templates and injects the rendered configuration into Vault.</p><p>This templating is based on <a href="https://golang.org/pkg/text/template/">Go templates</a>, extended by <a href="https://github.com/Masterminds/sprig">Sprig</a>, with some custom functions available specifically for bank-vaults (for example, to decrypt strings using the AWS Key Management Service or the Cloud Key Management Service of the Google Cloud Platform).</p><h2 id="using-templates">Using templates</h2><p>To avoid confusion and potential parsing errors (and interference with other templating tools like <a href="https://helm.sh/docs/chart_best_practices/templates/">Helm</a>), the templates don&rsquo;t use the default delimiters that Go templates use (<code>{{</code> and <code>}}</code>). Instead, use the following characters:</p><ul>
<li><strong>${</strong> for the left delimiter</li><li><strong>}</strong> for the right one.</li><li>To quote parameters being passed to functions, surround them with backticks (<strong>`</strong>) instead.</li></ul><p>For example, to call the <code>env</code> function, you can use this in your manifest:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">password</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${ env `MY_ENVIRONMENT_VARIABLE` }&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>In this case, <code>vault-configurer</code> evaluates the value of <code>MY_ENVIRONMENT_VARIABLE</code> at runtime (assuming it was properly injected), and sets the result as the value of the <code>password</code> field.</p><p>Note that you can also use <a href="#sprig-functions">Sprig functions</a> and <a href="#custom-functions">custom Kubernetes-related functions</a> in your templates.</p><p>For a detailed example, see the <a href="https://techblog.cisco.com/bank-vaults-templates#full-example">Using templates for injecting dynamic configuration in Vault</a> blog post.</p><h2 id="sprig-functions">Sprig functions</h2><p>In addition to the default functions in Go templates, you can also use <a href="http://masterminds.github.io/sprig/">Sprig functions</a> in your configuration.</p><div class="warning-block">
<p><strong>CAUTION:</strong></p>Use only functions that return a string, otherwise the generated configuration is invalid.
</div><h2 id="custom-functions">Custom functions</h2><p>To provide functionality that&rsquo;s more Kubernetes-friendly and cloud-native, bank-vaults provides a few additional functions not available in Sprig or Go. The functions and their parameters (in the order they should go in the function) are documented below.</p><h3 id="awskms"><code>awskms</code></h3><p>Takes a base64-encoded, KMS-encrypted string and returns the decrypted string. Additionally, the function takes an optional second parameter for any encryption context that might be required for decrypting. If any encryption context is required, the function will take any number of additional parameters, each of which should be a key-value pair (separated by a <code>=</code> character), corresponding to the full context.</p><blockquote>
<p>Note: This function assumes that the <code>vault-configurer</code> pod has the appropriate AWS IAM credentials and permissions to decrypt the given string. You can inject the AWS IAM credentials by using Kubernetes secrets as environment variables, an EC2 instance role, <a href="https://github.com/jtblin/kube2iam">kube2iam</a>, or <a href="/docs/cloud-permissions/#aws">EKS IAM roles</a>, and so on.</p></blockquote><table>
<thead>
<tr>
<th>Parameter</th><th>Type</th><th>Required</th></tr></thead><tbody>
<tr>
<td>encodedString</td><td>Base64-encoded string</td><td>Yes</td></tr><tr>
<td>encryptionContext</td><td>Variadic list of strings</td><td>No</td></tr></tbody></table><p>For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">password</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${ awskms (env `ENCRYPTED_DB_CREDS`) }&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>You can also nest functions in the template, for example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">password</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${ awskms (blob `s3://bank-vaults/encrypted/db-creds?region=eu-west-1`) }&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="gcpkms"><code>gcpkms</code></h3><p>Takes a base64-encoded string, encrypted with a Google Cloud Platform (GCP) symmetric key and returns the decrypted string.</p><blockquote>
<p>Note: This function assumes that the <code>vault-configurer</code> pod has the appropriate GCP IAM credentials and permissions to decrypt the given string. You can inject the GCP IAM credentials by using Kubernetes secrets as environment variables, or they can be acquired via a service account authentication, and so on.</p></blockquote><table>
<thead>
<tr>
<th>Parameter</th><th>Type</th><th>Required</th></tr></thead><tbody>
<tr>
<td>encodedString</td><td>Base64-encoded string</td><td>Yes</td></tr><tr>
<td>projectId</td><td>String</td><td>Yes</td></tr><tr>
<td>location</td><td>String</td><td>Yes</td></tr><tr>
<td>keyRing</td><td>String</td><td>Yes</td></tr><tr>
<td>key</td><td>String</td><td>Yes</td></tr></tbody></table><h3 id="blob"><code>blob</code></h3><p>Reads the content of a blob from disk (file) or from cloud blob storage services (object storage) at the given URL and returns it. This assumes that the path exists, and is readable by <code>vault-configurer</code>.</p><p>Valid values for the URL parameters are listed below, for more fine grained options check the documentation of the <a href="https://gocloud.dev/howto/blob/">underlying library</a>:</p><ul>
<li><code>file:///path/to/dir/file</code></li><li><code>s3://my-bucket/object?region=us-west-1</code></li><li><code>gs://my-bucket/object</code></li><li><code>azblob://my-container/blob</code></li></ul><blockquote>
<p>Note: This function assumes that the <code>vault-configurer</code> pod has the appropriate rights to access the given cloud service. For details, see the <a href="#awskms">awskms</a> and <a href="#gcpkms">gcpkms</a> functions.</p></blockquote><table>
<thead>
<tr>
<th>Parameter</th><th>Type</th><th>Required</th></tr></thead><tbody>
<tr>
<td>url</td><td>String</td><td>Yes</td></tr></tbody></table><p>For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">password</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${ blob `s3://bank-vaults/encrypted/db-creds?region=eu-west-1` }&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>You can also nest functions in the template, for example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">password</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;${ awskms (blob `s3://bank-vaults/encrypted/db-creds?region=eu-west-1`) }&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="file"><code>file</code></h3><p>Reads the content of a file from disk at the given path and returns it. This assumes that the file exists, it&rsquo;s mounted, and readable by <code>vault-configurer</code>.</p><table>
<thead>
<tr>
<th>Parameter</th><th>Type</th><th>Required</th></tr></thead><tbody>
<tr>
<td>path</td><td>String</td><td>Yes</td></tr></tbody></table><h3 id="accessor"><code>accessor</code></h3><p>Looks up the accessor id of the given auth path and returns it. This function is only useful in policies that use <a href="https://www.vaultproject.io/docs/concepts/policies#templated-policies">templated policies</a>, to generalize the <code>&lt;mount accessor></code> field.</p><table>
<thead>
<tr>
<th>Parameter</th><th>Type</th><th>Required</th></tr></thead><tbody>
<tr>
<td>path</td><td>String</td><td>Yes</td></tr></tbody></table><p>For example:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">rules</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path &#34;secret/data/{{identity.entity.aliases.${ accessor `kubernetes/` }.metadata.service_account_namespace}}/*&#34; {</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">capabilities = [&#34;read&#34;]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">           </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-2886c2109e2b4def2a9fca4884615cf6">3 - Upgrade Vault with the Bank-Vaults operator</h1><p>To upgrade Vault using the Bank-Vaults operator, complete the following steps.</p><ol>
<li>Check the release notes of Vault for any special upgrade instructions. Usually there are no instructions, but it&rsquo;s better to be safe than sorry.</li><li><a href="https://github.com/bank-vaults/vault-operator/blob/main/deploy/examples/cr.yaml#L7">Adjust the spec.image in field in the Vault custom resource</a>.</li><li>The Bank-Vaults operator updates the statefulset. (It does not take the HA leader into account in HA scenarios, but this has never caused any issues so far.)</li></ol></div><div class="td-content" style="page-break-before:always">
<h1 id="pg-0bf9c9ceafec846263a56eeaff007d5f">4 - Operator Configuration for Functioning Webhook Secrets Mutation</h1><p>You can find several examples of the vault operator CR manifest in
<a href="https://github.com/bank-vaults/vault-operator/tree/main/deploy/examples">the vault-operator repository</a>. The following examples use only this <a href="https://github.com/bank-vaults/vault-operator/blob/main/deploy/examples/cr.yaml">vanilla CR</a>
to demonstrate some main points about how to properly configure the
operator for secrets mutations to function.</p><p>This document does not attempt to explain every possible scenario with respect to
the CRs in the aforementioned directory, but instead attempts to explain at
a high level the important aspects of the CR, so that you can determine how best to configure your operator.</p><h2 id="main-points">Main points</h2><p>Some important aspects of the operator and its configuration with respect to secrets
mutation are:</p><ul>
<li>The vault operator instantiates:
<ul>
<li>the vault configurer pod(s),</li><li>the vault pod(s),</li><li>the vault-secrets-webhook pod(s).</li></ul></li><li>The vault configurer:
<ul>
<li>unseals the vault,</li><li>configures vault with policies, roles, and so on.</li></ul></li><li>vault-secrets-webhook does nothing more than:
<ul>
<li>monitors cluster for resources with specific annotations for secrets injection, and</li><li>integrates with vault API to answer secrets requests from those resources for
requested secrets.</li><li>For pods using environment secrets, it injects a binary <code>vault-env</code> into pods
and updates ENTRYPOINT to run <code>vault-env CMD</code> instead of <code>CMD</code>.
<code>vault-env</code> intercepts requests for env secrets requests during runtime of
pod and upon such requests makes vault API call for requested secret
injecting secret into environment variable so <code>CMD</code> works with proper
secrets.</li></ul></li><li>Vault
<ul>
<li>the secrets workhorse</li><li>surfaces a RESTful API for secrets management</li></ul></li></ul><h2 id="cr-configuration-properties">CR configuration properties</h2><p>This section goes over some important properties of the CR and their purpose.</p><h3 id="vaults-service-account">Vault&rsquo;s service account</h3><p>This is the serviceaccount where Vault will be running. The Configurer runs
in the same namespace and should have the same service account. The operator
assigns this serviceaccount to Vault.</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Specify the ServiceAccount where the Vault Pod and the Bank-Vaults configurer/unsealer is running</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">serviceAccount</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="canamespaces">caNamespaces</h3><p>In order for vault communication to be encrypted, valid TLS certificates need to
be used. The following property automatically creates TLS certificate secrets for
the namespaces specified here. Notice that this is a list, so you can
specify multiple namespaces per line, or use the splat or wildcard asterisk to
specify all namespaces:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Support for distributing the generated CA certificate Secret to other namespaces.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Define a list of namespaces or use [&#34;*&#34;] for all namespaces.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">caNamespaces</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="vault-config">Vault Config</h2><p>The following is simply a YAML representation (as the comment says) for the
Vault configuration you want to run. This is the configuration that vault
configurer uses to configure your running Vault:</p><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># A YAML representation of a final vault config file.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">config</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">api_addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://vault:8200</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">cluster_addr</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://${.Env.POD_NAME}:8201</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">listener</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">tcp</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">address</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">0.0.0.0</span><span style="color:#000;font-weight:700">:</span><span style="color:#0000cf;font-weight:700">8200</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># Commenting the following line and deleting tls_cert_file and tls_key_file disables TLS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">tls_cert_file</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/vault/tls/server.crt</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">tls_key_file</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/vault/tls/server.key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">storage</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:700">file</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;${ .Env.VAULT_STORAGE_FILE }&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">ui</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:700">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">credentialsConfig</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">env</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">path</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">secretName</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">etcdSize</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:700">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">etcdVersion</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:700">externalConfig</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">rules</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">path &#34;secret/*&#34; {</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">capabilities = [&#34;create&#34;, &#34;read&#34;, &#34;update&#34;, &#34;delete&#34;, &#34;list&#34;]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:700">auth</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:700">type</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:700">roles</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># Allow every pod in the default namespace to use the secret kv store</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">bound_service_account_names</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">external-secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">dex</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">bound_service_account_namespaces</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">external-secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">dex</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">auth-system</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">loki</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">ttl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1h</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># Allow mutation of secrets using secrets-mutation annotation to use the secret kv store</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:700">name</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">secretsmutation</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">bound_service_account_names</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">vault-secrets-webhook</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">bound_service_account_namespaces</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">vault-secrets-webhook</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">policies</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">              </span>- <span style="color:#000">allow_secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:700">ttl</span><span style="color:#000;font-weight:700">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1h</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="externalconfig">externalConfig</h3><p>The <code>externalConfig</code> portion of <strong>this CR example</strong> correlates to <a href="https://www.vaultproject.io/api/auth/kubernetes#configure-method">Kubernetes
configuration</a> as specified by <code>.auth[].type</code>.</p><p>This YAML representation of configuration is flexible enough to work with any
auth methods available to Vault as documented <a href="https://www.vaultproject.io/api/auth/kubernetes#configure-method">in the Vault documentation</a>.
For now, we&rsquo;ll stick with this kubernetes configuration.</p><h3 id="externalconfigpurgeunmanagedconfig">externalConfig.purgeUnmanagedConfig</h3><p>Delete any configuration that in Vault but not in <code>externalConfig</code>. For more details please check
<a href="/docs/external-configuration/purge-unmanaged-configuration/">Purge unmanaged configuration</a></p><h3 id="externalconfigpolicies">externalConfig.policies</h3><p>Correlates 1:1 to the creation of the specified policy in conjunction with <a href="https://www.vaultproject.io/api-docs/system/policy">Vault
policies</a>.</p><h3 id="externalconfigauthtype">externalConfig.auth[].type</h3><p><code>- type: kubernetes</code> - specifies to configure Vault to use <a href="https://www.vaultproject.io/api/auth/kubernetes#configure-method">Kubernetes
authentication</a></p><p><a href="https://www.vaultproject.io/api/auth">Other types</a> are yet to be documented with respect to the operator
configuration.</p><h3 id="externalconfigauthroles">externalConfig.auth[].roles[]</h3><p>Correlates to <a href="https://www.vaultproject.io/api/auth/kubernetes#create-role">Creating Kubernetes roles</a>. Some important nuances here are:</p><ul>
<li>Vault does not respect inline secrets serviceaccount annotations, so the
namespace of any serviceaccount annotations for secrets are irrelevant to
getting inline secrets mutations functioning.</li><li>Instead, the serviceaccount of the vault-secrets-webhook pod(s) should be
used to configure the <code>bound_service_account_names</code> and
<code>bound_service_account_namespaces</code> for inline secrets to mutate.</li><li>Pod serviceaccounts, however, are respected so
<code>bound_service_account_namespaces</code> and <code>bound_service_account_names</code> for
environment mutations must identify such of the running pods.</li></ul><blockquote>
<p>Note: There are two roles specified in the YAML example above: one for pods, and one for inline secrets mutations. While this was not strictly required, it makes for cleaner implementation.</p></blockquote></div></main></div></div><footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class="row">
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
<a class="text-white" target="_blank" rel="noopener" href="https://github.com/banzaicloud/bank-vaults" aria-label="GitHub">
<i class="fab fa-github"></i>
</a>
</li><li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
<a class="text-white" target="_blank" rel="noopener" href="https://eti.cisco.com/slack" aria-label="Slack">
<i class="fab fa-slack"></i>
</a>
</li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class="text-white">&copy; 2023 Bank-Vaults maintainers All Rights Reserved</small>
</div></div></div></footer></div><script src="/js/main.min.2aff983e9d0d8ecff9ed53e14b657216e2d8d2aff059bf4a5651283020995f1b.js" integrity="sha256-Kv+YPp0Njs/57VPhS2VyFuLY0q/wWb9KVlEoMCCZXxs=" crossorigin="anonymous"></script>
<script src='/js/prism.js'></script>
<script src='/js/tabpane-persist.js'></script>
<script src="/js/tocbot.min.js"></script>
<script type="text/javascript">tocbot.init({tocSelector:".td-toc",contentSelector:".td-content",headingSelector:"h2, h3, h4",ignoreHiddenElements:!0})</script>
</body></html>